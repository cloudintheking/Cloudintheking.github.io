{"meta":{"title":"cloudintheking","subtitle":"æ—¶å…‰é†‰æ¸…é£,æ€»æœ‰äººä¼šè®°å¾—","description":"åŒ—è½å¸ˆé—¨","author":"cloudintheking","url":"https://cloudintheking.github.io","root":"/"},"pages":[{"title":"paint","date":"2018-09-07T15:16:52.000Z","updated":"2021-04-25T15:44:16.049Z","comments":false,"path":"paint/index.html","permalink":"https://cloudintheking.github.io/paint/index.html","excerpt":"","text":"å¾å‹çŒªçŒªğŸ·ä¸å¾ğŸµçš„ç”»é›†ğŸ¨"},{"title":"categories","date":"2018-07-28T14:16:29.000Z","updated":"2021-04-25T15:44:16.049Z","comments":false,"path":"categories/index.html","permalink":"https://cloudintheking.github.io/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2018-07-28T14:12:09.000Z","updated":"2021-04-25T15:44:16.049Z","comments":false,"path":"tags/index.html","permalink":"https://cloudintheking.github.io/tags/index.html","excerpt":"","text":""},{"title":"works","date":"2018-09-08T02:09:11.000Z","updated":"2021-04-25T15:44:16.049Z","comments":false,"path":"works/index.html","permalink":"https://cloudintheking.github.io/works/index.html","excerpt":"","text":"myportalï¼šåŠ¨æ€é—¨æˆ·å‰ç«¯ myportal_serverï¼šåŠ¨æ€é—¨æˆ·æœåŠ¡ç«¯ myutilsï¼šå¸¸ç”¨å·¥å…·åŒ…å°è£…"}],"posts":[{"title":"springæ—¥è®°","slug":"springæ—¥è®°","date":"2020-06-12T04:39:41.000Z","updated":"2021-04-26T13:07:09.998Z","comments":true,"path":"posts/dab52c7b.html","link":"","permalink":"https://cloudintheking.github.io/posts/dab52c7b.html","excerpt":"","text":"- - ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ spring æ—¥è®°Bean@Scope(ä½œç”¨åŸŸæ³¨è§£)å…³é”®å±æ€§ï¼š scopeNameï¼šä½œç”¨åŸŸåï¼Œâ€prototypeâ€ã€â€singletonâ€ã€â€requestâ€ã€â€sessionâ€ proxyModeï¼šä»£ç†æ¨¡å¼ï¼ŒScopedProxyMode. DEFAULTï¼ˆé»˜è®¤ä¸ºNOï¼‰ã€ScopedProxyMode.NOï¼ˆä¸ä»£ç†ï¼‰ã€ScopedProxyMode.INTERFACESï¼ˆåŸºäºjdkæ¥å£ä»£ç†ï¼‰ã€ScopedProxyMode.TARGET_CLASSï¼ˆåŸºäºcglibä»£ç†ï¼‰ ç”¨æ³•ï¼š123@Component@Scope(scopeName=\"xx\",proxyMode=xxx)public class XXX&#123;&#125; æˆ–è€…12345678@Configurationpublic class XXXConfig&#123; @Bean @Scope(scopeName=\"xx\",proxyMode=xxx) public Xxx getXxx()&#123; return new Xxx(); &#125;&#125; NOTE:è‹¥scopeName=â€prototypeâ€,proxyMode=ScopedProxyMode.NO,é‚£æ¯æ¬¡éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„bean;è‹¥scopeName=â€prototypeâ€,proxyMode=ScopedProxyMode.INTERFACESæˆ–TARGET_CLASS, é‚£ä¹ˆä¼šè¢«æ³¨å…¥ä¸€ä¸ªä»£ç†ç±»ï¼ˆå®ƒæ˜¯å•ä¾‹å¹¶éåŸå‹ï¼‰ï¼Œä»£ç†ç±»é‡Œæ ¹æ®scopeNameæ¥è¿”å›å…·ä½“çš„beanã€‚ ç¼“å­˜cacheManagercacheManager(ç¼“å­˜ç®¡ç†å™¨)å¯ä»¥æ³¨å†Œå¤šä¸ªï¼Œä½†æ˜¯idå¿…é¡»ä¸åŒï¼Œå¦å¤–å¿…é¡»æŒ‡å®šå…¶ä¸­ä¸€ä¸ªcacheManagerä¸ŠåŠ ä¸Š@Primaryï¼Œå¦åˆ™CacheAspectSupport(cacheåˆ‡é¢ç±»)ä¸­è·å–cacheManager beanæ—¶è¿”å›å¤šä¸ªä¼šæŠ¥é”™ã€‚ ä¹Ÿå¯ä»¥ä¸æŒ‡å®š@Primaryï¼Œä½†è¦æ³¨å†Œä¸€ä¸ªcacheé…ç½®ç±»ç»§æ‰¿CachingConfigurerSupport,å¹¶è¦†ç›–å…¶ä¸­cacheManager()æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå·²æ³¨å†Œçš„cacheManager @Cacheableä¸­å¯ä»¥æŒ‡å®šcacheManager, æ•…å¯ä»¥å®ç°ä¸åŒçš„ç¼“å­˜æ–¹å¼ EhcacheCacheManageã€JcacheCacheManagerã€RedisCacheManagerä¸‰è€…éƒ½ç»§æ‰¿äº† AbstractTransactionSupportingCacheManagerï¼Œ é€šè¿‡è®¾ç½®setTransactionAware(boolean transactionAware)æ–¹æ³•ï¼Œå¯ä»¥å®ç°äº‹åŠ¡æäº¤åå†è¿›è¡Œç¼“å­˜æ“ä½œï¼ˆæ³¨æ„ï¼Œä¸ç®¡äº‹åŠ¡æœ€åæˆåŠŸä¸å¦ï¼Œç¼“å­˜éƒ½ä¼šæ‰§è¡Œï¼Œæ…ç”¨ï¼ï¼ï¼‰ redisTemplateredisTemplateï¼ˆredisç¼“å­˜æ¨¡æ¿ï¼‰ä¸­ setEnableTransactionSupport(boolean enableTransactionSupport)è®¾ç½®å¼€å¯äº‹åŠ¡æ”¯æŒï¼Œç»“åˆ@Transactionalå¯ä»¥å®ç°ç¼“å­˜å›æ»š otherè‹¥ä¸€ä¸ªæ–¹æ³•ä¸ŠåŒæ—¶å­˜åœ¨@Cacheableå’Œ@Transaction,springé»˜è®¤cacheä»£ç†ä¼˜å…ˆçº§é«˜äºtransaction,æ‰€ä»¥ä¼šå‡ºç°å…ˆè¿›è¡Œcacheæ“ä½œå†è¿›è¡Œtransactionæ“ä½œçš„æƒ…å†µã€‚å¯ä»¥é€šè¿‡è®¾ç½®@EnableCaching(order=xxx)ã€@EnableTransactionManagement(order=xxx)ä¸­orderå€¼æ¥è°ƒèŠ‚ä»£ç†é¡ºåº,orderè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚ äº‹åŠ¡@TransactionalEventListeneräº‹åŠ¡äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸€èˆ¬ç”¨äºäº‹åŠ¡æäº¤æˆåŠŸæ—¶å¤„ç†ä¸€äº›ä¸šåŠ¡é€»è¾‘å…³é”®å±æ€§phase: TransactionPhase.BEFORE_COMMIT äº‹åŠ¡æäº¤å‰è§¦å‘ TransactionPhase.AFTER_COMMIT äº‹åŠ¡æäº¤æˆåŠŸæ—¶è§¦å‘ TransactionPhase.AFTER_ROLLBACK äº‹åŠ¡å›æ»šæ—¶è§¦å‘ TransactionPhase.AFTER_COMPLETION äº‹åŠ¡å®Œæˆ(äº‹åŠ¡æäº¤æˆåŠŸåæˆ–å›æ»šåè§¦å‘)ç”¨æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public class MyAfterTransactionEvent extends ApplicationEvent &#123; //è‡ªå®šä¹‰ä¸€äº›å±æ€§ //... public MyAfterTransactionEvent(Object... source) &#123; super(source); &#125;&#125;@Slf4j@Componentpublic class MyTransactionListener &#123; //æ³¨å…¥ä¸€äº›bean //... @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT) public void onHelloEvent(/** è‡ªå®šä¹‰äº‹ä»¶**/MyAfterTransactionEvent event) &#123; //æäº¤åçš„ä¸šåŠ¡é€»è¾‘ ... &#125; /** * ä½œç”¨åŒä¸Š **/@EventListener void onSaveUserEvent(MyAfterTransactionEvent event) &#123; TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() &#123; @Override public void afterCommit() &#123; //æäº¤åçš„ä¸šåŠ¡é€»è¾‘ //... &#125; &#125;); &#125; &#125;@Service public class HelloServiceImpl&#123; @Autowired private ApplicationEventPublisher publisher; @Transactional void test()&#123; //dbæ“ä½œ //... publisher.publishEvent(new MyAfterTransactionEvent()); &#125; &#125; NOTE: springäº‹ä»¶æœºåˆ¶é»˜è®¤æ˜¯åŒæ­¥çš„ï¼Œä½¿ç”¨ @TransactionalEventListenerä¸è¿‡æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œæœ¬è´¨ä¸Šç›‘å¬æ–¹æ³•çš„æ‰§è¡Œå’Œäº‹åŠ¡æ˜¯åœ¨åŒä¸€çº¿ç¨‹ä¸­ã€‚è€Œä¸Šé¢ä¾‹å­ä¸­æˆ‘ä»¬çš„ç›‘å¬æ–¹æ³•åœ¨äº‹åŠ¡æäº¤æˆåŠŸæ—¶æ‰§è¡Œï¼Œåƒä¸‡ä¸è¦åœ¨ç›‘å¬æ–¹æ³•è¿›è¡Œinsert/update/deleteæ“ä½œï¼Œå› ä¸ºspringçš„äº‹åŠ¡æ˜¯ç»‘å®šçº¿ç¨‹çš„,äº‹åŠ¡è™½ç„¶æäº¤äº†ï¼Œä½†ä»å’Œå½“å‰çº¿ç¨‹ç»‘å®šï¼Œæ­¤æ—¶è¿›è¡Œå¢åˆ æ”¹æ“ä½œéƒ½æ˜¯æ— æ•ˆçš„ï¼ï¼è¯¦è§è¿™ç¯‡å¤–æ–‡æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿç›®å‰èƒ½æƒ³åˆ°2ç§ 1ï¼šåœ¨ç›‘å¬æ–¹æ³•é‡Œè°ƒç”¨å¼‚æ­¥æ–¹æ³•æ¥é¿å… 2ï¼šåœ¨ç›‘å¬æ–¹æ³•ä¸Šæ·»åŠ @Transactional(propagation = Propagation.REQUIRES_NEW)ï¼Œè¿™æ ·ç›‘å¬æ–¹æ³•ä¼šåˆ›å»ºæ–°çš„äº‹åŠ¡ æœ‰çš„äººå¯èƒ½ä¼šæƒ³åœ¨ç›‘å¬æ–¹æ³•ä¸ŠåŠ @Asyncï¼Œè¿™æ ·ç›‘å¬æ–¹æ³•åœ¨å­çº¿ç¨‹ç§æ‰§è¡Œï¼Œå­çº¿ç¨‹ä¸å’Œä¸»çº¿ç¨‹å…±äº«äº‹åŠ¡ï¼Œä»è€Œè§£å†³ä¸Šè¿°é—®é¢˜ã€‚æˆ‘åªèƒ½è¯´æƒ³æ³•å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿã€‚å‰é¢è¯´äº†springçš„äº‹åŠ¡æ˜¯ç»‘å®šçº¿ç¨‹çš„ï¼Œ @TransactionalEventListeneræ˜¯ç›‘å¬å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ï¼Œè€Œå­çº¿ç¨‹ä¸­ä¸¢å¤±äº†ä¸»çº¿ç¨‹çš„ä»»åŠ¡ï¼Œç»“æœå°±æ˜¯ä½ çš„ç›‘å¬å™¨ä¸èµ·æ•ˆ securityæˆ‘ä»¬çŸ¥é“SecurityContextHolder æŒæœ‰securityçš„contextSecurityContextHolderéƒ¨åˆ†æºç ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142public class SecurityContextHolder &#123; public static final String MODE_THREADLOCAL = \"MODE_THREADLOCAL\"; //çº¿ç¨‹å‰¯æœ¬ç­–ç•¥ public static final String MODE_INHERITABLETHREADLOCAL = \"MODE_INHERITABLETHREADLOCAL\";//å¯ç»§æ‰¿çº¿ç¨‹å‰¯æœ¬ç­–ç•¥ public static final String MODE_GLOBAL = \"MODE_GLOBAL\"; //å…¨å±€ç­–ç•¥ public static final String SYSTEM_PROPERTY = \"spring.security.strategy\"; private static String strategyName = System.getProperty(SYSTEM_PROPERTY); private static SecurityContextHolderStrategy strategy; private static int initializeCount = 0; static &#123; initialize();&#125;private static void initialize() &#123; if (!StringUtils.hasText(strategyName)) &#123; // Set default å¦‚æœç³»ç»Ÿå˜é‡è¯»ä¸åˆ°ï¼Œåˆ™é»˜è®¤ä¸ºçº¿ç¨‹å‰¯æœ¬ç­–ç•¥ strategyName = MODE_THREADLOCAL; &#125; if (strategyName.equals(MODE_THREADLOCAL)) &#123; strategy = new ThreadLocalSecurityContextHolderStrategy(); &#125; else if (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123; strategy = new InheritableThreadLocalSecurityContextHolderStrategy(); &#125; else if (strategyName.equals(MODE_GLOBAL)) &#123; strategy = new GlobalSecurityContextHolderStrategy(); &#125; else &#123; // Try to load a custom strategy å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œé‚£ä¹ˆåŠ è½½è‡ªå®šä¹‰ç­–ç•¥ï¼ŒstrategyNameä¸ºè‡ªå®šä¹‰ç­–ç•¥çš„ç±»è·¯å¾„ï¼Œè‡ªå®šä¹‰ç­–ç•¥éœ€å®ç°SecurityContextHolderStrategyæ¥å£ try &#123; Class&lt;?&gt; clazz = Class.forName(strategyName); Constructor&lt;?&gt; customStrategy = clazz.getConstructor(); strategy = (SecurityContextHolderStrategy) customStrategy.newInstance(); &#125; catch (Exception ex) &#123; ReflectionUtils.handleReflectionException(ex); &#125; &#125; initializeCount++;&#125;... ä»æºç é‡Œå¯ä»¥çœ‹å‡º,SecurityContextHolder é»˜è®¤ä¸ºçº¿ç¨‹å‰¯æœ¬ç­–ç•¥ï¼Œè¿™å°±ä¼šå¯¼è‡´å¼‚æ­¥çº¿ç¨‹ä¸­è·å–ä¸åˆ°securityçš„context,è§£å†³æ–¹æ³•æœ‰4ç§ï¼š 1ï¼šé…ç½®æ–‡ä»¶ä¸­è®¾ç½® spring.security.strategy=MODE_INHERITABLETHREADLOCAL 2ï¼šä½¿ç”¨DelegatingSecurityContextRunnable.create(Runnable delegate, SecurityContext securityContext)è£…é¥°ä»»åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨DelegatingSecurityContextExecutoråˆ›å»ºexcutor(çº¿ç¨‹æ‰§è¡Œå™¨) 3ï¼šå’Œ2çš„æ–¹æ³•å¾ˆåƒ ,excutorä¸­è®¾ç½®ä»»åŠ¡è£…é¥°å™¨ 12345678910111213141516171819202122232425262728/** * security å¼‚æ­¥ä»»åŠ¡è£…é¥°å™¨ */static class ContextCopyingDecorator implements TaskDecorator &#123; @NonNull @Override public Runnable decorate(@NonNull Runnable runnable) &#123; RequestAttributes context = RequestContextHolder.currentRequestAttributes(); SecurityContext securityContext = SecurityContextHolder.getContext(); return () -&gt; &#123; try &#123; RequestContextHolder.setRequestAttributes(context); SecurityContextHolder.setContext(securityContext); runnable.run(); &#125; finally &#123; SecurityContextHolder.clearContext(); RequestContextHolder.resetRequestAttributes(); &#125; &#125;; &#125;&#125;@Beanpublic Executor createExecutor()&#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setTaskDecorator(new ContextCopyingDecorator()); ...&#125; 4ï¼šä½¿ç”¨springæä¾›çš„MethodInvokingFactoryBeanä¿®æ”¹SecurityContextHolderç­–ç•¥ 12345678 @Bean public MethodInvokingFactoryBean setSecurityStrategy() &#123; MethodInvokingFactoryBean factoryBean = new MethodInvokingFactoryBean(); factoryBean.setTargetClass(SecurityContextHolder.class); factoryBean.setStaticMethod(\"setStrategyName\"); factoryBean.setArguments(SecurityContextHolder.MODE_INHERITABLETHREADLOCAL); return factoryBean;&#125; æ‰©å±•ï¼š ä»SecurityContextHolderéƒ¨åˆ†æºç ä¸­ä¸éš¾çœ‹å‡ºï¼ŒSecurityContextHolderåœ¨åˆå§‹åŒ–æ—¶åŒ¹é…3ç§ç­–ç•¥åä»è€Œç”Ÿæˆå¯¹åº”ç­–ç•¥ï¼Œè‹¥éƒ½æ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™åŠ è½½è‡ªå®šä¹‰ç­–ç•¥ï¼Œæ­¤æ—¶strategyNameï¼ˆç­–ç•¥åï¼‰ä¸ºè‡ªå®šä¹‰ç­–ç•¥çš„ç±»è·¯å¾„ï¼Œè‡ªå®šä¹‰ç­–ç•¥éœ€å®ç°SecurityContextHolderStrategyæ¥å£ è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯ä»£ç å®ç°ï¼š1234567891011121314151617181920 //ä»springå®¹å™¨ä¸­è·å–UserDetailsService(è¿™ä¸ªä»æ•°æ®åº“æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯,åŠåŠ è½½æƒé™çš„service)UserDetailsService userDetailsService = (UserDetailsService)SpringContextUtil.getBean(\"userDetailsService\"); //æ ¹æ®ç”¨æˆ·åusernameåŠ è½½userDetailsUserDetails userDetails = userDetailsService.loadUserByUsername(username); //æ ¹æ®userDetailsæ„å»ºæ–°çš„Authentication,è¿™é‡Œä½¿ç”¨äº†//PreAuthenticatedAuthenticationTokenå½“ç„¶å¯ä»¥ç”¨å…¶ä»–token,å¦‚UsernamePasswordAuthenticationToken PreAuthenticatedAuthenticationToken authentication = new PreAuthenticatedAuthenticationToken(userDetails, userDetails.getPassword(),userDetails.getAuthorities()); //è®¾ç½®authenticationä¸­detailsauthentication.setDetails(new WebAuthenticationDetails(request)); //å­˜æ”¾authenticationåˆ°SecurityContextHolderSecurityContextHolder.getContext().setAuthentication(authentication);HttpSession session = request.getSession(true);//åœ¨sessionä¸­å­˜æ”¾security context,æ–¹ä¾¿åŒä¸€ä¸ªsessionä¸­æ§åˆ¶ç”¨æˆ·çš„å…¶ä»–æ“ä½œsession.setAttribute(\"SPRING_SECURITY_CONTEXT\", SecurityContextHolder.getContext());","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://cloudintheking.github.io/tags/spring/"}]},{"title":"rabbitmqæ¶ˆæ¯å»é‡åŠé˜²ä¸¢å¤±è§£å†³æ–¹æ¡ˆ","slug":"rabbitmqæ¶ˆæ¯å»é‡åŠé˜²ä¸¢å¤±è§£å†³æ–¹æ¡ˆ","date":"2019-03-22T03:38:54.000Z","updated":"2021-04-26T13:07:10.006Z","comments":true,"path":"posts/1e602a25.html","link":"","permalink":"https://cloudintheking.github.io/posts/1e602a25.html","excerpt":"","text":"- - ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ å‰ææˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç”µå•†é¡¹ç›®é‡Œæ—¶åˆ»éƒ½æœ‰æµ·é‡çš„æ¶ˆæ¯é€šçŸ¥ï¼Œæ¯”å¦‚é¡¾å®¢æ³¨å†Œé€šçŸ¥ã€ç­¾åˆ°é€šçŸ¥ã€ä¸‹å•é€šçŸ¥ç­‰ç­‰ï¼Œè€Œæˆ‘ä»¬å…¬å¸çš„ç”µå•†é¡¹ç›®æ›´åŠ å¤æ‚ï¼ŒåŒ…å«äº†å®¢æˆ·ç«¯ã€é—¨åº—ç«¯ä»¥åŠä¾›åº”å•†ç«¯ä¸‰ç«¯ï¼Œå„ç§å„æ ·çš„æ¶ˆæ¯é€šçŸ¥æ¸¸èµ°åœ¨å„ä¸ªæœåŠ¡æ¨¡å—é—´ã€‚å¦‚æœæ¯ä¸ªæ¨¡å—éƒ½è¦å®ç°ä¸€å¥—æ¶ˆæ¯é€šçŸ¥çš„åŠŸèƒ½ï¼Œé‚£æ— ç–‘æ˜¯å¤šä½™çš„ã€‚æ‰€ä»¥æˆ‘æŠŠå„æ¨¡å—çš„æ¶ˆæ¯åŠŸèƒ½æå–å‡ºæ¥ç‹¬ç«‹æˆä¸€ä¸ªæœåŠ¡æ¨¡å—ï¼Œå°±åƒä¸€ä¸ªå¿«é€’å‘˜ï¼ŒæŠŠå„æ¨¡å—çš„æ¶ˆæ¯å‡†ç¡®æŠ•é€’è‡³å„ç«¯ã€‚æˆ‘é‡‡ç”¨äº†è‡ªå·±ç†Ÿæ‚‰çš„rabbitmqæ¥å®ç°æ¶ˆæ¯åŠŸèƒ½ï¼Œå½“æ¨¡å—å¼€å‘å®Œäº¤å·®æ—¶ï¼Œç»„é•¿å†·ä¸ä¸æ¥äº†å¥ï¼šæ¶ˆæ¯å»é‡ä»¥åŠé˜²ä¸¢å¤±æœºåˆ¶å®ç°äº†æ²¡ï¼Ÿw(ï¾ŸĞ”ï¾Ÿ)wå¥½å§ï¼Œèµ¶ç´§å»å®ç°ã€‚ æ¶ˆæ¯å»é‡ä¾æˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œåœ¨æ¶ˆè´¹ç«¯å»é‡æ¯”è¾ƒå¥½ã€‚å› ä¸ºå³ä½¿ç”Ÿäº§ç«¯ä¿è¯æŠ•é€’åˆ°rabbitmqä¸Šçš„æ¶ˆæ¯æ˜¯ä¸é‡å¤çš„ï¼Œä½†rabbitmqæœåŠ¡å™¨æœ‰å¯èƒ½ç”±äºç³»ç»Ÿæˆ–ç½‘ç»œåŸå› å¯¼è‡´æ¶ˆæ¯é‡å¤æ¨é€åˆ°æ¶ˆè´¹ç«¯ï¼Œæ‰€ä»¥ç”Ÿäº§ç«¯å»é‡æ˜¯ä¸å¯é çš„ï¼Œåº”å½“åœ¨æ¶ˆè´¹ç«¯å»é‡ã€‚ æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘çš„æ–¹æ¡ˆæ˜¯åœ¨ç”Ÿäº§ç«¯æŠ•é€’æ¶ˆæ¯çš„åŒæ—¶ï¼Œä¼ å…¥correlationIdå…³è”idï¼Œåœ¨æ¶ˆè´¹ç«¯æ¥æ”¶æ¶ˆæ¯åï¼Œä»messageçš„messagePropertiesä¸­æ‹¿åˆ°correlationIdï¼Œå†æ ¹æ®correlationIdä»dbä¸­æŸ¥è¯¢æ˜¯å¦æœ‰ç›¸å…³è®°å½•ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¯´æ˜è¿™æ¡æ¶ˆæ¯å·²è¢«æˆ‘ä»¬æ¶ˆè´¹è¿‡ï¼Œç›´æ¥ackï¼Œä¸è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›æ²¡æœ‰ï¼Œé‚£å°±æŠŠæ¶ˆæ¯å†…å®¹å’ŒcorrelationIdå­˜å…¥è¡¨ä¸­ï¼Œç„¶åackã€‚ è¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘æŠŠæ¶ˆæ¯çš„æ¥æ”¶å’Œä¸šåŠ¡å¤„ç†åˆ†å¼€æ¥äº†ã€‚æ¶ˆæ¯ç›‘å¬å™¨åªè´Ÿè´£ç›‘å¬é˜Ÿåˆ—æ¶ˆæ¯ï¼Œå¹¶å°†å…¶å­˜è‡³dbä¸­ã€‚åœ¨å¦å¤–çš„ä»»åŠ¡çº¿ç¨‹é‡Œï¼Œä»dbä¸­å–æ¶ˆæ¯è®°å½•è¿›å»ä¸šåŠ¡å¤„ç†ï¼Œå¦‚æœä¸šåŠ¡å¤„ç†ä¸­å‡ºç°å¼‚å¸¸ï¼Œç»“åˆelasticsearchå®ç°å¼‚å¸¸æŠ¥è­¦ï¼ˆè¿™éƒ¨åˆ†è¿˜æ²¡åšï¼Œç›®å‰è¿˜åªæ˜¯è®°å½•ä¸‹é”™è¯¯ä¿¡æ¯åŠæ¶ˆæ¯å†…å®¹ï¼‰ã€‚ why?ä¸ºå•¥åˆ†å¼€å¤„ç†ï¼Œå…¶å®ä¸€å¼€å§‹çš„è®¾è®¡ä¸­æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†æ˜¯å†™åœ¨ä¸€èµ·çš„ï¼Œæ¶ˆæ¯å¤„ç†æˆåŠŸå›å¤ackï¼Œå¤„ç†å¼‚å¸¸å›å¤nackã€‚ä½†ä¼šæœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œä½†æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å‘ç°æ€»æœ‰é‚£ä¹ˆå‡ æ¡æ¶ˆæ¯å¡åœ¨é˜Ÿåˆ—é‡Œï¼Œå°±å› ä¸ºå¤„ç†å¼‚å¸¸å›å¤nackï¼Œæ¶ˆæ¯ä¸€ç›´åœ¨é‡å…¥é˜Ÿï¼Œä¸¥é‡æ¶ˆè€—rabbitmqæœåŠ¡å™¨çš„æ€§èƒ½ï¼æ‰€ä»¥è¯´ï¼Œå¤§éƒ¨åˆ†å¼‚å¸¸çš„æ¶ˆæ¯ï¼Œéƒ½ä¸èƒ½æŒ‡æœ›æŠŠæ¶ˆæ¯é‡æ¨åˆ°åˆ«çš„æ¶ˆè´¹ç«¯å°±èƒ½å¤„ç†æˆåŠŸäº†ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†åˆ†å¼€æ¥æ˜¯æ¯”è¾ƒå¥½çš„ã€‚ æ–¹æ¡ˆæ˜¯æœ‰äº†ï¼Œä½†å…·ä½“ä»£ç æ€ä¹ˆå®ç°å‘¢ï¼Ÿç”Ÿäº§ç«¯å…³é”®ä»£ç ï¼š1234567891011121314public void send(String routingKey, String msg) &#123; RabbitTemplate rabbitTemplate = applicationContext.getBean(\"rabbitTemplate\", RabbitTemplate.class); rabbitTemplate.setReturnCallback(this); log.info(\"æ¶ˆæ¯å‘é€å†…å®¹ : \" + msg); CorrelationData correlationId = new CorrelationData(UUID.randomUUID().toString()); rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123; if (!ack) &#123; throw new RuntimeException(\"send error \" + cause); &#125; else &#123; log.info(\"send() æ¶ˆæ¯å‘é€æˆåŠŸ \"); &#125; &#125;); rabbitTemplate.convertAndSend(\"amq.topic\", routingKey, msg, correlationId); &#125; æˆ‘ä»¬ç‚¹å¼€rabbitTemplate.convertAndSendæ–¹æ³•123public void convertAndSend(String exchange, String routingKey, Object object, CorrelationData correlationData) throws AmqpException &#123; this.send(exchange, routingKey, this.convertMessageIfNecessary(object), correlationData); &#125; çœ‹åˆ°æ²¡ï¼ŒconvertAndSendæ–¹æ³•æ˜¯ä»¥Objectæ¥æ¥æ”¶æ¶ˆæ¯å†…å®¹ï¼Œå®ƒå†…éƒ¨è°ƒç”¨çš„sendæ–¹æ³•æœ€ç»ˆè¿˜æ˜¯æŠŠObjectç±»è½¬æˆMessageç±»ä»ä¸Šå›¾å¯ä»¥çœ‹çš„å‡ºï¼ŒMessageåŒ…å«äº†ENCODINGï¼ˆç¼–ç æ–¹å¼ï¼‰ã€SERIALIZER_MESSAGE_CONVERTERï¼ˆåºåˆ—åŒ–æ¶ˆæ¯è½¬æ¢å™¨ï¼‰ã€messagePropertiesï¼ˆæ¶ˆæ¯å±æ€§ï¼‰ã€bodyï¼ˆæ¶ˆæ¯å†…å®¹ï¼‰ï¼Œé˜Ÿåˆ—é‡Œæ¶ˆæ¯å­˜æ”¾ç€è¿™äº›ä¸œä¸œã€‚æˆ‘ä»¬å†çœ‹çœ‹MessagePropertiesé‡Œæ”¾ç€ä»€ä¹ˆ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647 public class MessageProperties implements Serializable &#123; private static final long serialVersionUID = 1619000546531112290L; public static final String CONTENT_TYPE_BYTES = \"application/octet-stream\"; public static final String CONTENT_TYPE_TEXT_PLAIN = \"text/plain\"; public static final String CONTENT_TYPE_SERIALIZED_OBJECT = \"application/x-java-serialized-object\"; public static final String CONTENT_TYPE_JSON = \"application/json\"; public static final String CONTENT_TYPE_JSON_ALT = \"text/x-json\"; public static final String CONTENT_TYPE_XML = \"application/xml\"; public static final String SPRING_BATCH_FORMAT = \"springBatchFormat\"; public static final String BATCH_FORMAT_LENGTH_HEADER4 = \"lengthHeader4\"; public static final String SPRING_AUTO_DECOMPRESS = \"springAutoDecompress\"; public static final String X_DELAY = \"x-delay\"; public static final String DEFAULT_CONTENT_TYPE = \"application/octet-stream\"; public static final MessageDeliveryMode DEFAULT_DELIVERY_MODE; public static final Integer DEFAULT_PRIORITY; private final Map&lt;String, Object&gt; headers = new HashMap(); private volatile Date timestamp; private volatile String messageId; private volatile String userId; private volatile String appId; private volatile String clusterId; private volatile String type; private volatile String correlationId; private volatile String replyTo; private volatile String contentType = \"application/octet-stream\"; private volatile String contentEncoding; private volatile long contentLength; private volatile boolean contentLengthSet; private volatile MessageDeliveryMode deliveryMode; private volatile String expiration; private volatile Integer priority; private volatile Boolean redelivered; private volatile String receivedExchange; private volatile String receivedRoutingKey; private volatile String receivedUserId; private volatile long deliveryTag; private volatile boolean deliveryTagSet; private volatile Integer messageCount; private volatile String consumerTag; private volatile String consumerQueue; private volatile Integer receivedDelay; private volatile MessageDeliveryMode receivedDeliveryMode; private volatile boolean finalRetryForMessageWithNoId; private transient volatile Type inferredArgumentType; private transient volatile Method targetMethod; private transient volatile Object targetBean;&#125; æœç„¶correlationIdå°±åœ¨è¿™é‡Œï¼Œç„¶åçœ‹åˆ°è¿™é‡Œæˆ‘å°±æ²¡ç»§ç»­æ·±å…¥äº†ï¼ŒåŸä»¥ä¸ºrabbitTemplate.convertAndSendæ–¹æ³•ä¼šè‡ªåŠ¨å°†correlationIdæ”¾å…¥messagePropertiesä¸­ï¼Œç»“æœè¡¨æ˜æˆ‘é”™äº†ã€‚åœ¨æ¶ˆè´¹ç«¯æ‹¿åˆ°çš„correlationIdä¸ºnullã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒconvertAndSendæ–¹æ³•é‡ŒcorrelationIdæ ¹æœ¬å°±æ²¡æœ‰è¢«æ”¾è¿›å»çš„ï¼Œå¤§å®¶æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹æºç ï¼Œè¿™é‡Œå°±ä¸è¯´äº†ã€‚ é—®é¢˜æ‰¾å‡ºæ¥å°±å¥½åŠäº†123456789101112131415161718public void send(String routingKey, String msg) &#123; RabbitTemplate rabbitTemplate = applicationContext.getBean(\"rabbitTemplate\", RabbitTemplate.class); rabbitTemplate.setReturnCallback(this); log.info(\"æ¶ˆæ¯å‘é€å†…å®¹ : \" + msg); CorrelationData correlationId = new CorrelationData(UUID.randomUUID().toString()); rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123; if (!ack) &#123; throw new RuntimeException(\"send error \" + cause); &#125; else &#123; log.info(\"send() æ¶ˆæ¯å‘é€æˆåŠŸ \"); &#125; &#125;); Message message = MessageBuilder.withBody(msg.getBytes()) .setContentType(MessageProperties.CONTENT_TYPE_TEXT_PLAIN) .setCorrelationId(correlationId.toString()) .build(); rabbitTemplate.convertAndSend(\"amq.topic\", routingKey, message, correlationId); &#125; ç›´æ¥æ„å»ºMessageç±»ï¼Œæ‰‹åŠ¨ä¼ å…¥correlationIdæ€»è¡Œäº†å§ã€‚åœ¨æ¶ˆè´¹ç«¯ä»Messageé‡Œæ‹¿åˆ°correlationIdï¼Œå†ä»dbæŸ¥è¯¢å°±è¡Œäº†ã€‚å¥½äº†ï¼Œåˆ°è¿™é‡Œå»é‡æœºåˆ¶å°±å®ç°äº†ğŸ˜ æ¶ˆæ¯é˜²ä¸¢å¤±rabbitmqæ˜¯æ”¯æŒé˜Ÿåˆ—ã€æ¶ˆæ¯çš„æŒä¹…åŒ–çš„ã€‚å³ä¾¿rabbitmqçªç„¶æŒ‚äº†ï¼Œé‚£äº›å°šåœ¨é˜Ÿåˆ—æœªèƒ½æ¨é€çš„æ¶ˆæ¯åœ¨rabbitmqé‡å¯åä¹Ÿæ˜¯èƒ½å¤Ÿç»§ç»­æ¨é€çš„ï¼Œæ‰€ä»¥ä¸¢å¤±é—®é¢˜ä¸€èˆ¬ä¸å‡ºç°åœ¨rabbitmqä¸Šã€‚ rabbitmqå°†æ¶ˆæ¯ä»é˜Ÿåˆ—æ¨åˆ°æ¶ˆè´¹ç«¯åï¼Œéœ€è¦æœ‰ä¸€ä¸ªå›åº”å‘Šè¯‰å®ƒé˜Ÿåˆ—é‡Œçš„è¿™æ¡æ¶ˆæ¯çš„å»ç•™ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š auto: è‡ªåŠ¨å›åº”ï¼Œæ¶ˆæ¯åœ¨å‘é€ç»™æ¶ˆè´¹ç«¯åç«‹å³ç¡®è®¤ manual æ‰‹åŠ¨å›åº”ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ­£å¸¸åç”±æ¶ˆè´¹ç«¯è¿”å›ack;æˆ–æ¶ˆè´¹å¼‚å¸¸è¿”å›nack,å°†æ¶ˆæ¯é‡å…¥é˜Ÿï¼›æˆ–è¿”å›reject,ä¸¢å¼ƒè¯¥æ¡æ¶ˆæ¯ springbootçš„yamlé…ç½®123456789101112rabbitmq: host: 127.0.0.1 port: 5672 username: admin password: admin publisher-confirms: true #å¼€å¯confirmcallback publisher-returns: true #å¼€å¯returncallback listener: simple: acknowledge-mode: manual direct: acknowledge-mode: MANUAL å¦å¤–ï¼Œå¦‚æœæ¶ˆæ¯åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼Œæ¶ˆè´¹ç«¯ä¸rabbitmqçš„è¿æ¥ä¸­æ–­äº†ï¼Œé‚£è¿™æ¡æ¶ˆæ¯ä¼šè¢«é‡æ–°æ”¾å›é˜Ÿåˆ—è¿›è¡Œæ¨é€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„å»é‡æœºåˆ¶å°±èµ·ä½œç”¨äº†ï¼›å¦‚æœæ¶ˆè´¹çš„æ—¶å€™ï¼Œæ¶ˆè´¹ç«¯æ­»æœºäº†ï¼Œé•¿æ—¶é—´ä¸å›åº”rabbitmqï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å°†è¯¥æ¶ˆæ¯è½¬è‡³æ­»ä¿¡é˜Ÿåˆ—ï¼Œé˜²æ­¢åŸé˜Ÿåˆ—é˜»å¡ã€‚æ­»ä¿¡é˜Ÿåˆ—ï¼Œè¿™é‡Œä¹Ÿä¸åšä»‹ç»ï¼Œæœ‰å…´è¶£ç™¾åº¦å‘—ã€‚æ‰€ä»¥æ¶ˆè´¹ç«¯å‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½æ€§ä¹Ÿä¸å¤§ï¼Œé—®é¢˜å°±å¯èƒ½å‡ºåœ¨ç”Ÿäº§ç«¯ã€‚çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾å·¦è¾¹Pä»£è¡¨ç”Ÿäº§ç«¯ï¼Œä¸­é—´æ˜¯rabbitmqï¼Œå³è¾¹æ˜¯æ¶ˆè´¹ç«¯ï¼Œç»¿è‰²çš„Xæ˜¯äº¤æ¢æœºï¼Œçº¢è‰²çš„æ˜¯é˜Ÿåˆ—ï¼Œç”¨è¿‡rabbitmqçš„å°ä¼™ä¼´è‚¯å®šä¸€ç›®äº†ç„¶äº†ã€‚ rabbitmq æ•´ä¸ªæ¶ˆæ¯æŠ•é€’çš„è·¯å¾„ä¸ºï¼šproducer-&gt;rabbitmq broker cluster-&gt;exchange-&gt;queue-&gt;consumer ç”Ÿäº§ç«¯æŠ•é€’æ¶ˆæ¯åˆ°rabbitmqé‡Œï¼Œrabbitmqå°†æ¶ˆæ¯å‘åˆ°äº¤æ¢æœºä¸­ï¼Œäº¤æ¢æœºå†æ ¹æ®è·¯ç”±é”®å°†æ¶ˆæ¯æœ€ç»ˆé€åˆ°é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å–å‡ºæ¶ˆæ¯æ¨é€åˆ°æ¶ˆè´¹ç«¯ã€‚åªæœ‰æœ€ç»ˆæŠµè¾¾é˜Ÿåˆ—çš„æ¶ˆæ¯æ‰æ˜¯å¯é çš„ï¼Œä¸ä¼šä¸¢å¤±ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å®ç°çš„å°±æ˜¯ä¿è¯ç”Ÿäº§ç«¯çš„æ¶ˆæ¯åŠ¡å¿…æ¨é€åˆ°rabbitmqçš„é˜Ÿåˆ—ä¸­ã€‚ é‚£ä¹ˆç”Ÿäº§ç«¯æ˜¯æ€ä¹ˆçŸ¥é“è‡ªå·±çš„æ¶ˆè´¹å‡†ç¡®æŠ•é€’åˆ°äº†é˜Ÿåˆ—ä¸­å‘¢ï¼Ÿrabbitmqè¿”å›äº†ä¸¤ä¸ªå›è°ƒç»™ç”Ÿäº§ç«¯ã€‚ message ä» producer åˆ° rabbitmq broker cluster åˆ™ä¼šè¿”å›ä¸€ä¸ª confirmCallback message ä» exchange-&gt;queue æŠ•é€’å¤±è´¥åˆ™ä¼šè¿”å›ä¸€ä¸ª returnCallback ã€‚æˆ‘ä»¬å°†åˆ©ç”¨è¿™ä¸¤ä¸ª callback æ§åˆ¶æ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§å’Œéƒ¨åˆ†çº é”™èƒ½åŠ›ã€‚ è§£å†³æ–¹æ¡ˆç”Ÿäº§ç«¯åœ¨æŠ•é€’æ¶ˆæ¯å‰ï¼Œå…ˆå°†æ¶ˆæ¯å†…å®¹ã€æŠ•é€’çŠ¶æ€ã€é‡è¯•æ¬¡æ•°è®°å½•åœ¨dbä¸­ï¼Œç„¶ååœ¨ä¸¤ä¸ªå›è°ƒä¸­ä¿®æ”¹è®°å½•çŠ¶æ€ã€‚å¦å¤–å†å¼€ä¸€ä¸ªä»»åŠ¡çº¿ç¨‹å»å–dbä¸­è®°å½•çš„å¤±è´¥æ¶ˆæ¯ï¼Œè¿›è¡Œé‡æ–°æŠ•é€’ã€‚ ä»£ç å®ç°å¤±è´¥æ¶ˆæ¯è®°å½•å®ä½“ç±»ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142/** * @time: 2019/2/18 9:14 * @author: hl * @descripe: å¤±è´¥æ¶ˆæ¯è®°å½• * @version: 1.0 */Entity@Table(name = \"t_failure_mq_record\")@Data@NoArgsConstructor@EntityListeners(AuditingEntityListener.class)public class FailureMqRecord extends Uuid &#123; /** * å¤±è´¥æ¶ˆæ¯å†…å®¹ */ private String message; /** * é‡è¯•æ¬¡æ•° */ @Column(name = \"retry_time\") private Integer retryTime; /** * æ¶ˆæ¯çŠ¶æ€ 1:æŠ•é€’æˆåŠŸ 2ï¼šæŠ•é€’å¤±è´¥ */ private Integer status; /** * å…³è”id */ private String correlationId; /** * åˆ›å»ºæ—¶é—´ */ @CreatedDate @Column(name = \"create_time\", updatable = false) private Date createTime; public FailureMqRecord(String message) &#123; this.message = message; &#125;&#125; rabbitmqå‘é€å™¨ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * @time: 2019/2/13 9:47 * @author: hl * @descripe: * @version: 1.0 */@Component@Slf4jpublic class RabbitMqSender implements RabbitTemplate.ReturnCallback &#123; @Autowired private ApplicationContext applicationContext; @Autowired private FailureMqRecordRepository failureMqRecordRepository; public void send(String routingKey, FailureMqRecord failureMqRecord) &#123; RabbitTemplate rabbitTemplate = applicationContext.getBean(\"rabbitTemplate\", RabbitTemplate.class); //è®¾ç½®å½“å‰å®ä¾‹ä¸ºrabbitmqtemplateçš„returncallback rabbitTemplate.setReturnCallback(this); rabbitTemplate.setConfirmCallback(((correlationData1, ack, cause) -&gt; &#123; if (!ack) &#123; //æŠ•é€’è‡³brokerå¤±è´¥ failureMqRecord.setStatus(2);//è®¾ä¸ºæŠ•é€’å¤±è´¥ failureMqRecordRepository.save(failureMqRecord); &#125; &#125;)); Message message = MessageBuilder.withBody(failureMqRecord.getMessage().getBytes()) .setContentType(MessageProperties.CONTENT_TYPE_TEXT_PLAIN) .setCorrelationId(failureMqRecord.getCorrelationId()) .build(); rabbitTemplate.convertAndSend(\"amq.topic\", routingKey, message, new CorrelationData(failureMqRecord.getCorrelationId())); failureMqRecord.setStatus(1);//è®¾ä¸ºæŠ•é€’æˆåŠŸ failureMqRecord.setRetryTime(failureMqRecord.getRetryTime() + 1);//é‡è¯•æ¬¡æ•°+1 failureMqRecordRepository.save(failureMqRecord); &#125; /** * æ¶ˆæ¯ç”±exchangæœªèƒ½æ­£ç¡®æŠ•é€’åˆ°queueæ—¶è§¦å‘å›è°ƒ * * @param message * @param replyCode * @param replyText * @param exchange * @param routingKey */ @Override public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) throws BusinessException &#123; FailureMqRecord mq = failureMqRecordRepository.findByCorrelationId(message.getMessageProperties().getCorrelationId()); mq.setStatus(2); failureMqRecordRepository.save(mq); log.error(\"å®¡æ‰¹æ¶ˆæ¯ï¼š&#123;&#125; æŠ•é€’è‡³è·¯ç”±ï¼š&#123;&#125;å¤±è´¥\", message.getBody(), routingKey); &#125;&#125; ä»»åŠ¡çº¿ç¨‹ï¼Œå®ç°æ¶ˆæ¯é‡è¯•æœºåˆ¶ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556/** * @time: 2019/2/18 10:10 * @author: huanglong * @descripe: æ¶ˆæ¯é‡å‘å®šæ—¶å™¨ * @version: 1.0 */@Component@Slf4jpublic class MqScheduler &#123; @Autowired private RabbitMqSender rabbitMqSender; @Autowired private ApprovalMqRepository failureMqRecordRepository; @Autowired private RedisDistributedLock redisDistributedLock; /** * æ¯3åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ * å°†æŠ•é€’å¤±è´¥æ¶ˆæ¯é‡æ–°æŠ•é€’åˆ°rabbitmq */ @Scheduled(cron = \"* */3 * * * ?\") void push() &#123; List&lt;FailureMqRecord&gt; failureMqRecords = failureMqRecordRepository.findAll() .stream() .filter(failureMqRecord -&gt; &#123; if (failureMqRecord.getRetryTime() == 3) &#123; log.error(\"è­¦å‘Šï¼è¯¥æ¶ˆæ¯å·²é‡æŠ•3æ¬¡å¤±è´¥ï¼Œè¯·äººå·¥å¤„ç†ï¼Œæ¶ˆæ¯è®°å½•uuid:&#123;&#125;\", failureMqRecord.getUuid()); &#125; //è¿‡æ»¤å‡ºé‡è¯•æ¬¡æ•°ä¸è¶…è¿‡3æ¬¡ã€çŠ¶æ€ä¸º2çš„æ¶ˆæ¯è®°å½• if (failureMqRecord.getRetryTime() &lt; 3 &amp;&amp; failureMqRecord.getStatus() == 0) &#123; return true; &#125; return false; &#125;) .collect(Collectors.toList()); Iterator&lt;FailureMqRecord&gt; mqIterator = failureMqRecords.iterator(); while (mqIterator.hasNext()) &#123; FailureMqRecord failureMqRecord = mqIterator.next(); //è·å–ğŸ”’,è¿‡æœŸæ—¶é—´5ç§’ï¼Œä¸é‡å¤è·å– if (redisDistributedLock.lock(failureMqRecord.getUuid(), 5000L, 0, 1000L)) &#123; // å› ä¸ºæœ‰å¯èƒ½ä¸Šä¸€ä¸ªçº¿ç¨‹åˆšé‡Šæ”¾è¯¥è®°å½•çš„é”ï¼Œå°±è¢«å½“å‰å…ˆçº¿ç¨‹è·å–åˆ°è¯¥è®°å½•çš„é”ï¼Œå¯¼è‡´è®°å½•å·²è¢« FailureMqRecord failurelatest = failureMqRecordRepository.findById(failureMqRecord.getUuid()).orElse(null); ApprovalPushMessage pushMessage = JSON.parseObject(failurelatest.getMessage(), ApprovalPushMessage.class); //å½“å‰æ—¶é—´è·ç¦»è¯¥è®°å½•æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ—¶é—´çš„é—´éš”ï¼Œé˜²æ­¢ä¸Šä¸ªçº¿ç¨‹é‡è¯•è¿‡åï¼Œå½“å‰çº¿ç¨‹åˆé‡è¯•ä¸€æ¬¡ long lastUpdatePeriod = System.currentTimeMillis() - failurelatest.getUpdateTime().getTime(); //è·ç¦»ä¸Šæ¬¡æ›´æ–°é—´éš” //é‡åˆ¤æ–­è®°å½•æ˜¯å¦ç¬¦åˆæ¡ä»¶,é‡è¯•æ¬¡æ•°å°äº3ã€çŠ¶æ€ä¸ºæŠ•é€’å¤±è´¥ã€è·ç¦»ä¸Šæ¬¡é‡è¯•ä¸èƒ½å°‘äº2åˆ†é’Ÿ if (failurelatest.getRetryTime() &lt; 3 &amp;&amp; failurelatest.getStatus() == 2 &amp;&amp; lastUpdatePeriod &gt; 2 * 60 * 1000) &#123; rabbitMqSender.send(\"approval.create\", failureMqRecord); &#125; //é‡Šæ”¾ğŸ”’ redisDistributedLock.releaseLock(failureMqRecord.getUuid()); &#125; &#125; &#125;&#125; èªæ˜çš„å°ä¼™ä¼´çœ‹åˆ°è¿™é‡Œï¼Œä¼šå‘ç°ä»»åŠ¡çº¿ç¨‹é‡Œè¿˜ç”¨åˆ°äº†åˆ†å¸ƒå¼ğŸ”’ã€‚ä¸ºå•¥è¿˜è¦åŠ åˆ†å¸ƒå¼é”ï¼Œå› ä¸ºæ˜¯åˆ†å¸ƒå¼æ¶æ„å•Šï¼Œä¼šæœ‰å¤šä¸ªç›¸åŒå®šæ—¶å™¨ä»dbé‡Œå–è®°å½•å¤„ç†ï¼Œå¦‚æœä¸åŠ åˆ†å¸ƒå¼é”ï¼Œé‚£çœŸçš„è¦ä¹±å¥—äº†ã€‚å› ä¸ºredisç”¨çš„å¤šï¼Œå°±ç”¨redisæ¥å®ç°åˆ†å¸ƒå¼é”äº†ï¼Œzookeeperå•¥çš„ï¼Œæœ‰ç©ºå†ç ”ç©¶äº†ã€‚redisåˆ†å¸ƒå¼é”çš„ä»£ç å®ç°ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æºï¼Œæˆ‘è¿™é‡Œå°±ä¸è´´äº†ï¼Œå˜¿å˜¿ å¥½äº†ï¼Œåˆ°è¿™é‡Œrabbitmqçš„å»é‡ä»¥åŠé˜²ä¸¢å¤±æ–¹æ¡ˆå·²ç»å®ç°äº†ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæˆ–è€…æŒ‡å‡ºæˆ‘æ–¹æ¡ˆçš„ä¸è¶³ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºğŸ˜","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"rabbitmq","slug":"rabbitmq","permalink":"https://cloudintheking.github.io/tags/rabbitmq/"}]},{"title":"è®°å½•ä¸€æ¬¡å¾®æœåŠ¡å¼‚æ­¥åŒ–å®ç°è¿‡ç¨‹","slug":"è®°å½•ä¸€æ¬¡å¾®æœåŠ¡å¼‚æ­¥åŒ–å®ç°è¿‡ç¨‹","date":"2019-03-21T03:54:04.000Z","updated":"2021-04-26T13:07:10.006Z","comments":true,"path":"posts/f445f2a6.html","link":"","permalink":"https://cloudintheking.github.io/posts/f445f2a6.html","excerpt":"","text":"- - ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ å‰æå…¬å¸ä½¿ç”¨springcloudå¼€å‘å¾®æœåŠ¡ï¼Œæˆ‘åœ¨å¼€å‘å®¡æ‰¹æ¨¡å—ä¸­ï¼Œå…¶ä¸­ä¸€ä¸ªæ–°å¢å®¡æ‰¹è¯·æ±‚ä¸­è¯·æ±‚äº†å…¶ä»–å‡ ä¸ªæ¨¡å—ï¼Œä½¿ç”¨feignæ¥å£ä¾æ¬¡è¯·æ±‚ï¼Œæœ€åå‘ç°è¯·æ±‚å¹³å‡è€—æ—¶1.5sã€‚è¿™é€Ÿåº¦æ€ä¹ˆèƒ½å¿ï¼Œäºæ˜¯è¿›è¡Œäº†å¼‚æ­¥åŒ–æ”¹é€ ã€‚ å¼‚æ­¥åŒ–åŒæ­¥ç‰ˆå…³é”®ä»£ç 12345678910111213logger.info(\"rpcè¯·æ±‚å¼€å§‹\"); long rpcstart = System.currentTimeMillis(); StoreStaffDTO staffDTO = staffClient.getStaffDTO(userDTO.getUuid()); //è·å–é—¨åº—å‘˜å·¥ä¿¡æ¯ SupplierDTO supplierDTO = supplierClient.getSupplierDTO(userDTO.getSupplierCode()); //è·å–ä¾›åº”å•†ä¿¡æ¯ StoreDTO staffStoreDTO = storeClient.getStoreDTO(userDTO.getStoreUuid()); //è·å–å‘˜å·¥æ‰€åœ¨é—¨åº—ä¿¡æ¯ CustomerInfoDTO customerInfoDTO = customerInfoClient.getCustomerInfo(approval.getCustomerUuid()); //è·å–é¡¾å®¢ä¿¡æ¯ StoreDTO inStoreDto = ObjectUtils.isEmpty(approval.getInStoreUuid()) ? null : storeClient.getStoreDTO(approval.getInStoreUuid());//è·å–å®¢æˆ·è½¬å…¥é—¨åº—ä¿¡æ¯ ServerDto serverDto = ObjectUtils.isEmpty(approval.getServerUuid()) ? null : serveClient.getServeSpecTypeByuuid(approval.getServerUuid()); //è·å–æœåŠ¡ä¿¡æ¯ CustAccountDto custAccountDto = ObjectUtils.isEmpty(approval.getCustCardUuid()) ? null : accountClient.getCustAccount(approval.getCustCardUuid()); //è·å–é¡¾å®¢è´¦æˆ·ä¿¡æ¯ long rpcend = System.currentTimeMillis(); logger.info(\"rpcè¯·æ±‚ç»“æŸï¼Œè€—æ—¶ï¼š&#123;&#125;æ¯«ç§’\", (rpcend - rpcstart)); console ä»æ‰“å°æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºï¼Œç”±äºç½‘ç»œæ³¢åŠ¨æ€§ï¼Œè¯·æ±‚è€—æ—¶å¯èƒ½åªè¦1ç§’ä¹Ÿå¯èƒ½å°†è¿‘4ç§’ï¼Œä½†rpcè¯·æ±‚æ€»æ˜¯ä¼šå æ€»è€—æ—¶çš„90%å·¦å³ï¼Œæ‰€ä»¥å½±å“æ–°å¢å®¡æ‰¹çš„è¯·æ±‚çš„ç“¶é¢ˆå°±æ˜¯è¿™äº›rpcè¯·æ±‚ï¼Œä¸‹é¢æˆ‘ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹å‘é€è¿™äº›rpcè¯·æ±‚ã€‚ å¼‚æ­¥ç‰ˆå…³é”®ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102logger.info(\"rpcè¯·æ±‚å¼€å§‹\"); long rpcstart = System.currentTimeMillis(); Approval approvalFina = approval; CompletableFuture&lt;StoreDTO&gt; storeDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); return storeClient.getStoreDTO(userDTO.getStoreUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é—¨åº—ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š\", e); throw e; &#125; &#125;); CompletableFuture&lt;StoreDTO&gt; inStoreDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getInStoreUuid())) &#123; return storeClient.getStoreDTO(approvalFina.getInStoreUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–è½¬å…¥é—¨åº—ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;SupplierDTO&gt; supplierDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); return supplierClient.getSupplierDTO(userDTO.getSupplierCode()); &#125; catch (Exception e) &#123; logger.error(\"è·å–ä¾›åº”å•†ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;StoreStaffDTO&gt; staffDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); return staffClient.getStaffDTO(userDTO.getUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é—¨åº—å‘˜å·¥ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;CustomerInfoDTO&gt; customerInfoDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); return customerInfoClient.getCustomerInfo(approvalFina.getCustomerUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é¡¾å®¢ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;ServerDto&gt; serverDtoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getServerUuid())) &#123; return serveClient.getServeSpecTypeByuuid(approvalFina.getServerUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–æœåŠ¡ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;CustAccountDto&gt; custAccountDtoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getCustCardUuid())) &#123; return accountClient.getCustAccount(approvalFina.getCustCardUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–é¡¾å®¢è´¦æˆ·ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture.allOf(storeDTOCompletableFuture, inStoreDTOCompletableFuture, serverDtoCompletableFuture, supplierDTOCompletableFuture, staffDTOCompletableFuture, customerInfoDTOCompletableFuture, custAccountDtoCompletableFuture); StoreStaffDTO staffDTO = null;//å‘˜å·¥ä¿¡æ¯ SupplierDTO supplierDTO = null; //ä¾›åº”å•†ä¿¡æ¯ StoreDTO staffStoreDTO = null;//å‘˜å·¥æ‰€åœ¨é—¨åº—ä¿¡æ¯ CustomerInfoDTO customerInfoDTO = null; //é¡¾å®¢ä¿¡æ¯ StoreDTO inStoreDto = null;//é¡¾å®¢è½¬å…¥é—¨åº—ä¿¡æ¯ ServerDto serverDto = null; //æœåŠ¡ä¿¡æ¯ CustAccountDto custAccountDto = null; //é¡¾å®¢è´¦æˆ·ä¿¡æ¯ try &#123; staffStoreDTO = storeDTOCompletableFuture.get(); inStoreDto = inStoreDTOCompletableFuture.get(); staffDTO = staffDTOCompletableFuture.get(); supplierDTO = supplierDTOCompletableFuture.get(); customerInfoDTO = customerInfoDTOCompletableFuture.get(); serverDto = serverDtoCompletableFuture.get(); custAccountDto = custAccountDtoCompletableFuture.get(); &#125; catch (InterruptedException e) &#123; logger.error(\"çº¿ç¨‹ä¸­æ–­é”™è¯¯ä¿¡æ¯ï¼š&#123;&#125;\", e); &#125; catch (ExecutionException e) &#123; logger.error(\"çº¿ç¨‹æ‰§è¡Œé”™è¯¯ä¿¡æ¯ï¼š&#123;&#125;\", e); &#125; long rpcend = System.currentTimeMillis(); logger.info(\"rpcè¯·æ±‚ç»“æŸï¼Œè€—æ—¶ï¼š&#123;&#125;æ¯«ç§’\", (rpcend - rpcstart)); console exceptionåˆ†æwhatğŸ˜¨!ç«Ÿç„¶æŠ¥æœªæˆæƒç™»å½•å¼‚å¸¸ï¼Œä¸å¯èƒ½ï¼Œfeignè¯·æ±‚é‡Œåº”è¯¥æ˜¯å¸¦äº†è¯·æ±‚å¤´é˜¿ï¼Œä¸‹é¢æ‹“å±•ä¸€äº›çŸ¥è¯†ã€‚ çŸ¥è¯†æ‹“å±•completableFuturecompletableFutureæ‰©å±•äº†Futureçš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ç°äº†çº¿ç¨‹é—´åŒæ­¥çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç”¨å®ƒæä¾›çš„è¯­æ³•ï¼Œå¯ä»¥å¾ˆç®€å•çš„å®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚ oauth2æ¡†æ¶é‡Œå¼•ç”¨äº†spring securityä»¥åŠoauth2æ¥å®ç°æˆæƒè®¤è¯æœåŠ¡,æ‰€ä»¥å®¢æˆ·è¯·æ±‚æ˜¯è¦å¸¦ä¸ŠAuthorizationè¯·æ±‚å¤´çš„ã€‚ feignfeignçš„æœ¬è´¨ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨httpclientå¸®æˆ‘ä»¬å°è£…å¥½äº†httpè¯·æ±‚ã€‚æ‰€ä»¥è°ƒç”¨feignæ¥å£çš„æ–¹æ³•å°±æ˜¯å‘èµ·ä¸€æ¬¡httpè¯·æ±‚è€Œå·²ã€‚å¦‚æœä¸åšå¤„ç†çš„ï¼Œé‚£ä¹ˆfeignå‘é€çš„httpè¯·æ±‚é‡Œæ˜¯æ²¡æœ‰Authorizationè¯·æ±‚å¤´çš„ã€‚ RequestInterceptorRequestInterceptoræ˜¯feignæä¾›çš„ä¸€ä¸ªæ‹¦æˆªå™¨æ”¾å‡ºæˆ‘çš„é…ç½®ï¼š123456789101112131415@Configurationpublic class FeignOauth2RequestInterceptor implements RequestInterceptor &#123; private final String AUTHORIZATION_HEADER = \"Authorization\"; private final String BEARER_TOKEN_TYPE = \"Bearer\"; @Override public void apply(RequestTemplate requestTemplate) &#123; SecurityContext securityContext = SecurityContextHolder.getContext(); Authentication authentication = securityContext.getAuthentication(); if (authentication != null &amp;&amp; authentication.getDetails() instanceof OAuth2AuthenticationDetails) &#123; OAuth2AuthenticationDetails details = (OAuth2AuthenticationDetails) authentication.getDetails(); requestTemplate.header(AUTHORIZATION_HEADER, String.format(\"%s %s\", BEARER_TOKEN_TYPE, details.getTokenValue())); &#125; &#125;&#125; æ‹¦æˆªå™¨çš„ä½œç”¨å°±æ˜¯ä»securityContextæ‹¿åˆ°å½“å‰è¯·æ±‚ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯authenticationï¼Œç„¶åä¸ºfeignçš„è¯·æ±‚æ¨¡æ¿Â·requestTemplateÂ·èµ‹ä¸ŠAuthorizationè¯·æ±‚å¤´ã€‚ æ–­ç‚¹è·Ÿè¸ªæ–­ç‚¹1æ‰“ä¸ªæ–­ç‚¹è·Ÿè¿›ï¼Œçœ‹çœ‹æ‹¦æˆªåfeignæ‰§è¡Œäº†å“ªäº›æ“ä½œï¼Œå…³é”®ä½ç½®å¦‚ä¸‹å›¾ï¼šå¯ä»¥çœ‹åˆ°feignå°†requestTemplateå°è£…æˆrequestå¯¹è±¡ï¼Œå¹¶æœ€ç»ˆè¢«clientæ‰§è¡Œå¾—åˆ°response,é‡Œé¢è¯¦ç»†ç»†èŠ‚å°±ä¸æ·±å…¥ã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè°ƒç”¨feignå‘é€çš„è¯·æ±‚æ˜¯æºå¸¦Authorizationè¯·æ±‚å¤´çš„,è¿™æ ·æ¨¡å—é—´å‘èµ·è¯·æ±‚å°±ä¸ä¼šæŠ¥æœªæˆæƒé”™è¯¯äº†ã€‚ æ–­ç‚¹2æ‰€ä»¥æŒ‰é“ç†æ˜¯ä¸åº”è¯¥æŠ¥ç”¨æˆ·æœªç™»å½•æˆæƒå¼‚å¸¸çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ‹¦æˆªå™¨æ‰“ä¸ªç«¯ç‚¹,çœ‹çœ‹requestTemplateåˆ°åº•æœ‰æ²¡æœ‰è¢«èµ‹ä¸Šè¯·æ±‚å¤´ã€‚whatğŸ˜®!è¿™ä¸æ˜¯æ¨ç¿»äº†æˆ‘çš„è®¤çŸ¥å—,çœ¼ç¥é€æ¸å‘†æ»ğŸ˜‘å¼€ä¸ªç©ç¬‘ï¼Œauthenticationä»securityContexté‡Œè·å–ï¼ŒsecurityContextä»SecurityContextHolderé™æ€æ–¹æ³•ä¸­è·å– ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºsecurityContextæ˜¯ä»strategyé‡Œæ‹¿åˆ°çš„ã€‚SecurityContextHolderStrategyæ˜¯spring securityå®‰å…¨ä¸Šä¸‹æ–‡çš„å­˜å–ç­–ç•¥ã€‚SecurityContextHolderStrategyæ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼Œå¯¹åº”ä¸‰ç§å®ç°ç­–ç•¥ï¼š GlobalSecurityContextHolderStrategyï¼šä½¿ç”¨ ä¸€ä¸ªé™æ€å˜é‡å­˜æ”¾securityContext ThreadLocalSecurityContextHolderStrategyï¼šä½¿ç”¨ThreadLocalå­˜æ”¾securityContext InheritableThreadLocalSecurityContextHolderStrategyï¼šä½¿ç”¨InheritableThreadLocalå­˜æ”¾securityContextæ–­ç‚¹3é‚£æˆ‘å½“å‰ç¯å¢ƒé‡ŒSecurityContextHolderé‡Œä½¿ç”¨çš„æ˜¯å“ªä¸ªç­–ç•¥å‘¢ï¼Œæ‰“ä¸ªæ–­ç‚¹ æç„¶å¤§æ‚Ÿï¼ğŸ¤£åŸæ¥é‡‡ç”¨çš„æ˜¯ThreadLocalSecurityContextHolderStrategyè¿˜è®°å¾—æˆ‘å¼‚æ­¥æ”¹é€ é‡Œæ€ä¹ˆå†™çš„å—123456789CompletableFuture&lt;StoreDTO&gt; storeDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); return storeClient.getStoreDTO(userDTO.getStoreUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é—¨åº—ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š\", e); throw e; &#125; &#125;); æˆ‘å°†è°ƒç”¨feignè¯·æ±‚ä»£ç å†™åœ¨CompletableFuture.supplyAsync(()-&gt;{})ä¸­,è€ŒCompletableFutureé‡Œé»˜è®¤çº¿ç¨‹æ± ä¼šåˆ†é…æ–°çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥æ–°çº¿ç¨‹é‡Œæ˜¯æ²¡æœ‰securityContextçš„çº¿ç¨‹å‰¯æœ¬çš„ï¼æ‰€ä»¥åœ¨æ‹¦æˆªå™¨é‡Œæ‰ä¼šå–åˆ°ç©ºçš„securityContextï¼Œæœ€ç»ˆæŠ¥æœªæˆæƒç™»å½•å¼‚å¸¸ï¼bingoğŸ˜ æœ€ç»ˆå¼‚æ­¥ç‰ˆå…³é”®ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112logger.info(\"rpcè¯·æ±‚å¼€å§‹\"); long rpcstart = System.currentTimeMillis(); SecurityContext securityContext = SecurityContextHolder.getContext();//ä»å½“å‰è¯·æ±‚çº¿ç¨‹ä¸­æ‹¿åˆ°securityContextå®‰å…¨ä¸Šä¸‹æ–‡ Approval approvalFina = approval; CompletableFuture&lt;StoreDTO&gt; storeDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); SecurityContextHolder.setContext(securityContext); //è®¾ç½®securityContextå®‰å…¨ä¸Šä¸‹æ–‡çº¿ç¨‹å‰¯æœ¬ return storeClient.getStoreDTO(userDTO.getStoreUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é—¨åº—ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š\", e); throw e; &#125; &#125;); CompletableFuture&lt;StoreDTO&gt; inStoreDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getInStoreUuid())) &#123; SecurityContextHolder.setContext(securityContext); return storeClient.getStoreDTO(approvalFina.getInStoreUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–è½¬å…¥é—¨åº—ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;SupplierDTO&gt; supplierDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); SecurityContextHolder.setContext(securityContext); return supplierClient.getSupplierDTO(userDTO.getSupplierCode()); &#125; catch (Exception e) &#123; logger.error(\"è·å–ä¾›åº”å•†ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;StoreStaffDTO&gt; staffDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); SecurityContextHolder.setContext(securityContext); return staffClient.getStaffDTO(userDTO.getUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é—¨åº—å‘˜å·¥ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;CustomerInfoDTO&gt; customerInfoDTOCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); SecurityContextHolder.setContext(securityContext); return customerInfoClient.getCustomerInfo(approvalFina.getCustomerUuid()); &#125; catch (Exception e) &#123; logger.error(\"è·å–é¡¾å®¢ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;ServerDto&gt; serverDtoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getServerUuid())) &#123; SecurityContextHolder.setContext(securityContext); return serveClient.getServeSpecTypeByuuid(approvalFina.getServerUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–æœåŠ¡ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture&lt;CustAccountDto&gt; custAccountDtoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123; try &#123; logger.info(\"å½“å‰çº¿ç¨‹åï¼š&#123;&#125;\", Thread.currentThread().getName()); if (!ObjectUtils.isEmpty(approvalFina.getCustCardUuid())) &#123; SecurityContextHolder.setContext(securityContext); return accountClient.getCustAccount(approvalFina.getCustCardUuid()); &#125; return null; &#125; catch (Exception e) &#123; logger.error(\"è·å–é¡¾å®¢è´¦æˆ·ä¿¡æ¯rpcé”™è¯¯ï¼ŒåŸå› ï¼š&#123;&#125;\", e); throw e; &#125; &#125;); CompletableFuture.allOf(storeDTOCompletableFuture, inStoreDTOCompletableFuture, serverDtoCompletableFuture, supplierDTOCompletableFuture, staffDTOCompletableFuture, customerInfoDTOCompletableFuture, custAccountDtoCompletableFuture); StoreStaffDTO staffDTO = null;//å‘˜å·¥ä¿¡æ¯ SupplierDTO supplierDTO = null; //ä¾›åº”å•†ä¿¡æ¯ StoreDTO staffStoreDTO = null;//å‘˜å·¥æ‰€åœ¨é—¨åº—ä¿¡æ¯ CustomerInfoDTO customerInfoDTO = null; //é¡¾å®¢ä¿¡æ¯ StoreDTO inStoreDto = null;//é¡¾å®¢è½¬å…¥é—¨åº—ä¿¡æ¯ ServerDto serverDto = null; //æœåŠ¡ä¿¡æ¯ CustAccountDto custAccountDto = null; //é¡¾å®¢è´¦æˆ·ä¿¡æ¯ try &#123; staffStoreDTO = storeDTOCompletableFuture.get(); inStoreDto = inStoreDTOCompletableFuture.get(); staffDTO = staffDTOCompletableFuture.get(); supplierDTO = supplierDTOCompletableFuture.get(); customerInfoDTO = customerInfoDTOCompletableFuture.get(); serverDto = serverDtoCompletableFuture.get(); custAccountDto = custAccountDtoCompletableFuture.get(); &#125; catch (InterruptedException e) &#123; logger.error(\"çº¿ç¨‹ä¸­æ–­é”™è¯¯ä¿¡æ¯ï¼š&#123;&#125;\", e); &#125; catch (ExecutionException e) &#123; logger.error(\"çº¿ç¨‹æ‰§è¡Œé”™è¯¯ä¿¡æ¯ï¼š&#123;&#125;\", e); &#125; long rpcend = System.currentTimeMillis(); logger.info(\"rpcè¯·æ±‚ç»“æŸï¼Œè€—æ—¶ï¼š&#123;&#125;æ¯«ç§’\", (rpcend - rpcstart)); console å¯ä»¥çœ‹åˆ°rpcè¯·æ±‚çš„è€—æ—¶è¢«å¹³å‡ç¼©çŸ­åˆ°500æ¯«ç§’å†…ğŸ˜ CompletableFutureå­¦ä¹ å¯ä»¥çœ‹è¿™ç¯‡ğŸ‘‰here,æˆ‘è§‰å¾—è¿™ä½åšä¸»å†™çš„è¿˜è¡Œã€‚","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://cloudintheking.github.io/tags/å¾®æœåŠ¡/"}]},{"title":"å®‰è£…rabbitmqç¢°åˆ°çš„ä¸€äº›é”™è¯¯","slug":"å®‰è£…rabbitmqç¢°åˆ°çš„ä¸€äº›é”™è¯¯","date":"2018-08-25T07:25:44.000Z","updated":"2021-04-26T13:07:09.988Z","comments":true,"path":"posts/f1b4514.html","link":"","permalink":"https://cloudintheking.github.io/posts/f1b4514.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ å®‰è£…è¯·çœ‹æˆ‘çš„è¿™ç¯‡windowsä¸‹å®‰è£…rabbitmq the first and the last!!!ä½ è§‰å¾—rabbitmqæœåŠ¡å¯åŠ¨æ²¡æŠ¥é”™å°±å¤§åŠŸå‘Šæˆäº†ï¼Ÿnoï¼Œyouâ€™re so naiveæˆ‘å°è¯•run rabbitmq-plugin enable rabbitmq_managementæ¥å¼€å¯ç®¡ç†æ’ä»¶ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ‰“å¼€ç®¡ç†é¡µé¢ï¼Œè€Œä¸”rabbitmqctlçš„ç›¸å…³å‘½ä»¤ä¹Ÿéƒ½æŠ¥é”™ã€‚ä¸ºæ­¤æˆ‘ç¿»éäº†å›½å†…å¤§å¤§å°å°çš„è®ºå›åšå®¢ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯äº”èŠ±å…«é—¨ï¼Œä½†ä»ä¸èƒ½å®Œå…¨è§£å†³æˆ‘çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘å¼€å§‹æ€€ç–‘äººç”Ÿã€‚å½“æˆ‘ä¸€ç­¹è«å±•æ—¶ï¼Œæˆ‘ç•™æ„åˆ°å…¶ä¸­ä¸€ä¸ªé”™è¯¯run rabbitmqctl statusæ—¶,é”™è¯¯æç¤ºæ˜¯è¿™æ ·çš„ï¼š1Starting node rabbit@DESKTOP-0S1RKNE ... ** (ArgumentError) argument error (stdlib) io_lib.erl:170: :io_lib.format(' * effective user\\'s home directory: ~s~n', [[67, 58, 92, 85, 115, 101, 114, 115, 92, 19975, 23480, 26827]]) src/rabbit_misc.erl:670: :rabbit_misc.\"-format_many/1-lc$^0/1-0-\"/1 src/rabbit_misc.erl:670: :rabbit_misc.\"-format_many/1-lc$^0/1-0-\"/1 src/rabbit_misc.erl:670: :rabbit_misc.format_many/1 (rabbitmqctl) lib/rabbitmqctl.ex:349: RabbitMQCtl.get_node_diagnostics/1 (rabbitmqctl) lib/rabbitmqctl.ex:307: RabbitMQCtl.format_error/3 (rabbitmqctl) lib/rabbitmqctl.ex:43: RabbitMQCtl.main/1 (elixir) lib/kernel/cli.ex:76: anonymous fn/3 in Kernel.CLI.exec_fun/2 çœ‹å­—é¢æ„æ€æ˜¯æˆ‘å‚æ•°é”™è¯¯ï¼Œæˆ‘ä¸€å¼€å§‹æ²¡æ˜ç™½ä»€ä¹ˆæ„æ€ç›´åˆ°æˆ‘åœ¨stack overflow ä¸Šçœ‹åˆ°è·Ÿæˆ‘åŒæ ·çš„é”™è¯¯ï¼Œä¸åƒå›½å†…è®ºå›ä¸Šå°½è¯´äº›æœ‰çš„æ²¡çš„ï¼Œäººè€å¤–å°±ç®€å•çš„è¿™ä¹ˆä¸€å¥ å¦‚æœä½ çš„ç”¨æˆ·åä¸æ˜¯è‹±æ–‡ï¼ŒæŠŠå®ƒæ”¹æˆè‹±æ–‡ã€‚ å†å›é¡¾ä¸‹é”™è¯¯æç¤ºï¼ŒåŸæ¥æ˜¯è·¯å¾„å‚æ•°é”™äº†ã€‚å”‰ï¼Œå•¥ä¹Ÿä¸è¯´äº†ï¼Œæ‚”ä¸å½“åˆå•Šï¼Œå°±ä¸è¯¥è®¾ç½®ä¸­æ–‡ç”¨æˆ·åï¼ï¼ å¦‚ä½•ä¿®æ”¹ç”¨æˆ·ååŠç”¨æˆ·æ–‡ä»¶å¤¹åï¼Œæˆ‘æ˜¯å‚è€ƒè¿™ç¯‡åšæ–‡çš„https://blog.csdn.net/zhang_jinhe/article/details/40624847ç„¶åå¸è½½rabbitmqé‡è£…ï¼Œæ‰€æœ‰é—®é¢˜éƒ½è§£å†³äº†âœŒ feelingæˆ‘ä»¬å¾€å¾€è®¤ä¸ºé”™è¯¯å¤šæ˜¯å› ä¸ºé”™è¯¯å› ç´ å¤šï¼Œä½†å…¶å®ä¸€ä¸ªé”™è¯¯å¾€å¾€æ˜¯ç”±å¦ä¸€ä¸ªé”™è¯¯å¼•èµ·çš„ï¼Œå®ƒæœ¬èº«å…¶å®å¹¶ä¸æ˜¯é”™è¯¯å› ç´ ã€‚æ‰€ä»¥åœ¨è§£å†³é—®é¢˜çš„æ—¶å€™ï¼Œä¸èƒ½ç›²ç›®åœ°ä¼å›¾å»æŸ¥æ‰¾æ‰€æœ‰é”™è¯¯å› ç´ ï¼Œè€Œæ˜¯åº”è¯¥èŠ±æ—¶é—´å»æ‰¾åˆ°é‚£ä¸ªå…³é”®å› ç´ ï¼Œè§£å†³å®ƒï¼Œé‚£å‰©ä¸‹çš„é”™è¯¯å°±æ‚‰æ•°è§£å†³äº†ã€‚moreoverï¼Œè‹±è¯­èƒ½åŠ›ä¹Ÿå¾ˆé‡è¦å“ˆğŸ˜„","categories":[{"name":"é—®é¢˜æ€»ç»“ç¯‡","slug":"é—®é¢˜æ€»ç»“ç¯‡","permalink":"https://cloudintheking.github.io/categories/é—®é¢˜æ€»ç»“ç¯‡/"}],"tags":[{"name":"rabbitmq","slug":"rabbitmq","permalink":"https://cloudintheking.github.io/tags/rabbitmq/"}]},{"title":"windowsä¸‹å®‰è£…rabbitmq","slug":"windowsä¸‹å®‰è£…rabbitmq","date":"2018-08-25T06:32:17.000Z","updated":"2021-04-26T13:07:09.982Z","comments":true,"path":"posts/cb85a86.html","link":"","permalink":"https://cloudintheking.github.io/posts/cb85a86.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ erlang rabbitmqæ˜¯åŸºäºerlangå¼€å‘ï¼Œå®‰è£…rabbitmqå‰å¿…é¡»å®‰è£…erlangç¯å¢ƒ ä¸‹è½½erlang20.1å¹¶å®‰è£… å®‰è£…ååˆ‡è®°é…ç½®ç¯å¢ƒå˜é‡ï¼Œæ–°å»ºç³»ç»Ÿç¯å¢ƒå˜é‡ERLANG_HOME,å€¼ä¸ºä½ erlangçš„å®‰è£…è·¯å¾„(å¦‚F:\\Environment\\erl9.1),ç„¶åå‘ç³»ç»Ÿç¯å¢ƒå˜é‡pathè¿½åŠ å†…å®¹%ERLANG_HOME%\\bin rabbitmqå®‰è£… ä¸‹è½½rabbitmq3.7.3å¹¶å®‰è£… erlangå’Œrabbitmqä¸åŒç‰ˆæœ¬é—´æ­é…å¯èƒ½å­˜åœ¨bugï¼Œä½†è‡³å°‘æˆ‘è£…çš„erlang20.1å’Œrabbitmq3.7.3æ˜¯æ²¡é—®é¢˜çš„ ç¯å¢ƒå˜é‡æ–°å»ºç³»ç»Ÿç¯å¢ƒå˜é‡RABBITMQ_SERVER,å€¼ä¸ºä½ rabbitmqçš„å®‰è£…è·¯å¾„(å¦‚F:\\Environment\\RabbitMQ\\rabbitmq_server-3.7.3),ç„¶åå‘ç³»ç»Ÿç¯å¢ƒå˜é‡pathè¿½åŠ å†…å®¹%RABBITMQ_SERVER%\\sbin åŒæ­¥Erlang Cookies è¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼Œrabbitmq çš„é›†ç¾¤èŠ‚ç‚¹å’Œå‘½ä»¤è¡Œå·¥å…·éƒ½æ˜¯ä½¿ç”¨äº†erlang cookiesæ¥ä½œä¸ºè®¤è¯çš„ è¿™ä¸ªcookieæ–‡ä»¶æœ‰ä¸¤ä»½ï¼Œè¿™ä¸¤ä»½cookieå†…å®¹è¦ä¿æŒä¸€è‡´ erlang20.2ä¹‹å‰ï¼š ä¸€ä»½åœ¨C:\\Users\\%USERNAME%\\.erlang.cookie ä¸€ä»½åœ¨C:\\Windows\\.erlang.cookie erlang20.2ä¹‹åï¼š ä¸€ä»½åœ¨C:\\Users\\%USERNAME%\\.erlang.cookie ä¸€ä»½åœ¨C:\\WINDOWS\\system32\\config\\systemprofile\\.erlang.cookie å®‰è£…æœåŠ¡å¹¶è¿è¡Œrabbitmqåœ¨å®‰è£…æ—¶é»˜è®¤å¯åŠ¨äº†æœåŠ¡ï¼Œä½†è¿™ä¸ªæœåŠ¡å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚ä¸Šé¢è¯´çš„cookieè¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ä¾¿å¯åŠ¨äº†æœåŠ¡ï¼Œé‚£è¿™ä¸ªæœåŠ¡è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ã€‚ ç¬¬ä¸€æ­¥1234567#åˆ‡è®°ç®¡ç†å‘˜èº«ä»½f: #è¿›å…¥fç›˜cd F:\\Environment\\RabbitMQ\\rabbitmq_server-3.7.3\\sbin #è¿›å…¥rabbitmqæ‰¹å¤„ç†ç›®å½•rabbitmq-service stop #åœæ­¢rabbitmqæœåŠ¡rabbitmq-service remove #åˆ é™¤rabbitmqæœåŠ¡rabbitmq-service install #å®‰è£…rabbitmqæœåŠ¡rabbitmq-service start #å¯åŠ¨rabbitmqæœåŠ¡ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¬¬äºŒæ­¥1rabbitmqctl status #æŸ¥çœ‹rabbitmqæœåŠ¡å™¨çŠ¶æ€ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¬¬ä¸‰æ­¥1rabbitmq-plugins enable rabbitmq_management #å¼€å¯rabbitmqç®¡ç†æ’ä»¶ å¦‚æœä½ ä¹‹å‰å·²ç»å¼€å¯äº†æ’ä»¶ï¼Œé‚£ä¹ˆä¸ä¼šæœ‰å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚æœä½ ä¹‹å‰æ²¡æœ‰å¼€å¯æ’ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¬¬å››æ­¥12rabbitmq-service stop #åœæ­¢rabbitmqæœåŠ¡rabbitmq-service start #å¯åŠ¨rabbitmqæœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ æœ€ååœ¨æµè§ˆå™¨åœ°å€æ ä¸­è¾“å…¥http://localhost:15672ï¼Œæ‰“å¼€rabbitmqç®¡ç†ç™»å½•é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åï¼šguestï¼Œå¯†ç ï¼šguest æ›´å¤šrabbitmqçš„è¯¦ç»†å®‰è£…ä»‹ç»ï¼Œsee manualï¼Œä»¥åæœ‰ç©ºæˆ‘ä¼šç¿»è¯‘ä¸‹è¿™ç¯‡æ–‡ç« (^_^)","categories":[{"name":"ç¯å¢ƒå®‰è£…ç¯‡","slug":"ç¯å¢ƒå®‰è£…ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¯å¢ƒå®‰è£…ç¯‡/"}],"tags":[{"name":"rabbitmq","slug":"rabbitmq","permalink":"https://cloudintheking.github.io/tags/rabbitmq/"}]},{"title":"AVLæ ‘ä¹‹c++å®ç°","slug":"AVLæ ‘ä¹‹c-å®ç°","date":"2018-08-18T11:01:11.000Z","updated":"2021-04-26T13:07:09.998Z","comments":true,"path":"posts/942112fa.html","link":"","permalink":"https://cloudintheking.github.io/posts/942112fa.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ å¤´æ–‡ä»¶AVLTree.h123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103#ifndef _AVL_TREE_HPP_#define _AVL_TREE_HPP_template &lt;class T&gt;class AVLTreeNode&#123; public: T key; // å…³é”®å­—(é”®å€¼) int height; // é«˜åº¦ AVLTreeNode *left; // å·¦å­©å­ AVLTreeNode *right; // å³å­©å­ AVLTreeNode(T value, AVLTreeNode *l, AVLTreeNode *r): key(value), height(0),left(l),right(r)&#123;&#125;&#125;;template &lt;class T&gt;class AVLTree &#123; private: AVLTreeNode&lt;T&gt; *mRoot; // æ ¹ç»“ç‚¹ public: AVLTree(); ~AVLTree(); // è·å–æ ‘çš„é«˜åº¦ int height(); // è·å–æ ‘çš„é«˜åº¦ int max(int a, int b); // å‰åºéå†\"AVLæ ‘\" void preOrder(); // ä¸­åºéå†\"AVLæ ‘\" void inOrder(); // ååºéå†\"AVLæ ‘\" void postOrder(); // (é€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ AVLTreeNode&lt;T&gt;* search(T key); // (éé€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ AVLTreeNode&lt;T&gt;* iterativeSearch(T key); // æŸ¥æ‰¾æœ€å°ç»“ç‚¹ï¼šè¿”å›æœ€å°ç»“ç‚¹çš„é”®å€¼ã€‚ T minimum(); // æŸ¥æ‰¾æœ€å¤§ç»“ç‚¹ï¼šè¿”å›æœ€å¤§ç»“ç‚¹çš„é”®å€¼ã€‚ T maximum(); // å°†ç»“ç‚¹(keyä¸ºèŠ‚ç‚¹é”®å€¼)æ’å…¥åˆ°AVLæ ‘ä¸­ void insert(T key); // åˆ é™¤ç»“ç‚¹(keyä¸ºèŠ‚ç‚¹é”®å€¼) void remove(T key); // é”€æ¯AVLæ ‘ void destroy(); // æ‰“å°AVLæ ‘ void print(); private: // è·å–æ ‘çš„é«˜åº¦ int height(AVLTreeNode&lt;T&gt;* tree) ; // å‰åºéå†\"AVLæ ‘\" void preOrder(AVLTreeNode&lt;T&gt;* tree) const; // ä¸­åºéå†\"AVLæ ‘\" void inOrder(AVLTreeNode&lt;T&gt;* tree) const; // ååºéå†\"AVLæ ‘\" void postOrder(AVLTreeNode&lt;T&gt;* tree) const; // (é€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘x\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ AVLTreeNode&lt;T&gt;* search(AVLTreeNode&lt;T&gt;* x, T key) const; // (éé€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘x\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ AVLTreeNode&lt;T&gt;* iterativeSearch(AVLTreeNode&lt;T&gt;* x, T key) const; // æŸ¥æ‰¾æœ€å°ç»“ç‚¹ï¼šè¿”å›treeä¸ºæ ¹ç»“ç‚¹çš„AVLæ ‘çš„æœ€å°ç»“ç‚¹ã€‚ AVLTreeNode&lt;T&gt;* minimum(AVLTreeNode&lt;T&gt;* tree); // æŸ¥æ‰¾æœ€å¤§ç»“ç‚¹ï¼šè¿”å›treeä¸ºæ ¹ç»“ç‚¹çš„AVLæ ‘çš„æœ€å¤§ç»“ç‚¹ã€‚ AVLTreeNode&lt;T&gt;* maximum(AVLTreeNode&lt;T&gt;* tree); // LLï¼šå·¦å·¦å¯¹åº”çš„æƒ…å†µ(å·¦å•æ—‹è½¬)ã€‚ AVLTreeNode&lt;T&gt;* leftLeftRotation(AVLTreeNode&lt;T&gt;* k2); // RRï¼šå³å³å¯¹åº”çš„æƒ…å†µ(å³å•æ—‹è½¬)ã€‚ AVLTreeNode&lt;T&gt;* rightRightRotation(AVLTreeNode&lt;T&gt;* k1); // LRï¼šå·¦å³å¯¹åº”çš„æƒ…å†µ(å·¦åŒæ—‹è½¬)ã€‚ AVLTreeNode&lt;T&gt;* leftRightRotation(AVLTreeNode&lt;T&gt;* k3); // RLï¼šå³å·¦å¯¹åº”çš„æƒ…å†µ(å³åŒæ—‹è½¬)ã€‚ AVLTreeNode&lt;T&gt;* rightLeftRotation(AVLTreeNode&lt;T&gt;* k1); // å°†ç»“ç‚¹(z)æ’å…¥åˆ°AVLæ ‘(tree)ä¸­ AVLTreeNode&lt;T&gt;* insert(AVLTreeNode&lt;T&gt;* &amp;tree, T key); // åˆ é™¤AVLæ ‘(tree)ä¸­çš„ç»“ç‚¹(z)ï¼Œå¹¶è¿”å›è¢«åˆ é™¤çš„ç»“ç‚¹ AVLTreeNode&lt;T&gt;* remove(AVLTreeNode&lt;T&gt;* &amp;tree, AVLTreeNode&lt;T&gt;* z); // é”€æ¯AVLæ ‘ void destroy(AVLTreeNode&lt;T&gt;* &amp;tree); // æ‰“å°AVLæ ‘ void print(AVLTreeNode&lt;T&gt;* tree, T key, int direction);&#125;;#endif æºæ–‡ä»¶ AVLTree.cpp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464#include \"AVLTree.h\"#include &lt;iomanip&gt;#include &lt;iostream&gt;using namespace std;/* * æ„é€ å‡½æ•° */template &lt;class T&gt;AVLTree&lt;T&gt;::AVLTree():mRoot(NULL)&#123;&#125;/* * ææ„å‡½æ•° */template &lt;class T&gt;AVLTree&lt;T&gt;::~AVLTree() &#123; destroy(mRoot);&#125;/* * è·å–æ ‘çš„é«˜åº¦ */template &lt;class T&gt;int AVLTree&lt;T&gt;::height(AVLTreeNode&lt;T&gt;* tree) &#123; if (tree != NULL) return tree-&gt;height; return 0;&#125;template &lt;class T&gt;int AVLTree&lt;T&gt;::height() &#123; return height(mRoot);&#125;/* * æ¯”è¾ƒä¸¤ä¸ªå€¼çš„å¤§å° */template &lt;class T&gt;int AVLTree&lt;T&gt;::max(int a, int b) &#123; return a&gt;b ? a : b;&#125;/* * å‰åºéå†\"AVLæ ‘\" */template &lt;class T&gt;void AVLTree&lt;T&gt;::preOrder(AVLTreeNode&lt;T&gt;* tree) const&#123; if(tree != NULL) &#123; cout&lt;&lt; tree-&gt;key &lt;&lt; \" \" ; preOrder(tree-&gt;left); preOrder(tree-&gt;right); &#125;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::preOrder() &#123; preOrder(mRoot);&#125;/* * ä¸­åºéå†\"AVLæ ‘\" */template &lt;class T&gt;void AVLTree&lt;T&gt;::inOrder(AVLTreeNode&lt;T&gt;* tree) const&#123; if(tree != NULL) &#123; inOrder(tree-&gt;left); cout&lt;&lt; tree-&gt;key &lt;&lt; \" \" ; inOrder(tree-&gt;right); &#125;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::inOrder() &#123; inOrder(mRoot);&#125;/* * ååºéå†\"AVLæ ‘\" */template &lt;class T&gt;void AVLTree&lt;T&gt;::postOrder(AVLTreeNode&lt;T&gt;* tree) const&#123; if(tree != NULL) &#123; postOrder(tree-&gt;left); postOrder(tree-&gt;right); cout&lt;&lt; tree-&gt;key &lt;&lt; \" \" ; &#125;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::postOrder() &#123; postOrder(mRoot);&#125;/* * (é€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘x\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::search(AVLTreeNode&lt;T&gt;* x, T key) const&#123; if (x==NULL || x-&gt;key==key) return x; if (key &lt; x-&gt;key) return search(x-&gt;left, key); else return search(x-&gt;right, key);&#125;template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::search(T key) &#123; return search(mRoot, key);&#125;/* * (éé€’å½’å®ç°)æŸ¥æ‰¾\"AVLæ ‘x\"ä¸­é”®å€¼ä¸ºkeyçš„èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::iterativeSearch(AVLTreeNode&lt;T&gt;* x, T key) const&#123; while ((x!=NULL) &amp;&amp; (x-&gt;key!=key)) &#123; if (key &lt; x-&gt;key) x = x-&gt;left; else x = x-&gt;right; &#125; return x;&#125;template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::iterativeSearch(T key)&#123; return iterativeSearch(mRoot, key);&#125;/* * æŸ¥æ‰¾æœ€å°ç»“ç‚¹ï¼šè¿”å›treeä¸ºæ ¹ç»“ç‚¹çš„AVLæ ‘çš„æœ€å°ç»“ç‚¹ã€‚ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::minimum(AVLTreeNode&lt;T&gt;* tree)&#123; if (tree == NULL) return NULL; while(tree-&gt;left != NULL) tree = tree-&gt;left; return tree;&#125;template &lt;class T&gt;T AVLTree&lt;T&gt;::minimum()&#123; AVLTreeNode&lt;T&gt; *p = minimum(mRoot); if (p != NULL) return p-&gt;key; return (T)NULL;&#125; /* * æŸ¥æ‰¾æœ€å¤§ç»“ç‚¹ï¼šè¿”å›treeä¸ºæ ¹ç»“ç‚¹çš„AVLæ ‘çš„æœ€å¤§ç»“ç‚¹ã€‚ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::maximum(AVLTreeNode&lt;T&gt;* tree)&#123; if (tree == NULL) return NULL; while(tree-&gt;right != NULL) tree = tree-&gt;right; return tree;&#125;template &lt;class T&gt;T AVLTree&lt;T&gt;::maximum()&#123; AVLTreeNode&lt;T&gt; *p = maximum(mRoot); if (p != NULL) return p-&gt;key; return (T)NULL;&#125;/* * LLï¼šå·¦å·¦å¯¹åº”çš„æƒ…å†µ(å·¦å•æ—‹è½¬)ã€‚ * * è¿”å›å€¼ï¼šæ—‹è½¬åçš„æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::leftLeftRotation(AVLTreeNode&lt;T&gt;* k2)&#123; AVLTreeNode&lt;T&gt;* k1=k2-&gt;left; k2-&gt;left=k1-&gt;right; k1-&gt;right=k2; k2-&gt;height=max(height(k2-&gt;left),height(k2-&gt;right))+1; k1-&gt;height=max(height(k1-&gt;left),height(k1-&gt;right))+1; return k1;&#125;/* * RRï¼šå³å³å¯¹åº”çš„æƒ…å†µ(å³å•æ—‹è½¬)ã€‚ * * è¿”å›å€¼ï¼šæ—‹è½¬åçš„æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::rightRightRotation(AVLTreeNode&lt;T&gt;* k1)&#123; AVLTreeNode&lt;T&gt;* k2=k1-&gt;right; k1-&gt;right=k2-&gt;left; k2-&gt;left=k1; k1-&gt;height=max(height(k1-&gt;left),height(k1-&gt;right))+1; k2-&gt;height=max(height(k2-&gt;left),height(k2-&gt;right))+1; return k2;&#125;/* * LRï¼šå·¦å³å¯¹åº”çš„æƒ…å†µ(å·¦åŒæ—‹è½¬)ã€‚ * * è¿”å›å€¼ï¼šæ—‹è½¬åçš„æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::leftRightRotation(AVLTreeNode&lt;T&gt;* k3)&#123; k3-&gt;left=rightRightRotation(k3-&gt;left); return leftLeftRotation(k3);&#125;/* * RLï¼šå³å·¦å¯¹åº”çš„æƒ…å†µ(å³åŒæ—‹è½¬)ã€‚ * * è¿”å›å€¼ï¼šæ—‹è½¬åçš„æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::rightLeftRotation(AVLTreeNode&lt;T&gt;* k1)&#123; k1-&gt;right = leftLeftRotation(k1-&gt;right); return rightRightRotation(k1);&#125;/* * å°†ç»“ç‚¹æ’å…¥åˆ°AVLæ ‘ä¸­ï¼Œå¹¶è¿”å›æ ¹èŠ‚ç‚¹ * * å‚æ•°è¯´æ˜ï¼š * tree AVLæ ‘çš„æ ¹ç»“ç‚¹ * key æ’å…¥çš„ç»“ç‚¹çš„é”®å€¼ * è¿”å›å€¼ï¼š * æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::insert(AVLTreeNode&lt;T&gt;* &amp;tree, T key)&#123; if (tree == NULL) &#123; // æ–°å»ºèŠ‚ç‚¹ tree = new AVLTreeNode&lt;T&gt;(key, NULL, NULL); if (tree==NULL) &#123; cout &lt;&lt; \"ERROR: create avltree node failed!\" &lt;&lt; endl; return NULL; &#125; &#125; else if (key &lt; tree-&gt;key) // åº”è¯¥å°†keyæ’å…¥åˆ°\"treeçš„å·¦å­æ ‘\"çš„æƒ…å†µ &#123; tree-&gt;left = insert(tree-&gt;left, key); // æ’å…¥èŠ‚ç‚¹åï¼Œè‹¥AVLæ ‘å¤±å»å¹³è¡¡ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„è°ƒèŠ‚ã€‚ if (height(tree-&gt;left) - height(tree-&gt;right) == 2) &#123; if (key &lt; tree-&gt;left-&gt;key) tree = leftLeftRotation(tree); else tree = leftRightRotation(tree); &#125; &#125; else if (key &gt; tree-&gt;key) // åº”è¯¥å°†keyæ’å…¥åˆ°\"treeçš„å³å­æ ‘\"çš„æƒ…å†µ &#123; tree-&gt;right = insert(tree-&gt;right, key); // æ’å…¥èŠ‚ç‚¹åï¼Œè‹¥AVLæ ‘å¤±å»å¹³è¡¡ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„è°ƒèŠ‚ã€‚ if (height(tree-&gt;right) - height(tree-&gt;left) == 2) &#123; if (key &gt; tree-&gt;right-&gt;key) tree = rightRightRotation(tree); else tree = rightLeftRotation(tree); &#125; &#125; else //key == tree-&gt;key) &#123; cout &lt;&lt; \"æ·»åŠ å¤±è´¥ï¼šä¸å…è®¸æ·»åŠ ç›¸åŒçš„èŠ‚ç‚¹ï¼\" &lt;&lt; endl; &#125; tree-&gt;height = max( height(tree-&gt;left), height(tree-&gt;right)) + 1; return tree;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::insert(T key)&#123; insert(mRoot, key);&#125;/* * åˆ é™¤ç»“ç‚¹(z)ï¼Œè¿”å›æ ¹èŠ‚ç‚¹ * * å‚æ•°è¯´æ˜ï¼š * tree AVLæ ‘çš„æ ¹ç»“ç‚¹ * z å¾…åˆ é™¤çš„ç»“ç‚¹ * è¿”å›å€¼ï¼š * æ ¹èŠ‚ç‚¹ */template &lt;class T&gt;AVLTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::remove(AVLTreeNode&lt;T&gt;* &amp;tree, AVLTreeNode&lt;T&gt;* z)&#123; // æ ¹ä¸ºç©º æˆ–è€… æ²¡æœ‰è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›NULLã€‚ if (tree==NULL || z==NULL) return NULL; if (z-&gt;key &lt; tree-&gt;key) // å¾…åˆ é™¤çš„èŠ‚ç‚¹åœ¨\"treeçš„å·¦å­æ ‘\"ä¸­ &#123; tree-&gt;left = remove(tree-&gt;left, z); // åˆ é™¤èŠ‚ç‚¹åï¼Œè‹¥AVLæ ‘å¤±å»å¹³è¡¡ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„è°ƒèŠ‚ã€‚ if (height(tree-&gt;right) - height(tree-&gt;left) == 2) &#123; AVLTreeNode&lt;T&gt; *r = tree-&gt;right; if (height(r-&gt;left) &gt; height(r-&gt;right)) tree = rightLeftRotation(tree); else tree = rightRightRotation(tree); &#125; &#125; else if (z-&gt;key &gt; tree-&gt;key)// å¾…åˆ é™¤çš„èŠ‚ç‚¹åœ¨\"treeçš„å³å­æ ‘\"ä¸­ &#123; tree-&gt;right = remove(tree-&gt;right, z); // åˆ é™¤èŠ‚ç‚¹åï¼Œè‹¥AVLæ ‘å¤±å»å¹³è¡¡ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„è°ƒèŠ‚ã€‚ if (height(tree-&gt;left) - height(tree-&gt;right) == 2) &#123; AVLTreeNode&lt;T&gt; *l = tree-&gt;left; if (height(l-&gt;right) &gt; height(l-&gt;left)) tree = leftRightRotation(tree); else tree = leftLeftRotation(tree); &#125; &#125; else // treeæ˜¯å¯¹åº”è¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚ &#123; // treeçš„å·¦å³å­©å­éƒ½éç©º if ((tree-&gt;left!=NULL) &amp;&amp; (tree-&gt;right!=NULL)) &#123; if (height(tree-&gt;left) &gt; height(tree-&gt;right)) &#123; // å¦‚æœtreeçš„å·¦å­æ ‘æ¯”å³å­æ ‘é«˜ï¼› // åˆ™(01)æ‰¾å‡ºtreeçš„å·¦å­æ ‘ä¸­çš„æœ€å¤§èŠ‚ç‚¹ // (02)å°†è¯¥æœ€å¤§èŠ‚ç‚¹çš„å€¼èµ‹å€¼ç»™treeã€‚ // (03)åˆ é™¤è¯¥æœ€å¤§èŠ‚ç‚¹ã€‚ // è¿™ç±»ä¼¼äºç”¨\"treeçš„å·¦å­æ ‘ä¸­æœ€å¤§èŠ‚ç‚¹\"åš\"tree\"çš„æ›¿èº«ï¼› // é‡‡ç”¨è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼šåˆ é™¤\"treeçš„å·¦å­æ ‘ä¸­æœ€å¤§èŠ‚ç‚¹\"ä¹‹åï¼ŒAVLæ ‘ä»ç„¶æ˜¯å¹³è¡¡çš„ã€‚ AVLTreeNode&lt;T&gt;* max = maximum(tree-&gt;left); tree-&gt;key = max-&gt;key; tree-&gt;left = remove(tree-&gt;left, max); &#125; else &#123; // å¦‚æœtreeçš„å·¦å­æ ‘ä¸æ¯”å³å­æ ‘é«˜(å³å®ƒä»¬ç›¸ç­‰ï¼Œæˆ–å³å­æ ‘æ¯”å·¦å­æ ‘é«˜1) // åˆ™(01)æ‰¾å‡ºtreeçš„å³å­æ ‘ä¸­çš„æœ€å°èŠ‚ç‚¹ // (02)å°†è¯¥æœ€å°èŠ‚ç‚¹çš„å€¼èµ‹å€¼ç»™treeã€‚ // (03)åˆ é™¤è¯¥æœ€å°èŠ‚ç‚¹ã€‚ // è¿™ç±»ä¼¼äºç”¨\"treeçš„å³å­æ ‘ä¸­æœ€å°èŠ‚ç‚¹\"åš\"tree\"çš„æ›¿èº«ï¼› // é‡‡ç”¨è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼šåˆ é™¤\"treeçš„å³å­æ ‘ä¸­æœ€å°èŠ‚ç‚¹\"ä¹‹åï¼ŒAVLæ ‘ä»ç„¶æ˜¯å¹³è¡¡çš„ã€‚ AVLTreeNode&lt;T&gt;* min = maximum(tree-&gt;right); tree-&gt;key = min-&gt;key; tree-&gt;right = remove(tree-&gt;right, min); &#125; &#125; else &#123; AVLTreeNode&lt;T&gt;* tmp = tree; tree = (tree-&gt;left!=NULL) ? tree-&gt;left : tree-&gt;right; delete tmp; &#125; &#125; return tree;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::remove(T key)&#123; AVLTreeNode&lt;T&gt;* z; if ((z = search(mRoot, key)) != NULL) mRoot = remove(mRoot, z);&#125;/* * é”€æ¯AVLæ ‘ */template &lt;class T&gt;void AVLTree&lt;T&gt;::destroy(AVLTreeNode&lt;T&gt;* &amp;tree)&#123; if (tree==NULL) return ; if (tree-&gt;left != NULL) destroy(tree-&gt;left); if (tree-&gt;right != NULL) destroy(tree-&gt;right); delete tree;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::destroy()&#123; destroy(mRoot);&#125;/* * æ‰“å°\"äºŒå‰æŸ¥æ‰¾æ ‘\" * *key -- èŠ‚ç‚¹çš„é”®å€¼ *direction -- 0ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹; * -1ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯å®ƒçš„çˆ¶ç»“ç‚¹çš„å·¦å­©å­; * 1ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯å®ƒçš„çˆ¶ç»“ç‚¹çš„å³å­©å­ã€‚ */template &lt;class T&gt;void AVLTree&lt;T&gt;::print(AVLTreeNode&lt;T&gt;* tree, T key, int direction)&#123; if(tree != NULL) &#123; if(direction==0) // treeæ˜¯æ ¹èŠ‚ç‚¹ cout &lt;&lt; setw(2) &lt;&lt; tree-&gt;key &lt;&lt; \" is root\" &lt;&lt;\", height is \"&lt;&lt;tree-&gt;height&lt;&lt; endl; else // treeæ˜¯åˆ†æ”¯èŠ‚ç‚¹ cout &lt;&lt; setw(2) &lt;&lt; tree-&gt;key &lt;&lt; \" is \" &lt;&lt; setw(2) &lt;&lt; key &lt;&lt; \"'s \" &lt;&lt; setw(12) &lt;&lt; (direction==1?\"right child\" : \"left child\") &lt;&lt;\", height is \"&lt;&lt;tree-&gt;height&lt;&lt; endl; print(tree-&gt;left, tree-&gt;key, -1); print(tree-&gt;right,tree-&gt;key, 1); &#125;&#125;template &lt;class T&gt;void AVLTree&lt;T&gt;::print()&#123; if (mRoot != NULL) print(mRoot, mRoot-&gt;key, 0);&#125; æµ‹è¯•æ–‡ä»¶ test.cpp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950#include &lt;iostream&gt;#include \"AVLTree.cpp\"using namespace std;static int arr[]= &#123;3,2,1,4,5,6,7,16,15,14,13,12,11,10,8,9&#125;;#define TBL_SIZE(a) ( (sizeof(a)) / (sizeof(a[0])) )int main()&#123; int i,ilen; AVLTree&lt;int&gt;* tree=new AVLTree&lt;int&gt;(); cout &lt;&lt; \"== ä¾æ¬¡æ·»åŠ : \"; ilen = TBL_SIZE(arr); for(i=0; i&lt;ilen; i++) &#123; cout &lt;&lt; arr[i] &lt;&lt;\" \"; tree-&gt;insert(arr[i]); &#125; cout &lt;&lt; \"\\n== å‰åºéå†: \"; tree-&gt;preOrder(); cout &lt;&lt; \"\\n== ä¸­åºéå†: \"; tree-&gt;inOrder(); cout &lt;&lt; \"\\n== ååºéå†: \"; tree-&gt;postOrder(); cout &lt;&lt; endl; cout &lt;&lt; \"== é«˜åº¦: \" &lt;&lt; tree-&gt;height() &lt;&lt; endl; cout &lt;&lt; \"== æœ€å°å€¼: \" &lt;&lt; tree-&gt;minimum() &lt;&lt; endl; cout &lt;&lt; \"== æœ€å¤§å€¼: \" &lt;&lt; tree-&gt;maximum() &lt;&lt; endl; cout &lt;&lt; \"== æ ‘çš„è¯¦ç»†ä¿¡æ¯: \" &lt;&lt; endl; tree-&gt;print(); i = 8; cout &lt;&lt; \"\\n== åˆ é™¤æ ¹èŠ‚ç‚¹: \" &lt;&lt; i; tree-&gt;remove(i); cout &lt;&lt; \"\\n== é«˜åº¦: \" &lt;&lt; tree-&gt;height() ; cout &lt;&lt; \"\\n== ä¸­åºéå†: \" ; tree-&gt;inOrder(); cout &lt;&lt; \"\\n== æ ‘çš„è¯¦ç»†ä¿¡æ¯: \" &lt;&lt; endl; tree-&gt;print(); // é”€æ¯äºŒå‰æ ‘ tree-&gt;destroy(); return 0;&#125;","categories":[{"name":"ç®—æ³•ç¯‡","slug":"ç®—æ³•ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç®—æ³•ç¯‡/"}],"tags":[{"name":"c++","slug":"c","permalink":"https://cloudintheking.github.io/tags/c/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"https://cloudintheking.github.io/tags/æ•°æ®ç»“æ„/"}]},{"title":"mongodbæ“ä½œä¹‹$slice","slug":"mongodbæ“ä½œä¹‹-slice","date":"2018-08-15T13:50:29.000Z","updated":"2021-04-26T13:07:09.982Z","comments":true,"path":"posts/9885f22a.html","link":"","permalink":"https://cloudintheking.github.io/posts/9885f22a.html","excerpt":"","text":"ç¿»è¯‘åŸæ–‡ï¼šhttps://docs.mongodb.com/manual/reference/operator/update/slice/#examples $sliceï¼ˆåˆ‡åˆ†ï¼‰å½“è¿›è¡Œ$push(æ’å…¥)æ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡ $sliceä¿®é¥°è¯æ¥é™åˆ¶æ’å…¥çš„æ•°ç»„å…ƒç´ ä¸ªæ•°ã€‚å¦‚æœæƒ³ä»ä¸€ä¸ªåªè¯»æ“ä½œä¸­æ˜ å°„æˆ–æ˜¯è¿”å›æ•°ç»„å…ƒç´ ä¸­ç‰¹å®šçš„å€¼ï¼Œè¯¦è§$sliceæ˜ å°„æ“ä½œã€‚$sliceä¿®é¥°è¯å¿…é¡»æ­é…$eachä¿®é¥°è¯æ‰èƒ½ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ç»™$eachä¿®é¥°è¯ï¼Œä»è€Œåªè®©$sliceä¿®é¥°è¯èµ·ä½œç”¨ã€‚12345678&#123; $push: &#123; &lt;field&gt;: &#123; $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ], $slice: &lt;num&gt; &#125; &#125;&#125; &lt; num &gt; çš„å€¼å¯ä»¥æ˜¯ï¼š Value Description 0 æ›´æ–°æ•°ç»„&lt;field&gt;ä¸ºç©ºæ•°ç»„ è´Ÿæ•° æ›´æ–°æ•°ç»„&lt;field&gt;åªåŒ…å«æœ€å&lt;num&gt;ä¸ªå…ƒç´  æ­£æ•° æ›´æ–°æ•°ç»„&lt;field&gt;åªåŒ…å«å¼€å¤´&lt;num&gt;ä¸ªå…ƒç´ ï¼Œé€‚ç”¨äº2.6ä»¥ä¸Šç‰ˆæœ¬ Behavior(è¡Œä¸º)è¿™äº›ä¿®é¥°è¯å‡ºç°çš„é¡ºåºæ˜¯æ— å…³ç´§è¦çš„ã€‚ä¸è¿‡åœ¨ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼Œè¦æ±‚$eachä¿®é¥°è¯å¾—ä½œä¸ºç¬¬ä¸€ä¸ªä¿®é¥°è¯å‡ºç°ï¼Œå¦‚æœè¦å’Œ$sliceä¿®é¥°è¯è¿ç”¨çš„è¯ã€‚è¿™é‡Œæœ‰ä¸€ä»½å…³äºå’Œ$pushæ­é…ä½¿ç”¨çš„ä¿®é¥°è¯åˆ—è¡¨ï¼Œè¯¦è§Modifiersã€‚ä¸ç»“åˆ$eachä¿®é¥°è¯è€Œåªä½¿ç”¨$sliceä¿®é¥°è¯å°†ä¼šå¯¼è‡´å‡ºé”™ï¼Œä¸ä¿¡å¯ä»¥è¯•è¯•ã€‚ æ —å­ä»æ•°ç»„æœ«å°¾åˆ‡ç‰‡ä¸€ä¸ªå­¦ç”Ÿé›†åˆåŒ…å«ä»¥ä¸‹æ–‡æ¡£ï¼š1&#123; \"_id\" : 1, \"scores\" : [ 40, 50, 60 ] &#125; ä¸‹é¢çš„æ“ä½œå¢åŠ ä¸€ä¸ªæ–°å…ƒç´ åˆ°scoresæ•°ç»„ä¸­ï¼Œç„¶åä½¿ç”¨$sliceå°†æ•°ç»„ä¿®å‰ªä¸ºæœ€åäº”ä¸ªå…ƒç´ ã€‚ 1234567891011db.students.update( &#123; _id: 1 &#125;, &#123; $push: &#123; scores: &#123; $each: [ 80, 78, 86 ], $slice: -5 &#125; &#125; &#125;) æ“ä½œçš„ç»“æœå°±æ˜¯å°†æ›´æ–°åçš„scoresæ•°ç»„åˆ‡åˆ†ä¸ºæœ€å5ä¸ªå…ƒç´ 1&#123; \"_id\" : 1, \"scores\" : [ 50, 60, 80, 78, 86 ] &#125; ä»æ•°ç»„å¤´éƒ¨åˆ‡ç‰‡ä¸€ä¸ªå­¦ç”Ÿé›†åˆåŒ…å«ä»¥ä¸‹æ–‡æ¡£ï¼š1&#123; \"_id\" : 2, \"scores\" : [ 89, 90 ] &#125; ä¸‹é¢çš„æ“ä½œå¢åŠ ä¸€ä¸ªæ–°å…ƒç´ åˆ°scoresæ•°ç»„ä¸­ï¼Œç„¶åä½¿ç”¨$sliceä¿®é¥°è¯ä¿®å‰ªä¸ºå‰ä¸‰ä¸ªå…ƒç´ ã€‚1234567891011db.students.update( &#123; _id: 2 &#125;, &#123; $push: &#123; scores: &#123; $each: [ 100, 20 ], $slice: 3 &#125; &#125; &#125;) æ“ä½œçš„ç»“æœå°±æ˜¯å°†æ›´æ–°åçš„scoresæ•°ç»„åˆ‡åˆ†ä¸ºå‰ä¸‰ä¸ªå…ƒç´ ä¸­ã€‚ åªç”¨sliceæ¥æ›´æ–°æ•°ç»„ä¸€ä¸ªå­¦ç”Ÿé›†åˆåŒ…å«ä»¥ä¸‹æ–‡æ¡£ï¼š1&#123; \"_id\" : 3, \"scores\" : [ 89, 70, 100, 20 ] &#125; ä¸ºäº†åªç”¨$sliceä¿®é¥°è¯æ¥æ›´æ–°scoreså­—æ®µï¼Œæˆ‘ä»¬å¾—ç»™å‡ºè¦åˆ‡åˆ†çš„å…ƒç´ æ•°é‡ï¼ˆæ¯”å¦‚ -3ï¼‰èµ‹ç»™sliceä¿®é¥°è¯,è€Œä¸”èµ‹ä¸€ä¸ªç©ºæ•°ç»„ç»™$eachä¿®é¥°è¯ï¼Œå°±åƒä¸‹é¢çš„ä»£ç ï¼š1234567891011db.students.update( &#123; _id: 3 &#125;, &#123; $push: &#123; scores: &#123; $each: [ ], $slice: -3 &#125; &#125; &#125;) æ“ä½œçš„ç»“æœå°±æ˜¯å°†scoresæ•°ç»„åˆ‡åˆ†ä¸ºæœ€åä¸‰ä¸ªå…ƒç´ ã€‚ slice å’Œpushæ­é…ä½¿ç”¨ä¸€ä¸ªå­¦ç”Ÿé›†åˆåŒ…å«ä»¥ä¸‹æ–‡æ¡£ï¼š123456789&#123; \"_id\" : 5, \"quizzes\" : [ &#123; \"wk\": 1, \"score\" : 10 &#125;, &#123; \"wk\": 2, \"score\" : 8 &#125;, &#123; \"wk\": 3, \"score\" : 5 &#125;, &#123; \"wk\": 4, \"score\" : 6 &#125; ]&#125; ä¸‹é¢çš„$pushæ“ä½œå°†ä¼šï¼š ä½¿ç”¨$eachä¿®é¥°è¯æ¥å¢åŠ å¤šä¸ªæ–‡æ¡£åˆ°quizzesæ•°ç»„ä¸­ï¼Œ ä½¿ç”¨$sortä¿®é¥°è¯ï¼ŒæŒ‰ç…§scoreå­—æ®µæ¥é™åºæ’åºä¿®æ”¹è¿‡çš„quizziesæ•°ç»„ä¸­çš„å…¨éƒ¨å…ƒç´ ï¼Œ ä½¿ç”¨$sliceä¿®é¥°è¯ï¼Œåªä¿ç•™quizzesæ•°æ’ä¸­å‰ä¸‰ä¸ªæ’åºè¿‡çš„å…ƒç´ ã€‚ 123456789101112db.students.update( &#123; _id: 5 &#125;, &#123; $push: &#123; quizzes: &#123; $each: [ &#123; wk: 5, score: 8 &#125;, &#123; wk: 6, score: 7 &#125;, &#123; wk: 7, score: 6 &#125; ], $sort: &#123; score: -1 &#125;, $slice: 3 &#125; &#125; &#125;) æ“ä½œç»“æœå°±æ˜¯åªä¿ç•™äº†quizzesæ•°ç»„ä¸­åˆ†æ•°æœ€é«˜çš„ä¸‰ä¸ªå…ƒç´ ã€‚12345678&#123; \"_id\" : 5, \"quizzes\" : [ &#123; \"wk\" : 1, \"score\" : 10 &#125;, &#123; \"wk\" : 2, \"score\" : 8 &#125;, &#123; \"wk\" : 5, \"score\" : 8 &#125; ]&#125; ä¸Šé¢æ“ä½œä¸­çš„ä¿®é¥°è¯éƒ½ä¼šè¢«Mongodbè‡ªè¡Œå¤„ç†ï¼Œæ‰€æœ‰å®ƒä»¬ä¹‹é—´çš„ä¹¦å†™é¡ºåºæ— å…³ç´§è¦ã€‚æ›´å¤šè¯¦æƒ…è¯·è§Modifiersã€‚","categories":[{"name":"ç¿»è¯‘ç¯‡","slug":"ç¿»è¯‘ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¿»è¯‘ç¯‡/"}],"tags":[{"name":"mongodb","slug":"mongodb","permalink":"https://cloudintheking.github.io/tags/mongodb/"}]},{"title":"oracleä¹‹è¡¨ä¿¡æ¯æŸ¥è¯¢","slug":"oracleä¹‹è¡¨ä¿¡æ¯æŸ¥è¯¢","date":"2018-08-10T13:41:43.000Z","updated":"2021-04-26T13:07:09.977Z","comments":true,"path":"posts/915a4669.html","link":"","permalink":"https://cloudintheking.github.io/posts/915a4669.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ èµ·å› ä¸»ç®¡æŠ½é£ï¼Œæƒ³æŸ¥è¯¢æ•°æ®åº“â€™dboâ€˜ä¸­å„è¡¨å­—æ®µç»“æ„ã€å¤–é”®ä¿¡æ¯ã€ç´¢å¼•ä¿¡æ¯ã€‚äºæ˜¯ä»»åŠ¡äº¤ç»™äº†æˆ‘â€¦ è¯­å¥1234567891011121314151617181920212223242526272829303132333435363738394041424344-- å„è¡¨å­—æ®µç»“æ„SELECT TABLE_SCHEMA æ•°æ®åº“, table_name è¡¨å, column_name å­—æ®µå, data_type ç±»å‹, is_nullable æ˜¯å¦ä¸ºç©º, column_default é»˜è®¤å€¼FROM information_schema.columnsWHERE TABLE_SCHEMA = 'dbo'-- å„è¡¨å¤–é”®ä¿¡æ¯SELECT object_name(parent_object_id) è¡¨å, object_name(constraint_object_id) çº¦æŸåç§°, col_name(parent_object_id, parent_column_id) å¤–é”®å­—æ®µ, object_name(referenced_object_id) å…³è”è¡¨å, col_name(referenced_object_id, referenced_column_id) å…³è”è¡¨å­—æ®µFROM sys.foreign_key_columnsWHERE referenced_object_id IN ( SELECT object_id(T.table_name) FROM ( SELECT table_name FROM information_schema.columns WHERE TABLE_SCHEMA = 'dbo' ) T)ORDER BY object_name(parent_object_id)-- å„è¡¨ç´¢å¼•ä¿¡æ¯SELECT object_name(object_id) è¡¨å, name ç´¢å¼•å, is_unique æ˜¯å¦å”¯ä¸€FROM sys.indexesWHERE Object_id IN ( SELECT object_id(T.table_name) FROM ( SELECT table_name FROM information_schema.columns WHERE TABLE_SCHEMA = 'dbo' ) T)ORDER BY è¡¨å","categories":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://cloudintheking.github.io/categories/æ•°æ®åº“/"}],"tags":[{"name":"sql","slug":"sql","permalink":"https://cloudintheking.github.io/tags/sql/"}]},{"title":"oracleä¹‹å¤šè¡¨ç»Ÿè®¡æŸ¥è¯¢","slug":"oracleä¹‹å¤šè¡¨ç»Ÿè®¡æŸ¥è¯¢","date":"2018-08-09T13:58:40.000Z","updated":"2021-04-26T13:07:09.977Z","comments":true,"path":"posts/771d835a.html","link":"","permalink":"https://cloudintheking.github.io/posts/771d835a.html","excerpt":"","text":"èµ·å› ä¸»ç®¡æƒ³æ ¹æ®æ—¶é—´èŒƒå›´ç»Ÿè®¡ä¸‹å„æ ‡æ®µå„æ¡¥æ¢éƒ¨ä»¶çš„å½•å…¥æ•°é‡ï¼Œè¿™ä¸ªä»»åŠ¡å°±äº¤ç»™æˆ‘å§â€¦ è¡¨ä»‹ç» qr_code_item_typeï¼šæ¡¥æ¢éƒ¨ä»¶ç±»å‹è¡¨ï¼Œç±»å‹æœ‰æ¡©åŸºã€æ‰¿å°ã€å¢©æŸ±ç­‰ qr_code_item1 ï¼šæ¡¥æ¢å¢©æŸ±ç±»éƒ¨ä»¶ä¿¡æ¯è¡¨ï¼Œå…³è”è¡¨qr_code_item_typeã€qr_code_main qr_code_item2 ï¼šæ¡¥æ¢æ¢ç±»éƒ¨ä»¶ä¿¡æ¯è¡¨ï¼Œå…³è”è¡¨qr_code_item_typeã€qr_code_main qr_code_mainï¼šæ¡¥æ¢æ ‡æ®µè¡¨è¯­å¥1234567891011121314151617SELECT itype.id,isnull(total, 0) totalFROM qr_code_item_type itype LEFT JOIN ( SELECT item.item_type_id type,COUNT(*) total FROM qr_code_item item LEFT JOIN qr_code_main main ON item.qr_code_main_id = main.id WHERE main.section = 2 AND isnull(item.update_time, item.create_time) BETWEEN '20180301' AND '20180801' GROUP BY item.item_type_id UNION ALL SELECT item.item_type_id type, COUNT(*) total FROM qr_code_item2 item LEFT JOIN qr_code_main main ON item.qr_code_main_id = main.id WHERE main.section = 2 AND isnull(item.update_time, item.create_time) BETWEEN '20180301' AND '20180801' GROUP BY item.item_type_id ) aa ON itype.id = aa.typeORDER BY itype.id ps:å¢©æŸ±ç±»ã€æ¢ç±»è™½éƒ½å±äºéƒ¨ä»¶ç±»ï¼Œä½†å…·ä½“ä¿¡æ¯å·®åˆ«è¾ƒå¤§ï¼Œæ•…åˆ†æˆä¸¤ä¸ªè¡¨ï¼Œæ‰€ä»¥ç»Ÿè®¡çš„æ—¶å€™ä½¿ç”¨äº†è”åˆæŸ¥è¯¢","categories":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://cloudintheking.github.io/categories/æ•°æ®åº“/"}],"tags":[{"name":"sql","slug":"sql","permalink":"https://cloudintheking.github.io/tags/sql/"}]},{"title":"mongodbä¹‹ä¸»ä»ã€é›†ç¾¤ã€åˆ†ç‰‡","slug":"mongodbä¹‹ä¸»ä»ã€é›†ç¾¤ã€åˆ†ç‰‡","date":"2018-08-07T14:04:05.000Z","updated":"2021-04-26T13:07:09.970Z","comments":true,"path":"posts/14f7ff4b.html","link":"","permalink":"https://cloudintheking.github.io/posts/14f7ff4b.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ æ ¸å¿ƒè¯­å¥åšå®¢ä¹Ÿå¥½ï¼Œå®˜ç½‘ä¹Ÿç½¢ï¼Œå¯†å¯†éº»éº»ä¸€å †è¯ï¼Œæç‚¼æµ“ç¼©å°±ä¸‹é¢è¿™å‡ è¡Œå‘½ä»¤12345678910111213141516171819202122#ä¸»ä»å¤åˆ¶mongod --port 27018 --dbpath \"F:\\mongodbSet\\mongodb1\\data\" --logpath \"F:\\mongodbSet\\mongodb1\\log\\mongodb.log\" --logappend --mastermongod --port 27019 --dbpath \"F:\\mongodbSet\\mongodb2\\data\" --logpath \"F:\\mongodbSet\\mongodb2\\log\\mongodb.log\" --logappend --slave --source=127.0.0.1:27018#å‰¯æœ¬é›†mongod --port 27018 --dbpath \"F:\\mongodbSet\\mongodb1\\data\" --logpath \"F:\\mongodbSet\\mongodb1\\log\\mongodb.log\" --logappend --replSet myrsmongod --port 27019 --dbpath \"F:\\mongodbSet\\mongodb2\\data\" --logpath \"F:\\mongodbSet\\mongodb2\\log\\mongodb.log\" --logappend --replSet myrsmongod --port 27020 --dbpath \"F:\\mongodbSet\\mongodb3\\data\" --logpath \"F:\\mongodbSet\\mongodb3\\log\\mongodb.log\" --logappend --replSet myrs#åˆ†ç‰‡+å‰¯æœ¬é›†#configmongod --port 27018 --bind_ip 127.0.0.1 --configsvr --dbpath \"F:\\mongodbSet\\config\\mongodb1\\data\" --logpath \"F:\\mongodbSet\\config\\mongodb1\\log\\mongodb.log\" --logappend --replSet configsmongod --port 27019 --bind_ip 127.0.0.1 --configsvr --dbpath \"F:\\mongodbSet\\config\\mongodb2\\data\" --logpath \"F:\\mongodbSet\\config\\mongodb2\\log\\mongodb.log\" --logappend --replSet configsmongod --port 27020 --bind_ip 127.0.0.1 --configsvr --dbpath \"F:\\mongodbSet\\config\\mongodb3\\data\" --logpath \"F:\\mongodbSet\\config\\mongodb3\\log\\mongodb.log\" --logappend --replSet configs#shardmongod --port 27024 --bind_ip 127.0.0.1 --shardsvr --dbpath \"F:\\mongodbSet\\shared\\mongodb1\\data\" --logpath \"F:\\mongodbSet\\shared\\mongodb1\\log\\mongodb.log\" --logappend --replSet shardmongod --port 27025 --bind_ip 127.0.0.1 --shardsvr --dbpath \"F:\\mongodbSet\\shared\\mongodb2\\data\" --logpath \"F:\\mongodbSet\\shared\\mongodb2\\log\\mongodb.log\" --logappend --replSet shardmongod --port 27026 --bind_ip 127.0.0.1 --shardsvr --dbpath \"F:\\mongodbSet\\shared\\mongodb3\\data\" --logpath \"F:\\mongodbSet\\shared\\mongodb3\\log\\mongodb.log\" --logappend --replSet shard#mongosmongos --port 27021 --configdb configs/127.0.0.1:27018,127.0.0.1:27019,127.0.0.1:27020 --replSet mongos ç›¸å…³å‘½ä»¤è§£é‡Š â€“port &lt;ç«¯å£å·&gt;ï¼š è®¾ç½®mongoæœåŠ¡å¼€å¯çš„ç«¯å£ â€“dbpath &lt;æ•°æ®å­˜å‚¨è·¯å¾„&gt;ï¼šè®¾ç½®mongoæ•°æ®å­˜å‚¨è·¯å¾„ â€“logpath &lt;æ—¥å¿—å­˜å‚¨è·¯å¾„&gt;ï¼šè®¾ç½®mongoæ—¥å¿—å­˜å‚¨è·¯å¾„ â€“logappend ï¼šå¯ç”¨æ—¥å¿—è¿½åŠ æ–¹å¼ï¼Œå¦åˆ™æ–°æ—¥å¿—ä¼šè¦†ç›–æ—§æ—¥å¿— â€“master ï¼šè®¾ç½®ä¸ºmasteræ–¹ â€“slaveï¼šè®¾ç½®ä¸ºslaveæ–¹ â€“source = &lt; ip : port&gt;ï¼šè®¾ç½®masteræœåŠ¡çš„åœ°å€ â€“replSet &lt;é›†ç¾¤å&gt;ï¼šè®¾ç½®é›†ç¾¤åç§°","categories":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://cloudintheking.github.io/categories/æ•°æ®åº“/"}],"tags":[{"name":"mongodb","slug":"mongodb","permalink":"https://cloudintheking.github.io/tags/mongodb/"}]},{"title":"æˆ‘çš„è£…å¤‡æ¸…å•","slug":"æˆ‘çš„è£…å¤‡æ¸…å•","date":"2018-08-06T06:45:42.000Z","updated":"2021-04-26T13:07:09.970Z","comments":true,"path":"posts/6059b33.html","link":"","permalink":"https://cloudintheking.github.io/posts/6059b33.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ why?éšç€æŠ€æœ¯æ ˆçš„åŠ æ·±ï¼Œè®¤è¯†çš„è¯­è¨€å’Œå·¥å…·ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œè‹¥æ˜¯æ•´ç†å‡ºä¸€ä»½æ¸…å•ï¼Œé‡è£…ç¯å¢ƒçš„æ—¶å€™æƒ³æƒ³å¤´å°±å¤§... å¼€å‘ç¯å¢ƒ Maven DosBox Git Python Node.js Java nginx nvm masm32 å¼€å‘å·¥å…· IDE IntelliJ IDEA PyCharm WebStorm Visual C++6.0 å¯†ç :ec13 åç¼–è¯‘ç¥å™¨ Bytecode Viewer æ•°æ®å¯è§†åŒ–å·¥å…· DataGrip Redis Desktop Manager NoSQL Manager è™šæ‹Ÿæœº vmware å¯†ç ï¼št8i3 å®¹å™¨ Docker gitç®¡ç†å·¥å…· å°ä¹Œé¾Ÿ ç»ˆç«¯è¿æ¥å·¥å…· xshell è¿œç¨‹æ¡Œé¢å·¥å…· TeamViewer ä¸‹è½½ç¥å™¨ IDM è½¬ç ç¥å™¨ FFmpeg ç§‘å­¦ä¸Šç½‘ shadowsocksR å¯†ç ï¼š0w5g å…¶ä»– å°è±¡ç¬”è®° é©¬å…‹é£è±¡ å¾®ä¿¡ Chrome(éœ€ç¿»å¢™) ç«ç»’(æ¯”360è‰¯å¿ƒ100å€) ç™¾åº¦ç½‘ç›˜ 7-zip Postman(restfulsapi è°ƒè¯•ç¥å™¨ )","categories":[{"name":"ç¯å¢ƒå®‰è£…ç¯‡","slug":"ç¯å¢ƒå®‰è£…ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¯å¢ƒå®‰è£…ç¯‡/"}],"tags":[{"name":"æ¸…å•","slug":"æ¸…å•","permalink":"https://cloudintheking.github.io/tags/æ¸…å•/"}]},{"title":"Flex-Layoutä¹‹å£°æ˜å¼APIæ¦‚è¿°","slug":"Flex-Layoutä¹‹å£°æ˜å¼APIæ¦‚è¿°","date":"2018-08-04T13:24:09.000Z","updated":"2021-04-26T13:07:09.965Z","comments":true,"path":"posts/50688eb0.html","link":"","permalink":"https://cloudintheking.github.io/posts/50688eb0.html","excerpt":"","text":"ç¿»è¯‘åŸæ–‡ï¼šhttps://github.com/angular/flex-layout/wiki/Declarative-API-Overview é™æ€APIæ¦‚è¿°Flex layout çš„ç‰¹ç‚¹å°±æ˜¯æä¾›æ•æ·çš„è¯­æ³•æ€§çš„æŒ‡ä»¤å…è®¸å¼€å‘è€…åˆ©ç”¨å¼¹æ€§ç›’å­CSSæ ·å¼æ¥è½»æ¾ç›´è§‚åœ°åˆ›å»ºå“åº”ä¸”è‡ªé€‚åº”çš„å¸ƒå±€ã€‚ è¿™ä¸ªAPIæ¦‚è¿°å¯ä»¥è¢«è§†ä½œé™æ€çš„ï¼Œæä¾›ä¸€ä¸ªéšæµè§ˆå™¨å®½åº¦æ”¹å˜è€Œè°ƒæ•´å…ƒç´ çš„å¤§å°å’Œä½ç½®çš„ç”¨æˆ·ä½“éªŒã€‚è¿™ä¸ªé™æ€APIå¯ä»¥è¢«è§†ä¸ºé»˜è®¤æ¡Œé¢å¸ƒå±€APIã€‚å¼€å‘è€…åº”è¯¥ä½¿ç”¨å“åº”å¼APIæ¥æ”¯æŒæ‰‹æœºæˆ–å¹³æ¿è®¾å¤‡çš„äº¤äº’å¼å¸ƒå±€é…ç½®ã€‚ Flex-Layout æ˜¯ä¸€ç»„ç›´è§‚çš„HTMLæŒ‡ä»¤ï¼ˆakaå±æ€§ï¼‰åˆ—è¡¨ï¼Œå¯ä»¥è¢«ç”¨äºHTMLå®¹å™¨å’Œå…ƒç´ ã€‚å¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨HTMLä¸­å®šä¹‰ä»–ä»¬è‡ªå·±çš„å¸ƒå±€å£°æ˜ã€‚ä¸€ä¸ªé‡è¦çš„åŸºæœ¬çš„æ¦‚å¿µå°±æ˜¯ç†è§£å“ªäº›APIè¢«ç”¨åœ¨DOMå®¹å™¨ä¸Šï¼Œå“ªäº›è¢«ç”¨åœ¨DOMå®¹å™¨çš„å­å…ƒç´ ä¸Šã€‚ ç”¨äºDOMå®¹å™¨çš„APIï¼š HTML API Allowed values fxLayout &lt; direction &gt; [wrap] row / column / row-reverse / column-reverase fxLayoutAlign &lt; main-axis &gt; &lt; cross-axis&gt; main-axis: start / center / end / space-around / space-between; cross-axis: start / center / end / stretch fxLayoutGap % / px / vw / vh è¿™äº›æŒ‡ä»¤ä¼šå½±å“å®¹å™¨ä¸­å­å…ƒç´ çš„æµå‘å’Œå¸ƒå±€ã€‚ ç”¨äºDOMå…ƒç´ çš„APIï¼š HTML Allowed values fxFlex â€œâ€ / px / % / vw / vh &lt; grow&gt; &lt; shrink&gt; &lt; basis&gt; fxFlexOrder int fxFlexOffset % / px / vw / vh fxFlexAligin start / baseline / center / end fxFlexFill,fxFill è¿™äº›æŒ‡ä»¤å½±å“å®¿ä¸»å…ƒç´ çš„å¸ƒå±€å’Œå¤§å°ã€‚æ³¨æ„è¿™äº›APIæœŸæœ›å®ƒä»¬çš„å®¿ä¸»å…ƒç´ å†…ç½®äºä¸€ä¸ªå¼¹æ€§ç›’å­çš„DOMå®¹å™¨é‡Œï¼ˆä¸€ä¸ªå—å…ƒç´ ï¼Œå®ƒæœ¬èº«ä½¿ç”¨å¸ƒå±€APIæ¥ä½œä¸ºå®¹å™¨ï¼‰ã€‚ ç”¨äºä»»æ„å…ƒç´ çš„API ï¼š HTML API Allowed values fxHide TRUE / FALSE / 0 / â€œâ€ fxShow TRUE / FALSE / 0 / â€œâ€ ngClass @extends ngClass core ngStyle @extends ngStyle core imgSrc @extends src attribute ä¸‹é¢å±•ç¤ºçš„æ˜¯ä½¿ç”¨å®¹å™¨å’Œå…ƒç´ çš„é™æ€APIæ¥å†™çš„ä¸€ä¸ªç®€å•çš„HTMLæ ‡è®°ï¼š123456789&lt;div fxLayout='column' class=\"zero\"&gt; &lt;div fxFlex=\"33\" class=\"one\" &gt;&lt;/div&gt; &lt;div fxFlex=\"33%\" [fxLayout]=\"direction\" class=\"two\"&gt; &lt;div fxFlex=\"22%\" class=\"two_one\"&gt;&lt;/div&gt; &lt;div fxFlex=\"205px\" class=\"two_two\"&gt;&lt;/div&gt; &lt;div fxFlex=\"30\" class=\"two_three\"&gt;&lt;/div&gt; &lt;/div&gt; &lt;div fxFlex class=\"three\"&gt;&lt;/div&gt;&lt;/div&gt; Flex LayoutæŒ‡ä»¤ç›´æ¥åˆ†é…CSSæ ·å¼å†…åµŒåˆ°å®¿ä¸»å…ƒç´ ä¸­ï¼Œè¿™äº›å†…åµŒæ ·å¼ä¼šè¦†ç›–æ‰ç»§æ‰¿çš„æ ·å¼ã€å½±å­DOMæ ·å¼ï¼Œç”šè‡³æ˜¯æ‰€æœ‰åŸºäº:hostå…ƒç´ çš„å½±å­DOMæ ‘å½¢æ ·å¼ã€‚ å“åº”å¼APIFlex-Layout ä¹Ÿæ‹¥æœ‰ä¸€å¥—å·¨å¤§çš„å“åº”ç‰¹å¾æ¥ç¡®ä¿å¼€å‘è€…èƒ½å¤Ÿè½»æ¾åœ°æ”¹å˜ä¸åŒæ˜¾ç¤ºè®¾å¤‡ä¹‹é—´çš„ç”¨æˆ·ä½“éªŒå¸ƒå±€é…ç½®ã€‚æ›´å¤šæ–‡æ¡£èµ„æ–™è¯·è‡³ Responsive API pageã€‚ æœ¬æ–‡ä»…ä½œç¿»è¯‘ï¼Œå…³äºå¼¹æ€§å¸ƒå±€æ¡†æ¶çš„ç›¸å…³çŸ¥è¯†ï¼Œæ¨èåšæ–‡ã€‚åæœŸæˆ‘ä¼šæŠ½ç©ºç¿»è¯‘Flex-Layoutçš„å…¶ä»–æ–‡ç« ã€‚","categories":[{"name":"ç¿»è¯‘ç¯‡","slug":"ç¿»è¯‘ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¿»è¯‘ç¯‡/"}],"tags":[{"name":"flex-layout","slug":"flex-layout","permalink":"https://cloudintheking.github.io/tags/flex-layout/"}]},{"title":"Nginxä¹‹æ­£åå‘ä»£ç†","slug":"Nginxä¹‹æ­£åå‘ä»£ç†","date":"2018-08-02T14:01:08.000Z","updated":"2021-04-26T13:07:09.956Z","comments":true,"path":"posts/a174bf32.html","link":"","permalink":"https://cloudintheking.github.io/posts/a174bf32.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ å‰è¨€ç§‘å­¦ä¸Šç½‘è¿‡çš„å°ä¼™ä¼´ä»¬éƒ½çŸ¥é“ï¼Œç›®å‰è¿™äº›ä¸Šç½‘å·¥å…·SSã€SSRã€V2Rayç­‰ç­‰ï¼Œè¯´ç™½äº†å°±æ˜¯é€šè¿‡ä»£ç†è®©æˆ‘ä»¬å¾—ä»¥æ„‰å¿«åœ°é¨æ¸¸åœ¨çŸ¥è¯†çš„æµ·æ´‹é‡Œã€‚ æ­£å‘ä»£ç†æ¦‚å¿µæ­£å‘ä»£ç†æ˜¯ä»€ä¹ˆï¼Ÿç”±äºæŸäº›ç½‘ç«™è®¿é—®å¥‡æ…¢ï¼Œæˆ–è€…å¢™çš„é—®é¢˜æ ¹æœ¬æ— æ³•è®¿é—®æ—¶ï¼Œé€šè¿‡ç»™æµè§ˆå™¨é…ç½®ä»£ç†ipå’Œç«¯å£ï¼Œè®©ä»£ç†æœåŠ¡å™¨è½¬å‘æˆ‘ä»¬è¯·æ±‚ï¼Œè€Œåå°†å“åº”ç»“æœä¼ å›æµè§ˆå™¨ï¼Œè¿™å°±æ˜¯æ­£å‘ä»£ç†ã€‚ä¸¾ä¸ªé€šä¿—çš„æ —å­ï¼Œå°±å¥½æ¯”ä½ è‡ªå·±æ²¡æ‰¾åˆ°åˆé€‚çš„æˆ¿å­ï¼Œäºæ˜¯ä½ é€šè¿‡æˆ¿ç§Ÿä¸­ä»‹æ¥ç§Ÿåˆ°å¥½æˆ¿å­ã€‚å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š nginxæ­£å‘ä»£ç†ä¸»è¦é…ç½®æœåŠ¡ç«¯åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²äº†ä¸€å°nginxæœåŠ¡å™¨ï¼ˆæœ‰ç‹¬ç«‹å±€åŸŸç½‘ipï¼‰12345678server &#123; resolver 114.114.114.114 8.8.8.8; #æŒ‡å®šDNSæœåŠ¡å™¨IPåœ°å€ listen 8888; #ç›‘å¬ç«¯å£ location / &#123; proxy_pass $scheme://$host$request_uri; #è®¾å®šä»£ç†æœåŠ¡å™¨çš„åè®®å’Œåœ°å€ proxy_set_header Host $http_host; &#125; &#125; ç„¶åé‡å¯nginxç”Ÿæ•ˆ å®¢æˆ·ç«¯æ‰“å¼€Chromeæµè§ˆå™¨-&gt;è®¾ç½®-&gt;é«˜çº§-&gt;ç³»ç»Ÿ-&gt;æ‰“å¼€ä»£ç†è®¾ç½®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œ192.168.1.44å°±æ˜¯ä½ æ–°å»ºè™šæ‹Ÿæœºçš„ç‹¬ç«‹å±€åŸŸç½‘IPã€‚ åå‘ä»£ç†æ¦‚å¿µä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œæ­£å‘ä»£ç†æœåŠ¡å™¨åªæ˜¯è½¬å‘ä»£ç†è¯·æ±‚ï¼Œå¹¶ä¸æä¾›è‡ªå·±çš„æœåŠ¡ï¼›è€Œåå‘ä»£ç†å¯ä»¥æä¾›è‡ªå·±çš„æœåŠ¡ã€‚æ¯”å¦‚è¯´ï¼Œæœ‰ä¸ªè¯·æ±‚æƒ³è¦è®¿é—®ä½ å…¬å¸å†…ç½‘æœåŠ¡å™¨ï¼Œè€Œå®é™…å…¬å¸åªæœ‰ä¸€ä¸ªå…¬å…±IPï¼Œå†…ç½‘IPå¹¶æ²¡æœ‰æ˜ å°„ï¼Œæ‰€ä»¥è¿™æ—¶å€™ä½ å°±å¯ä»¥ä½¿ç”¨nginxåå‘ä»£ç†æ¥å®ç°å†…ç½‘èµ„æºçš„è¯·æ±‚ã€‚å¦å¤–ï¼Œå¦‚æœè®¿é—®é‡è¿‡å¤§ï¼Œè¿˜å¯ä»¥ä½¿ç”¨nginxæ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š nginxåå‘ä»£ç†ä¸»è¦é…ç½®1234567891011121314151617181920212223242526upstream clusterserver &#123; #ä¸è®¾ç½®ï¼Œåˆ™é»˜è®¤æ˜¯è½®è¯¢ #least_conn; #æœ€å°‘è¿æ¥æ•° #ip_hash; #æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionçš„é—®é¢˜ã€‚ server 192.1.168.45:9991 weight=1; #weightå€¼ä¸º1~10ï¼Œä»£è¡¨æƒé‡ï¼Œå’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µ server 192.1.168.46:9991 weight=1; #server 192.1.168.45:9993 weight=1 down; #æ‰‹å·¥è®¾ç½®è¯¥æœåŠ¡ä¸å¯ç”¨ #server 192.1.168.45:9994 weight=1 backup; #å…¶ä»–ä¸»æœåŠ¡å™¨éƒ½æŒ‚äº†ï¼Œè‡ªåŠ¨å¼€å¯è¿™ä¸ªå¤‡ç”¨æœåŠ¡ã€‚&#125; server &#123; listen 9999; server_name xxx; #ä½ çš„åŸŸåæˆ–è€…å…¬å…±IP location / &#123; root html; index index.html index.htm; proxy_pass http://clusterserver; proxy_connect_timeout 1; #å•ä½ä¸ºç§’ è¶…æ—¶è®¾ç½®ï¼Œå¦‚æœè¶…æ—¶å°†è¯·æ±‚å…¶ä»–æœåŠ¡ #proxy_send_timeout 1; #proxy_read_timeout 1; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125; è¿™æ ·å½“ä»£ç†æœåŠ¡å™¨ç›‘å¬åˆ°9999ç«¯å£çš„è¯·æ±‚æ—¶ï¼Œæ ¹æ®proxy_passé…ç½®æ‰¾åˆ°åä¸ºclusterserverçš„upstream èŠ‚ç‚¹æ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://cloudintheking.github.io/tags/nginx/"}]},{"title":"powershellä¹‹å¯åŠ¨è¿œç¨‹jaræœåŠ¡","slug":"powershellä¹‹å¯åŠ¨è¿œç¨‹jaræœåŠ¡","date":"2018-07-29T13:20:21.000Z","updated":"2021-04-26T13:07:09.965Z","comments":true,"path":"posts/3edeb9a.html","link":"","permalink":"https://cloudintheking.github.io/posts/3edeb9a.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ èµ·å› ä¸»ç®¡æŠ½é£è¯´æ¯æ¬¡éƒ½è¦ç™»å½•è¿œç¨‹æœåŠ¡å™¨å†å¯åŠ¨jarå¤ªéº»çƒ¦äº†ï¼Œè¦æ˜¯æœ‰ä¸ªä¸€é”®å¯åŠ¨è¿œç¨‹jarçš„æ‰¹å¤„ç†å°±æ˜¯ã€‚äºæ˜¯è¿™ä¸ªä»»åŠ¡å°±äº¤ç»™æˆ‘äº†â€¦ powershellé…ç½®ç”¨ç®¡ç†å‘˜æƒé™å¯åŠ¨ PowerShell,æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤:123456789101112131415161718#å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å…¬å…±é…ç½®:Get-Service WinRM #æŸ¥çœ‹WinRMæœåŠ¡çš„çŠ¶æ€Enable-PSRemoting â€“Force #é…ç½®ç³»ç»Ÿæ¥å—è¿œç¨‹å‘½ä»¤Set-Service WinRM -StartMode Automatic #å¼€å¯WinRMæœåŠ¡è‡ªå¯åŠ¨winrm set winrm/config/winrs '@&#123;MaxMemoryPerShellMB=\"3000\"&#125;' #è®¾ç½®powershellæœ€å¤§å†…å­˜ æ–¹æ³•ä¸€æ¨èSet-Item WSMan:\\localhost\\Plugin\\Microsoft.PowerShell\\Quotas\\MaxMemoryPerShellMB 3000 #è®¾ç½®æœ€å¤§å†…å­˜ æ–¹æ³•äºŒRestart-Service winrm //é‡å¯winrmæœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ#æœåŠ¡å™¨é…ç½®:Set-Item WSMan:localhost\\client\\trustedhosts -value \"192.168.1.44,192.168.1.45\" #è®¾ç½®è®¾ç½®ä¸»æœºå¯ä¿¡ä»»çš„å®¢æˆ·ç«¯åœ°å€winrm set winrm/config/client @&#123;TrustedHosts=\"192.168.1.45,192.168.1.44\"&#125; #è®¾ç½®è®¾ç½®ä¸»æœºå¯ä¿¡ä»»çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå½“ä¸Šä¸ªå‘½ä»¤æ— æ•ˆæ—¶ï¼Œå¯é€‰ç”¨è¯¥å‘½ä»¤ï¼ˆè¯¥å‘½ä»¤è¯·åœ¨cmdä¸­ä½¿ç”¨ï¼‰ Get-Item WSMan:\\localhost\\Client\\TrustedHosts #æŸ¥çœ‹å¯ä¿¡ä»»ä¸»æœºget-executionpolicy #æŸ¥çœ‹è„šæœ¬æ‰§è¡Œç­–ç•¥set-executionpolicy remotesigned #è®¾ç½®æ‰§è¡Œç­–ç•¥ä¸ºè¿œç¨‹å¯æ‰§è¡ŒRestart-Service winrm #é‡å¯æœåŠ¡ç”Ÿæ•ˆTest-WsMan xxx.xxx.xxx.xxx #å®¢æˆ·ç«¯æµ‹è¯•è¿œç¨‹è¿æ¥ jaråŒ…ä¸Šä¼ å¤„ç†å‘½ä»¤ æœåŠ¡å™¨ä¸Šå¿…é¡»å®‰è£…äº†ftp,å¦åˆ™æ²¡æ³•ä¸Šä¼ æ–‡ä»¶ã€‚æˆ‘å…¬å¸æœåŠ¡å™¨ç³»ç»Ÿæ˜¯windows server 2008,ç”¨å®ƒè‡ªå¸¦çš„IISåˆ›å»ºftp,å¹¶è®¾ç½®è™šæ‹Ÿç›®å½•ã€‚ æ–°å»ºä¸Šä¼ æ–‡ä»¶è„šæœ¬up.batï¼š123456789101112131415161718curl -X POST 192.168.1.44:8886/shutdown #å…³é—­44æœåŠ¡å™¨ä¸Š8886ç«¯å£æœåŠ¡curl -X POST 192.168.1.44:8887/shutdown#å…³é—­44æœåŠ¡å™¨ä¸Š8887ç«¯å£æœåŠ¡curl -X POST 192.168.1.44:8888/shutdown#å…³é—­44æœåŠ¡å™¨ä¸Š8888ç«¯å£æœåŠ¡Echo open 192.168.1.44 &gt;ftp.up #æ‰“å¼€è¿æ¥44æœåŠ¡å™¨ftpè¿æ¥Echo Administrator&gt;&gt;ftp.up #æœåŠ¡å™¨ä¸Šç™»å½•ç”¨æˆ·åEcho 59@SDS25&gt;&gt;ftp.up #ç™»å½•å¯†ç Echo cd .\\project1&gt;&gt;ftp.up #å› ä¸ºè¿›å…¥çš„æ˜¯ftpçš„æ ¹ç›®å½•ï¼Œæ‰€ä»¥ä½¿ç”¨.\\project1,è¿›å…¥æ ¹ç›®å½•ä¸‹çš„project1Echo binary&gt;&gt;ftp.up #äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“æ ¼å¼Echo put \"E:\\Workspace\\idea\\jcnyJava\\target\\jcny-java-0.0.1-SNAPSHOT.jar\"&gt;&gt;ftp.up #ä¼ é€æœ¬åœ°æ–‡ä»¶åˆ°ftpä¸­Echo cd ..\\project2&gt;&gt;ftp.up #ä½¿ç”¨..\\project2,è¿›å…¥æ ¹ç›®å½•ä¸‹çš„project2ç›®å½•Echo put \"E:\\Workspace\\idea\\jcnyJava\\target\\jcny-java-0.0.1-SNAPSHOT.jar.original\"&gt;&gt;ftp.up #ä¼ é€æœ¬åœ°æ–‡ä»¶åˆ°ftpä¸­Echo cd ..\\project3&gt;&gt;ftp.up #è¿›å…¥æ ¹ç›®å½•ä¸‹çš„project3ç›®å½•Echo put \"E:\\Workspace\\idea\\jcnyJava\\target\\jcny-java-0.0.1-SNAPSHOT.jar.original\"&gt;&gt;ftp.up #ä¼ é€æœ¬åœ°æ–‡ä»¶åˆ°ftpä¸­Echo bye&gt;&gt;ftp.up #å®¢æˆ·ç«¯å…³é—­ftpè¿æ¥FTP -s:ftp.up #æœåŠ¡å™¨å…³é—­ftpè¿æ¥del ftp.up /q #åˆ é™¤ftpè¿æ¥Pause powershellå¯åŠ¨è¿œç¨‹æœåŠ¡å‘½ä»¤æ–°å»ºä¸€ä¸ªå¯åŠ¨è„šæœ¬deploy.ps112345678$na = \"yourname\" #æœåŠ¡å™¨ç”¨æˆ·å $p2 = ConvertTo-SecureString \"yourpassword\" -AsPlainText -Force #åŠ å¯†ç™»å½•å¯†ç  $A = New-Object System.Management.Automation.PSCredential($na,$p2) #åˆ›å»ºè¿æ¥Invoke-Command -ComputerName 192.168.1.44 -Credential $A -ScriptBlock &#123; #æ‰§è¡Œè¿œç¨‹æ“ä½œSet-Location E:\\webroot\\projects #è¿›å…¥è¿œç¨‹æœåŠ¡å™¨ç›®å½•invoke-expression -command E:\\webroot\\tongtu-projects\\startall.bat #è¿œç¨‹æœåŠ¡å¯åŠ¨çš„è„šæœ¬è·¯å¾„&#125; ä»¥ä¸Šå‘½ä»¤éƒ½æ˜¯é’ˆå¯¹Windowsç³»ç»Ÿçš„ï¼ŒLinuxç³»ç»Ÿåº”è¯¥æ˜¯å†™bashè„šæœ¬å§ã€‚å¦‚æœä¸‹æ¬¡ä¸»ç®¡è¯´è¦ä¸€é”®å¯åŠ¨è¿œç¨‹Linuxä¸Šçš„æœåŠ¡çš„è¯ï¼Œåˆ°æ—¶å€™æˆ‘å†å†™ç¯‡linuxçš„å§ã€‚","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"powershell","slug":"powershell","permalink":"https://cloudintheking.github.io/tags/powershell/"}]},{"title":"Pythonè™šæ‹Ÿç¯å¢ƒæ­å»º","slug":"Pythonè™šæ‹Ÿç¯å¢ƒæ­å»º","date":"2018-07-26T06:36:54.000Z","updated":"2021-04-26T13:07:09.956Z","comments":true,"path":"posts/7a79fcd9.html","link":"","permalink":"https://cloudintheking.github.io/posts/7a79fcd9.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ åº”ç”¨åœºæ™¯æ­å»º Python è™šæ‹Ÿç¯å¢ƒï¼Œå¯ä»¥æ–¹ä¾¿åœ°Python2ï¼ŒPython3 å…±å­˜ã€‚é¿å…åŒ…çš„æ··ä¹±å’Œç‰ˆæœ¬çš„å†²çªã€‚ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºå•ç‹¬åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¯ä»¥ä¿è¯ç¨‹åºä¸­èƒ½è®¿é—®è™šæ‹Ÿç¯å¢ƒä¸­çš„åŒ…ï¼Œä¿æŒè§£é‡Šå™¨ç¯å¢ƒçš„å¹²å‡€æ•´æ´ã€‚virtualenvå°±æ˜¯ç”¨æ¥ä¸ºä¸€ä¸ªåº”ç”¨åˆ›å»ºä¸€å¥—â€œéš”ç¦»â€çš„Pythonè¿è¡Œç¯å¢ƒã€‚ æˆ‘çš„å¼€å‘ç¯å¢ƒ windows 10 python2.7 python3.5 å®‰è£…ä½¿ç”¨ virtualenvå‰è¨€å› ä¸ºæˆ‘è£…äº†python2.7ã€3.5ï¼Œæ‰€ä»¥ä¹Ÿå°±æœ‰äº†ä¸¤ä¸ªpipåŒ…ç®¡ç†å·¥å…·ï¼Œé»˜è®¤ä¼šä½¿ç”¨é«˜ç‰ˆæœ¬pythonçš„pipï¼Œbutä¹Ÿå¯ä»¥æŒ‡å®šsä½¿ç”¨å“ªä¸ªPythonç‰ˆæœ¬çš„pipï¼Œå¦‚pip2æŒ‡å®šä½¿ç”¨Python2.7çš„pipã€‚ å®‰è£…1pip3 install virtualenv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ12cd your_project_dir #è¿›å…¥ä½ çš„å·¥ç¨‹ç›®å½•virtualenv env1 -p G:\\Environment\\Python\\Python27 --no-site-packages env1ï¼šè™šæ‹Ÿç¯å¢ƒç›®å½•å -pï¼šæŒ‡å®šPythonå®‰è£…è·¯å¾„ â€“no-site-packagesï¼š ä¸å¤åˆ¶ç³»ç»ŸPythonç¯å¢ƒä¸­çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åŒ… è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªä¸å¸¦ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…çš„â€œå¹²å‡€â€çš„Python2.7è¿è¡Œç¯å¢ƒã€‚ æ¿€æ´»è™šæ‹Ÿç¯å¢ƒcd env1 #è¿›å…¥è™šæ‹Ÿç¯å¢ƒ cd Scirpts #è¿›å…¥è„šæœ¬ç›®å½• activate #æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ deactivate #é€€å‡ºè™šæ‹Ÿç¯å¢ƒ æˆªå›¾å¦‚ä¸‹ï¼š å½“æ‰§è¡Œactivateæ—¶ï¼Œæ³¨æ„å‘½ä»¤æç¤ºç¬¦å˜äº†ï¼Œæœ‰ä¸ª(env1)å‰ç¼€ï¼Œè¡¨ç¤ºå½“å‰ç¯å¢ƒæ˜¯ä¸€ä¸ªåä¸ºenv1çš„Pythonç¯å¢ƒã€‚ è™½ç„¶virtualenvå¾ˆå¼ºå¤§ï¼Œä½†ä»æœ‰ä¸è¶³ã€‚ä½ æƒ³ï¼Œè¦æ˜¯ä»¥ååˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒå¤šäº†ï¼Œå®ƒä»¬åˆ†æ•£åœ¨ç³»ç»Ÿå„å¤„ï¼Œæ—¶é—´ä¸€é•¿ï¼Œä½ å¯èƒ½å¿˜è®°å®ƒä»¬çš„åå­—æˆ–è€…ä½ç½®ã€‚æ‰€ä»¥ä¸‹é¢ä»‹ç»virtualenvwrapperã€‚ å®‰è£…ä½¿ç”¨ virtualenvwrapperä»‹ç»virtualenvwrapper æ˜¯å¯¹ virtualenv çš„åŠŸèƒ½æ‰©å±•ï¼Œå¯ä»¥ç®¡ç†å…¨éƒ¨çš„è™šæ‹Ÿç¯å¢ƒï¼Œç”¨å•ä¸ªå‘½ä»¤æ–¹ä¾¿åˆ‡æ¢ä¸åŒçš„è™šæ‹Ÿç¯å¢ƒã€‚ å®‰è£…pip install virtualenvwrapper-win è®¾ç½®workon_homeç¯å¢ƒå˜é‡ åŸºæœ¬å‘½ä»¤æ–°å»ºè™šæ‹Ÿç¯å¢ƒå¦‚æœä¸æŒ‡å®šPythonè§£é‡Šå™¨ç¨‹åºè·¯å¾„ï¼Œåˆ™ä¼šé»˜è®¤ä½¿ç”¨ç³»ç»Ÿé‡Œé«˜ç‰ˆæœ¬Python1mkvirtualenv env2 mkvirtualenv â€“python=(pythoæ‰§è¡Œè·¯å¾„) (è™šæ‹Ÿç¯å¢ƒåå­—)1mkvirtualenv --python=G:\\Environment\\Python\\Python27\\python.exe mypython27 æŸ¥çœ‹å®‰è£…çš„æ‰€æœ‰è™šæ‹Ÿç¯å¢ƒworkon è¿›å…¥å’Œé€€å‡ºè™šæ‹Ÿç¯å¢ƒ12workon mypython27deactivate å…¶ä»–1mkvirtualenv -h #æ›´å¤šå‘½ä»¤å¤§å®¶è‡ªå·±æ¢ç´¢å§ åè®°åˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒçš„æŠ€æœ¯ä¸åªæœ‰virtualenvï¼Œç°åœ¨æœ€æ–°çš„æ˜¯pyenvæŠ€æœ¯ï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹æ¨èä½¿ç”¨çš„ï¼ŒåæœŸæœ‰æ—¶é—´å†ä¸“é—¨å†™ç¯‡å§å¦å¤– pychamè¿™ä¸ªIDEè‡ªå¸¦äº†Pythonè™šæ‹Ÿç¯å¢ƒåˆ›å»ºåŠŸèƒ½ï¼Œjetbrainsç³»åˆ—å°±æ˜¯","categories":[{"name":"ç¯å¢ƒå®‰è£…ç¯‡","slug":"ç¯å¢ƒå®‰è£…ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¯å¢ƒå®‰è£…ç¯‡/"}],"tags":[{"name":"python","slug":"python","permalink":"https://cloudintheking.github.io/tags/python/"}]},{"title":"äºŒå‰æŸ¥æ‰¾æ ‘ä¹‹C++å®ç°","slug":"äºŒå‰æŸ¥æ‰¾æ ‘ä¹‹C-å®ç°","date":"2018-07-20T13:53:56.000Z","updated":"2021-04-26T13:07:09.970Z","comments":true,"path":"posts/d482e59b.html","link":"","permalink":"https://cloudintheking.github.io/posts/d482e59b.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;sstream&gt;using namespace std;template&lt;class T&gt;struct BSTreeNode&#123; T key; BSTreeNode *left; BSTreeNode *right; BSTreeNode *parent; BSTreeNode(T k )&#123; key=k; left=NULL; right=NULL; parent=NULL; &#125; BSTreeNode()&#123;&#125;;&#125;;//é”™è¯¯ä¿¡æ¯ struct ErrorMessage&#123; bool flag; string message; &#125;; //ç”ŸæˆèŠ‚ç‚¹å¹¶æ’å…¥æ ‘ä¸­template&lt;class T&gt;ErrorMessage insert(BSTreeNode&lt;T&gt;* &amp;root,T key)&#123; BSTreeNode&lt;T&gt;* node=NULL; ErrorMessage error; stringstream s; if ((node=new BSTreeNode&lt;T&gt;(key)) == NULL) &#123; s&lt;&lt;\"å€¼\"&lt;&lt;key&lt;&lt;\"åˆ†é…èŠ‚ç‚¹å†…å­˜å¤±è´¥\"; error.flag=false; error.message= s.str(); return error; &#125; BSTreeNode&lt;T&gt;* x= root; BSTreeNode&lt;T&gt;* y= NULL; while (x !=NULL) &#123; y=x; if (node-&gt;key&lt;x-&gt;key) &#123; x=x-&gt;left; &#125; else if(node-&gt;key&gt;x-&gt;key)&#123; x=x-&gt;right; &#125; else&#123; s&lt;&lt;\"å€¼\"&lt;&lt;key&lt;&lt;\"é‡å¤,åˆ›å»ºèŠ‚ç‚¹å¤±è´¥\"; error.flag=false; error.message=s.str(); return error; &#125; &#125; node-&gt;parent=y; if (y==NULL) &#123; root = node; &#125; else if(node-&gt;key&lt;y-&gt;key)&#123; y-&gt;left=node; &#125; else&#123; y-&gt;right=node; &#125; s&lt;&lt;\"å€¼\"&lt;&lt;key&lt;&lt;\"åˆ›å»ºèŠ‚ç‚¹æˆåŠŸ\"; error.flag=true; error.message=s.str(); return error;&#125;//å‰åºéå†template&lt;class T &gt;void preShow(BSTreeNode&lt;T&gt;* node)&#123; if (node != NULL) &#123; cout&lt;&lt;node-&gt;key&lt;&lt;\" \"; preShow(node-&gt;left); preShow(node-&gt;right); &#125;&#125;//ä¸­åºéå†template&lt;class T&gt;void midShow(BSTreeNode&lt;T&gt;* node)&#123; if (node !=NULL) &#123; midShow(node-&gt;left); cout&lt;&lt;node-&gt;key&lt;&lt;\" \"; midShow(node-&gt;right); &#125;&#125;//ååºéå†template&lt;class T &gt;void postShow(BSTreeNode&lt;T&gt;* node)&#123; if (node != NULL) &#123; cout&lt;&lt;node-&gt;key&lt;&lt;\" \"; postShow(node-&gt;left); postShow(node-&gt;right); &#125;&#125;// æŸ¥æ‰¾èŠ‚ç‚¹æ ‘ä¸‹åŒ…å«keyçš„èŠ‚ç‚¹template&lt;class T &gt;BSTreeNode&lt;T&gt;* search(BSTreeNode&lt;T&gt;* node,T key)&#123; if (node == NULL || node-&gt;key == key) &#123; return node; &#125; else &#123; if (node-&gt;key&gt;key) &#123; search(node-&gt;left,key); &#125; else if (node-&gt;key&lt;key) &#123; search(node-&gt;right,key); &#125; &#125;&#125;// è¿”å›èŠ‚ç‚¹æ ‘ä¸­æœ€å¤§å€¼çš„èŠ‚ç‚¹template&lt;class T &gt;BSTreeNode&lt;T&gt;* maxNode(BSTreeNode&lt;T&gt;* node)&#123; if (node==NULL) &#123; return NULL; &#125; if (node-&gt;right==NULL) &#123; return node; &#125; else &#123; maxNode(node-&gt;right); &#125;&#125;// è¿”å›èŠ‚ç‚¹æ ‘ä¸­æœ€å°å€¼çš„èŠ‚ç‚¹template&lt;class T &gt;BSTreeNode&lt;T&gt;* minNode(BSTreeNode&lt;T&gt;* node)&#123; if (node==NULL) &#123; return NULL; &#125; if (node-&gt;left==NULL) &#123; return node; &#125; else &#123; minNode(node-&gt;left); &#125;&#125;//è¿”å›ä¼ å…¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹template&lt;class T&gt;BSTreeNode&lt;T&gt;* successor(BSTreeNode&lt;T&gt;* node)&#123; if(node == NULL)&#123; return NULL; &#125; if (node-&gt;right!=NULL) &#123; return minNode(node-&gt;right); &#125; BSTreeNode&lt;T&gt;* parent=node-&gt;parent; BSTreeNode&lt;T&gt;* child=node; while(parent!=NULL&amp;&amp;parent-&gt;left!=child)&#123; child=parent; parent=parent-&gt;parent; &#125; return parent;&#125;// è¿”å›ä¼ å…¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹template&lt;class T&gt;BSTreeNode&lt;T&gt;* predecessor(BSTreeNode&lt;T&gt;* node)&#123; if (node == NULL) &#123; return NULL; &#125; if (node-&gt;left!=NULL) &#123; return maxNode(node-&gt;left); &#125; BSTreeNode&lt;T&gt;* parent=node-&gt;parent; BSTreeNode&lt;T&gt;* child=node; while(parent!=NULL&amp;&amp;parent-&gt;right!=child)&#123; child=parent; parent=parent-&gt;parent; &#125; return parent;&#125;//åˆ é™¤èŠ‚ç‚¹template&lt;class T&gt;void delete_node(BSTreeNode&lt;T&gt;* &amp;root, BSTreeNode&lt;T&gt;* node)&#123; if (node-&gt;left==NULL&amp;&amp;node-&gt;right==NULL) //å¶å­èŠ‚ç‚¹ &#123; if (node == root) &#123; root=NULL; &#125; else if (isLeft(node)) &#123; node-&gt;parent-&gt;left=NULL; &#125; else&#123; node-&gt;parent-&gt;right=NULL; &#125; &#125; else if (node-&gt;left==NULL) //åªæœ‰å³å­èŠ‚ç‚¹ &#123; if (node == root) //èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ &#123; root=node-&gt;right; node-&gt;right-&gt;parent=NULL; &#125; else if (isLeft(node)) //èŠ‚ç‚¹æ˜¯å·¦èŠ‚ç‚¹ &#123; node-&gt;parent-&gt;left=node-&gt;right; node-&gt;right-&gt;parent=node-&gt;parent; &#125; else&#123; //èŠ‚ç‚¹æ˜¯å³èŠ‚ç‚¹ node-&gt;parent-&gt;right=node-&gt;right; node-&gt;right-&gt;parent=node-&gt;parent; &#125; &#125; else if (node-&gt;right==NULL) //åªæœ‰å·¦èŠ‚ç‚¹ &#123; if (node == root) //èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ &#123; root=node-&gt;left; node-&gt;left-&gt;parent=NULL; &#125; else if (isLeft(node)) //èŠ‚ç‚¹æ˜¯å·¦èŠ‚ç‚¹ &#123; node-&gt;parent-&gt;left=node-&gt;left; node-&gt;left-&gt;parent=node-&gt;parent; &#125; else&#123; //èŠ‚ç‚¹æ˜¯å³èŠ‚ç‚¹ node-&gt;parent-&gt;right=node-&gt;left; node-&gt;left-&gt;parent=node-&gt;parent; &#125; &#125; else //å·¦å³èŠ‚ç‚¹éƒ½æœ‰ &#123; BSTreeNode&lt;T&gt;* suc= successor(node); //node çš„åç»§èŠ‚ç‚¹ if (suc == node-&gt;right) //åç»§èŠ‚ç‚¹ä¸ºå³å­èŠ‚ç‚¹ &#123; if (node == root)// åˆ é™¤èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹ &#123; root=suc; suc-&gt;left=node-&gt;left; node-&gt;left-&gt;parent=suc; &#125; else&#123;// åˆ é™¤èŠ‚ç‚¹ä¸ä¸ºæ ¹èŠ‚ç‚¹ if (isLeft(node)) //åˆ é™¤èŠ‚ç‚¹ä¸ºå·¦èŠ‚ç‚¹ &#123; node-&gt;parent-&gt;left= suc; &#125; else&#123; // åˆ é™¤èŠ‚ç‚¹ä¸ºå³èŠ‚ç‚¹ node-&gt;parent-&gt;right=suc; &#125; suc-&gt;parent=node-&gt;parent; suc-&gt;left=node-&gt;left; node-&gt;left-&gt;parent=suc; &#125; &#125; else //åç»§èŠ‚ç‚¹ä¸ä¸ºå³å­èŠ‚ç‚¹ &#123; suc-&gt;parent-&gt;left=suc-&gt;right; if (suc-&gt;right!=NULL) // åç»§èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ä¸ç©º &#123; suc-&gt;right-&gt;parent= suc-&gt;parent; &#125; suc-&gt;left =node-&gt;left; node-&gt;left-&gt;parent =suc; suc-&gt;right=node-&gt;right; node-&gt;right-&gt;parent =suc; suc-&gt;parent=node-&gt;parent; if (node==root) &#123; root=suc; &#125; &#125; &#125; delete node; node=NULL;&#125;template&lt;class T&gt;bool deleteByKey(BSTreeNode&lt;T&gt;* &amp;root, T key)&#123; BSTreeNode&lt;T&gt;* node= search(root,key); if (node == NULL) &#123; return false; &#125; else&#123; delete_node(root,node); return true; &#125;&#125;// åˆ¤æ–­æ˜¯å¦ä¸ºå·¦èŠ‚ç‚¹template&lt;class T&gt;bool isLeft(BSTreeNode&lt;T&gt;* node)&#123; if (node-&gt;parent!=NULL&amp;&amp;node-&gt;parent-&gt;left==node) &#123; return true; &#125; return false;&#125;int main()&#123; BSTreeNode&lt;int&gt;* root=NULL; cout&lt;&lt;insert(root,5).message&lt;&lt;endl; cout&lt;&lt;insert(root,3).message&lt;&lt;endl; cout&lt;&lt;insert(root,1).message&lt;&lt;endl; cout&lt;&lt;insert(root,2).message&lt;&lt;endl; cout&lt;&lt;\"å‰åº\"&lt;&lt;endl; preShow(root); cout&lt;&lt;endl&lt;&lt;\"ä¸­åº\"&lt;&lt;endl; midShow(root); cout&lt;&lt;endl&lt;&lt;\"ååº\"&lt;&lt;endl; postShow(root); cout&lt;&lt;endl; if (search(root,4) != NULL) &#123; cout&lt;&lt;\"å­˜åœ¨\"&lt;&lt;4&lt;&lt;endl; &#125;else&#123; cout&lt;&lt;\"ä¸å­˜åœ¨\"&lt;&lt;4&lt;&lt;endl; &#125; cout&lt;&lt;\"æœ€å¤§å€¼:\"&lt;&lt;maxNode(root)-&gt;key&lt;&lt;endl; cout&lt;&lt;\"æœ€å°å€¼:\"&lt;&lt;minNode(root)-&gt;key&lt;&lt;endl; cout&lt;&lt;\"3çš„åç»§:\"&lt;&lt;successor(search(root,3))-&gt;key&lt;&lt;endl; cout&lt;&lt;\"3çš„å‰é©±:\"&lt;&lt;predecessor(search(root,3))-&gt;key&lt;&lt;endl; if ( deleteByKey(root,5)) &#123; cout&lt;&lt;\"5åˆ é™¤æˆåŠŸ\"&lt;&lt;endl; &#125; else &#123; cout&lt;&lt;\"5åˆ é™¤æˆåŠŸ\"&lt;&lt;endl; &#125; cout&lt;&lt;\"ä¸­åº\"&lt;&lt;endl; midShow(root); return 0;&#125;","categories":[{"name":"ç®—æ³•ç¯‡","slug":"ç®—æ³•ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç®—æ³•ç¯‡/"}],"tags":[{"name":"c++","slug":"c","permalink":"https://cloudintheking.github.io/tags/c/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"https://cloudintheking.github.io/tags/æ•°æ®ç»“æ„/"}]},{"title":"npm å‡çº§å¤±è´¥è§£å†³æ–¹æ¡ˆ","slug":"npm-å‡çº§å¤±è´¥è§£å†³æ–¹æ¡ˆ","date":"2018-07-14T04:44:37.000Z","updated":"2021-04-26T13:07:09.956Z","comments":true,"path":"posts/ada9fa1e.html","link":"","permalink":"https://cloudintheking.github.io/posts/ada9fa1e.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ è¯´ä¸€ä¸‹æˆ‘çš„å¼€å‘ç¯å¢ƒï¼š Windows 10 node 8.10.0 nvm 1.1.6 npmè¿™ä¸ªä¸œä¸œå…¶å®ä¹Ÿä¸ä¼šç»å¸¸å»å‡çº§å®ƒï¼Œä½†å› ä¸ºè¦å®‰è£…angular cli,æç¤ºæˆ‘npmç‰ˆæœ¬ä½äº†å¾—å‡çº§ï¼Œè¿™æ‰å»å‡çº§ï¼Œå“ªæ™“å¾—ä¸€ä¸ªç®€å•npmå‡çº§å±…ç„¶å°±ç‚¸äº†ã€‚ error:1npm ERR! path C:\\Program Files\\nodejs\\npm.cmd npm ERR! code EEXIST npm ERR! Refusing to delete C:\\Program Files\\nodejs\\npm.cmd: is outside C:\\Program Files\\nodejs\\node_modules\\npm and not a link npm ERR! File exists: C:\\Program Files\\nodejs\\npm.cmd npm ERR! Move it away, and try again. æç¤ºæˆ‘ç§»é™¤C:\\Program Files\\nodejs\\npm.cmdè¿™ä¸ªæ–‡ä»¶ï¼Œå¯è¿™ä¸ªæ–‡ä»¶ä¸æ˜¯npmçš„å‘½ä»¤æ–‡ä»¶å—ï¼ŒæŠŠè¿™ç§»é™¤äº†ï¼Œé‚£æˆ‘å‘½ä»¤è¡Œé‡Œæ•²npm xxxä»€ä¹ˆçš„ä¸éƒ½æ‰§è¡Œä¸äº†å—ï¼Ÿç®—äº†ï¼Œå…ˆæŒ‰æç¤ºæ¥å—ï¼Œæˆ‘ç§»é™¤äº†npm.cmdï¼Œå—¯ï¼Œè¿™ä¸‹å¥½äº†ï¼Œnpm -v éƒ½æŠ¥é”™äº†ã€‚ ç™¾åº¦äº†åŠå¤©ä¹Ÿæ²¡æ‰¾åˆ°ç±»ä¼¼çš„é”™è¯¯ï¼Œæœ€åæ²¡åŠæ³•ï¼Œåªå¥½ä½¿å‡ºé‚£ä¸€æ‹›äº†ï¼Œå¤§ç§‘å­¦ä¸Šç½‘æœ¯ï¼ï¼ˆç¿»å¢™è°·æ­Œï¼‰ å¾ˆå¿«å°±æ‰¾åˆ°ç±»ä¼¼çš„é”™è¯¯äº†ï¼Œç»™æˆ‘æ¿€åŠ¨çš„å“‡ issues è‡³äºä¸ºå•¥ä¼šæŠ¥è¿™ç§é”™ï¼Œæˆ‘ç¢ç£¨ç€å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»npm5.x.xå‡çº§åˆ°6.x.xï¼Œè·¨äº†ä¸€ä¸ªå¤§ç‰ˆæœ¬çš„åŸå› å§ï¼Œåæ¥ä»npm6.1.0æ­£å¸¸å‡åˆ°6.3.0å°±æ²¡æŠ¥é”™äº† è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š é¦–å…ˆå°†ä½ nodejså®‰è£…ç›®å½•ä¸‹çš„ node_modules/npmæ–‡ä»¶å¤¹ å¤åˆ¶åˆ°ä»»æ„è·¯å¾„ä¸‹ å†å°†nodejså®‰è£…ç›®å½•ä¸‹çš„npm.binã€npm.cmdåˆ äº† æœ€åè¿›å…¥ç¬¬ä¸€æ­¥å¤åˆ¶çš„xxx/npm/binç›®å½•ä¸‹ï¼Œæ‰§è¡Œnode npm-cli.js i -g npm@latest å‘½ä»¤ï¼Œæ¬§äº†ï¼ æˆ‘æ˜¯çœŸæ»´ä½©æœæƒ³å‡ºè¿™ä¸ªåŠæ³•çš„ä»å…„ï¼Œé«˜ï¼Œå¤ªé«˜äº†","categories":[{"name":"é—®é¢˜æ€»ç»“ç¯‡","slug":"é—®é¢˜æ€»ç»“ç¯‡","permalink":"https://cloudintheking.github.io/categories/é—®é¢˜æ€»ç»“ç¯‡/"}],"tags":[{"name":"nodejs","slug":"nodejs","permalink":"https://cloudintheking.github.io/tags/nodejs/"}]},{"title":"windowsä¸‹å®‰è£…nvmåŠnrm","slug":"windowsä¸‹å®‰è£…nvmåŠnrm","date":"2018-07-12T01:14:12.000Z","updated":"2021-04-26T13:07:09.948Z","comments":true,"path":"posts/c4e70f88.html","link":"","permalink":"https://cloudintheking.github.io/posts/c4e70f88.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ nvmnvmæ˜¯ä»€ä¹ˆä»¥åŠåº”ç”¨åœºæ™¯åŸºäºnodeçš„é¡¹ç›®å¯¹nodeç‰ˆæœ¬ä¾èµ–æ˜¯ä¸åŒçš„ï¼Œè€Œç”µè„‘ä¸Šåªå®‰è£…äº†ä¸€ä¸ªnodeçš„ç‰ˆæœ¬ï¼Œé‚£æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„ã€‚æ‰€ä»¥nvmï¼ˆNode Version Managerï¼‰ï¼Œä¸€ä¸ªnodeç‰ˆæœ¬ç®¡ç†å·¥å…·å°±è¯ç”Ÿäº†ã€‚å®ƒå°±å°±åƒæ˜¯ä¸€ä¸ªå¼€å…³ï¼Œåˆ‡æ¢ç³»ç»Ÿé‡Œä¸åŒçš„nodeç‰ˆæœ¬ï¼Œåˆ‡è®°åŒä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªnodeç‰ˆæœ¬ç”Ÿæ•ˆï¼Œnode8å’Œnode10ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚ å®‰è£…å¦‚æœä½ å·²ç»è£…äº†nodeäº†ï¼Œå»ºè®®å®Œå…¨å¸è½½äº†ï¼ˆè¿åŒnpmï¼Œè¿˜æœ‰ç¯å¢ƒå˜é‡ï¼‰,å¦‚æœä¸å¸è½½çš„è¯å¯èƒ½ä¼šå’Œnvmå‘ç”Ÿå†²çª ä¸‹è½½åœ°å€ å®ƒæœ‰ä¸¤ä¸ªç‰ˆæœ¬ nvm-noinstall.zip(å…å®‰è£…) ã€nvm-setup.zip(å›¾å½¢ç•Œé¢å®‰è£…GUI)ï¼Œå®ƒä»¬ä¸¤ä¸ªåŒºåˆ«åªåœ¨äºå…å®‰è£…éœ€è¦è‡ªå·±æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡è€ŒGUIç‰ˆç»™ä½ è‡ªåŠ¨é…å¥½äº†ï¼Œä¸‹é¢åŸºäºGUIç‰ˆç®€å•è¯´æ˜ä¸€ä¸‹ï¼š å½“ä½ å®‰è£…åˆ°è¿™ä¸€æ­¥æ—¶ï¼Œé€‰æ‹©nvmçš„å®‰è£…ç›®å½•ï¼Œæˆ‘è¿™é‡Œæ˜¯ï¼šD:\\Environment\\nvm è¿™ä¸€æ­¥æ˜¯è®¾ç½®åˆ›å»ºä¸€ä¸ªé“¾æ¥ç›®å½•æŒ‡å‘çœŸæ­£çš„nodeçš„å®‰è£…ç›®å½•ï¼Œæˆ‘è¿™é‡Œæ˜¯ï¼šD:\\Environment\\nodejs ä¸€ç›´nextç›´åˆ°å®‰è£…å®Œæˆï¼ŒæœŸé—´çš„æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½ä¼šè‡ªåŠ¨åŠ å…¥ç³»ç»Ÿè·¯å¾„ä¸­ï¼ˆæ–¹ä¾¿ï¼ï¼‰ é…ç½®settings.txt å¦‚æœä½ æ˜¯å…å®‰è£…ï¼Œæœ‰ä¸¤ç§æ–¹æ³• æˆ‘ä»¬æ‰“å¼€å…å®‰è£…ç›®å½•ä¸‹çš„install.cmdæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415@echo offset /P NVM_PATH=&quot;Enter the absolute path where the zip file is extracted/copied to: &quot; #è¾“å…¥nvmå®‰è£…ç›®å½•è·¯å¾„setx /M NVM_HOME &quot;%NVM_PATH%&quot; #å°†ä½ è¾“å…¥çš„è·¯å¾„èµ‹ç»™NVM_HOMEç¯å¢ƒå˜é‡setx /M NVM_SYMLINK &quot;C:\\Program Files\\nodejs&quot; #é»˜è®¤è·¯å¾„èµ‹ç»™NVM_SYMLINKå˜é‡ï¼Œå¯ä»¥å°†é»˜è®¤è·¯å¾„ä¿®æ”¹æˆä»»æ„è·¯å¾„setx /M PATH &quot;%PATH%;%NVM_HOME%;%NVM_SYMLINK%&quot; #å°†NVM_HOMEã€NVM_SYMLINKå°†å…¥PATHä¸­if exist &quot;%SYSTEMDRIVE%\\Program Files (x86)\\&quot; (set SYS_ARCH=64) else (set SYS_ARCH=32)(echo root: %NVM_HOME% &amp;&amp; echo path: %NVM_SYMLINK% &amp;&amp; echo arch: %SYS_ARCH% &amp;&amp; echo proxy: none) &gt; %NVM_HOME%\\settings.txt #åœ¨nvmç›®å½•ä¸‹ç”Ÿæˆsettings.txtnotepad %NVM_HOME%\\settings.txt@echo on ç®€å•ç‚¹è¯´ï¼Œinstall.cmdçš„ä½œç”¨å°±æ˜¯å¸®ä½ è‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡å¹¶ç”Ÿæˆsettings.txtã€‚ å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸ç”¨install.cmdï¼Œè‡ªå·±æ‰‹åŠ¨åˆ›å»ºsettings.txtï¼Œæ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡ï¼Œæ¯•ç«Ÿè‡ªå·±åŠ¨æ‰‹ï¼Œä¸°è¡£è¶³é£Ÿ å¦‚æœä½ æ˜¯GUIå®‰è£…ï¼Œç›´æ¥æ‰“å¼€nvmå®‰è£…ç›®å½•ä¸‹çš„settings.txt ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š 123456root: D:\\Environment\\nvm //æ”¹æˆä½ çš„nvmå®‰è£…ç›®å½•path: D:\\Environment\\nodejs //æ”¹æˆä½ çš„nvmå®‰è£…ç›®å½•arch: 64 //ä½ çš„ç³»ç»ŸæŒ‡ä»¤æ¶æ„64ä½ï¼Œé»˜è®¤çš„ä¸å¿…ä¿®æ”¹proxy: none //ä»£ç†é…ç½®ï¼Œæ— node_mirror: http://npm.taobao.org/mirrors/node/ //nodeé•œåƒæºnpm_mirror: https://npm.taobao.org/mirrors/npm/ //npmé•œåƒæº é…ç½®ç¯å¢ƒå˜é‡ å¦‚æœä½ æ˜¯é€šè¿‡GUIå®‰è£…çš„ï¼Œé‚£ä¹ˆä½ çš„ç¯å¢ƒå˜é‡å·²ç»è‡ªåŠ¨é…å¥½äº†ï¼Œä½ å¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ï¼Œä¹Ÿå¯ä»¥è·Ÿç€çœ‹ä¸‹å»ï¼Œçœ‹çœ‹è‡ªåŠ¨é…ç½®æ˜¯å¦æœ‰è¯¯ å¦‚æœä½ æ˜¯å…å®‰è£…åˆä¸æƒ³ç”¨install.cmdçš„è¯ï¼Œå»ºè®®åœ¨ä¸ªäººç¯å¢ƒå˜é‡ä¸­åŠ å…¥ä¸‹é¢çš„å‚æ•°ï¼Œå› ä¸ºè¿™æ ·ä¸ä¼šæ‰°ä¹±ç³»åˆ°ç»Ÿç¯å¢ƒå˜é‡ ï¼Œå¿«æ·æ‰“å¼€ç¯å¢ƒå˜é‡ç•Œé¢ï¼šwindows+r =&gt; sysdm.cpl 12NVM_HOMEï¼š D:\\Environment\\nvm //æ”¹æˆä½ çš„nvmå®‰è£…ç›®å½•NVM_SYMLINK ï¼š D:\\Environment\\nodejs //æ”¹æˆä½ çš„nodejsé“¾æ¥ç›®å½• æœ€ååˆ«å¿˜äº†ï¼Œåœ¨PATHé‡ŒåŠ ä¸Š ;%NVM_HOME%;%NVM_SYMLINK%; ä½¿ç”¨æ‰“å¼€æ§åˆ¶å°ï¼Œè¾“å…¥ï¼šnvm version,è‹¥æ˜¯å‡ºç°ç‰ˆæœ¬ä¿¡æ¯ï¼Œåˆ™å®‰è£…æˆåŠŸã€‚è‹¥æŠ¥é”™ï¼Œé‚£å°±é¢å£æ€è¿‡ï¼Œæˆ‘è®²çš„è¾£ä¹ˆè¯¦ç»†ã€‚ è¿™é‡Œä»‹ç»ä¸€äº›å¸¸ç”¨å‘½ä»¤ï¼Œå‰©ä¸‹è‡ªå·±æ¢ç´¢å§ 1234nvm install &lt;version&gt; [arch] ï¼šversionæ˜¯ç‰ˆæœ¬å·ã€archæ˜¯ç³»ç»Ÿä½æ•°ï¼Œé»˜è®¤64ä½ï¼Œæ¯”å¦‚ï¼šnvm install 8.10.0 å®‰è£…64ä½çš„nodejs8.10.0nvm uninstall &lt;version&gt; ï¼šåˆ é™¤å¯¹åº”nodeç‰ˆæœ¬nvm list ï¼šä¼šæ˜¾ç¤ºä½ ç³»ç»Ÿä¸­å®‰è£…çš„æ‰€æœ‰nodeç‰ˆæœ¬ï¼Œå¹¶æ ‡æ˜å½“å‰åº”ç”¨çš„é‚£ä¸ªnodeç‰ˆæœ¬nvm use [version] [arch] ï¼šé€‰æ‹©ç”Ÿæ•ˆå“ªä¸ªnodeç‰ˆæœ¬ nrmnrmæ˜¯ä»€ä¹ˆåŠåº”ç”¨åœºæ™¯nrmï¼ˆnpm registry manager ï¼‰ï¼Œnpm é•œåƒæºç®¡ç†å·¥å…·ã€‚æœ‰æ—¶å€™è®¿é—®å›½å¤–èµ„æºå¤ªæ…¢äº†ï¼Œæˆ‘ä»¬å°±å¾—æ›´æ¢npmçš„æºï¼Œå‘½ä»¤æ˜¯npm config set registry xxxxxxxx,è€ƒè™‘åˆ°æœ‰çš„å…¬å¸è¿˜æœ‰ç§æœ‰æºï¼Œå¦‚æœæ¯æ¬¡æ›´æ”¹æºéƒ½è¦æ•²é‚£ä¹ˆé•¿çš„å‘½ä»¤ï¼Œé‚£æ•ˆç‡å¤ªä½äº†ã€‚but nrmæ›¿æˆ‘ä»¬ç®¡ç†äº†è¿™äº›æºï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•çš„åˆ‡æ¢ä¸€ä¸‹ï¼ å®‰è£…åŠä½¿ç”¨123456789101112131415npm install -g nrm ç›´æ¥ä½¿ç”¨npmå…¨å±€å®‰è£…å³å¯nrm --helpUsage: nrm [options] [command]Commands:ls åˆ—å‡ºæ‰€æœ‰çš„æºcurrent æ˜¾ç¤ºå½“å‰æºçš„åç§°use &lt;registry&gt; åˆ‡æ¢æºadd &lt;registry&gt; &lt;url&gt; [home] æ·»åŠ æºdel|rm &lt;registry&gt; åˆ é™¤åŸhome &lt;registry&gt; [browser] æ‰“å¼€æºçš„å®˜æ–¹ä¸»é¡µtest [registry] æµ‹è¯•ä¸‹è¿™äº›æºçš„å“åº”æ—¶é—´help print this helpOptions:-h, --help output usage information-V, --version output the version number","categories":[{"name":"ç¯å¢ƒå®‰è£…ç¯‡","slug":"ç¯å¢ƒå®‰è£…ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¯å¢ƒå®‰è£…ç¯‡/"}],"tags":[{"name":"nodejs","slug":"nodejs","permalink":"https://cloudintheking.github.io/tags/nodejs/"}]},{"title":"springbootå¤šæ•°æ®æºé…ç½®","slug":"springbootå¤šæ•°æ®æºé…ç½®","date":"2018-07-06T06:28:48.000Z","updated":"2021-04-26T13:07:09.988Z","comments":true,"path":"posts/84d9992c.html","link":"","permalink":"https://cloudintheking.github.io/posts/84d9992c.html","excerpt":"","text":"ä¸ªäººç¬”è®°ï¼Œå¦‚æœ‰æè¿°ä¸å½“ï¼Œæ¬¢è¿ç•™è¨€æŒ‡å‡º~ é¡¹ç›®ç»“æ„å›¾ ç›¸å…³é…ç½®pom.xml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.mymultidata&lt;/groupId&gt; &lt;artifactId&gt;ahuang&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;ahuang&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;1.5.12.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt; &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.3.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;/project&gt; application.properties12345678910111213141516171819202122232425#ä¸»æ•°æ®æºspring.datasource.primary.url=jdbc:mysql://localhost:3306/test1?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC&amp;useSSL=truespring.datasource.primary.username=rootspring.datasource.primary.password=xxxxxxspring.datasource.primary.driver-class-name=com.mysql.jdbc.Driverspring.datasource.max-active=10spring.datasource.primary.max-idle=5spring.datasource.primary.min-idle=0#æ¬¡æ•°æ®æºspring.datasource.secondary.url=jdbc:mysql://localhost:3306/test2?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC&amp;useSSL=truespring.datasource.secondary.username=rootspring.datasource.secondary.password=xxxxxxspring.datasource.secondary.driver-class-name=com.mysql.jdbc.Driverspring.datasource.secondary.max-active=10spring.datasource.secondary.max-idle=5spring.datasource.secondary.min-idle=0#tomcatserver.port=8082#hibernateé…ç½®spring.jpa.properties.hibernate.hbm2ddl.auto=updatespring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialectspring.jpa.show-sql= true#mybatisé…ç½®mybatis.config-locations=classpath:mybatis/config.xmlmybatis.mapper-locations=classpath:mybatis/mapper/*/*/*.xml spring.datasource.primary.xxxã€spring.datasource.secondary.xxxå¹¶éspringbootçš„é»˜è®¤å‚æ•°ï¼Œè¿™äº›é…ç½®å¹¶ä¸èƒ½ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¦è‡ªå·±å®šä¹‰ä¸‹æ•°æ®æºé…ç½®ç±»ã€‚è¿˜è®°å¾—configç›®å½•ä¸‹DataSourceConfig.javaè¿™ä¸ªç±»å—ï¼Ÿè¿™ä¸ªç±»å°±æ˜¯ç”¨æ¥é…ç½®å¤šä¸ªæ•°æ®æºçš„ã€‚ æ•°æ®æºé…ç½®DataSourceConfig.java123456789101112131415161718192021222324252627282930package com.mymultidata.ahuang.config;import org.springframework.beans.factory.annotation.Qualifier;import org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder;import org.springframework.boot.context.properties.ConfigurationProperties;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import javax.sql.DataSource;/** * @Author: hl * @Description: TODO * @Date: 13:55 2018/4/24 * @Modified By: * @Version 1.0 */@Configurationpublic class DataSourceConfig &#123; @Bean(\"primaryDataSource\") @Qualifier(\"primaryDataSource\") @ConfigurationProperties(prefix = \"spring.datasource.primary\") public DataSource primaryDataSource()&#123; return DataSourceBuilder.create().build(); &#125; @Bean(\"secondaryDataSource\") @Qualifier(\"secondaryDataSource\") @ConfigurationProperties(prefix = \"spring.datasource.secondary\") public DataSource secondaryDataSource()&#123; return DataSourceBuilder.create().build(); &#125;&#125; @ConfigurationProperties(prefix = &quot;spring.datasource.primary&quot;)ï¼šæ‰¾åˆ°application.propertiesé‡Œå‰ç¼€ä¸ºspring.datasource.primaryçš„å‚æ•°å¹¶è‡ªåŠ¨æ³¨å…¥å€¼åˆ°DataSourceä¸­ã€‚æˆ‘è¿™é‡Œæ˜¯å‡†å¤‡å°†primaryæ•°æ®æºé›†æˆjpaï¼Œsecondaryæ•°æ®æºé›†æˆmybaitis,è¿™é‡Œåªé…äº†ä¸¤ä¸ªæ•°æ®æºï¼ŒåŒå­¦ä»¬å¯ä»¥ä¸¾ä¸€åä¸‰ï¼Œthird,fourthâ€¦ æ•°æ®æºäº‹åŠ¡é…ç½®åŸºäºjpaPrimaryConfig.java12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667 package com.mymultidata.ahuang.config;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Qualifier;import org.springframework.boot.autoconfigure.orm.jpa.JpaProperties;import org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.Primary;import org.springframework.data.jpa.repository.config.EnableJpaRepositories;import org.springframework.orm.jpa.JpaTransactionManager;import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;import org.springframework.transaction.PlatformTransactionManager;import org.springframework.transaction.annotation.EnableTransactionManagement;import javax.persistence.EntityManager;import javax.sql.DataSource;import java.util.Map;/** * @Author: hl * @Description: TODO * @Date: 14:23 2018/4/24 * @Modified By: * @Version 1.0 */@Configuration@EnableTransactionManagement//entityManagerFactoryRef:å¼•ç”¨å®ä½“ç®¡ç†å·¥å‚// transactionManagerRef:å¼•ç”¨äº‹åŠ¡ç®¡ç†å·¥å‚// basePackages:è®¾ç½®jpaçš„repositoryæ¥å£ç±»çš„åŒ…è·¯å¾„,å¯é…ç½®å¤šä¸ª@EnableJpaRepositories( entityManagerFactoryRef = \"entityManagerFactoryPrimary\", transactionManagerRef = \"transactionManagerPrimary\", basePackages = &#123;\"com.mymultidata.ahuang.repository.jpa.jpa1\"&#125;)public class PrimaryConfig &#123; @Autowired @Qualifier(\"primaryDataSource\") private DataSource primaryDataSource;//æ³¨å…¥primaryæ•°æ®æº @Autowired(required = false) private JpaProperties jpaProperties;//æ³¨å…¥jpaå…¨å±€å‚æ•° @Primary @Bean(name = \"entityManagerPrimary\") public EntityManager entityManager(EntityManagerFactoryBuilder builder)&#123; return entityManagerFactoryPrimary(builder).getObject().createEntityManager(); &#125; @Primary @Bean(name = \"entityManagerFactoryPrimary\") public LocalContainerEntityManagerFactoryBean entityManagerFactoryPrimary (EntityManagerFactoryBuilder builder) &#123; return builder .dataSource(primaryDataSource) .properties(getVendorProperties(primaryDataSource)) .packages(\"com.mymultidata.ahuang.domain.jpa.jpa1\") //è®¾ç½®å®ä½“ç±»æ‰€åœ¨ä½ç½® .persistenceUnit(\"primaryPersistenceUnit\") .build(); &#125; private Map&lt;String, String&gt; getVendorProperties(DataSource dataSource) &#123; return jpaProperties.getHibernateProperties(dataSource); &#125; @Primary @Bean(name = \"transactionManagerPrimary\") public PlatformTransactionManager transactionManagerPrimary(EntityManagerFactoryBuilder builder) &#123; return new JpaTransactionManager(entityManagerFactoryPrimary(builder).getObject()); &#125;&#125; åŸºäºmybatisSecondaryConfig.java:1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.mymultidata.ahuang.config;import org.apache.ibatis.session.SqlSessionFactory;import org.mybatis.spring.SqlSessionFactoryBean;import org.mybatis.spring.SqlSessionTemplate;import org.mybatis.spring.annotation.MapperScan;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Qualifier;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.core.io.support.PathMatchingResourcePatternResolver;import org.springframework.jdbc.datasource.DataSourceTransactionManager;import javax.sql.DataSource;/** * @Author: hl * @Description: TODO * @Date: 15:05 2018/4/24 * @Modified By: * @Version 1.0 */@Configuration//basePackages:è®¾ç½®mapperjæ¥å£ç±»æ‰€åœ¨ä½ç½®@MapperScan(basePackages = &#123;\"com.mymultidata.ahuang.repository.mybatis.mapper1\"&#125;,sqlSessionTemplateRef =\"secondarySqlSessionTemplate\" )public class secondaryConfig &#123; @Autowired @Qualifier(\"secondaryDataSource\") private DataSource dataSource; @Bean(name = \"secondarySqlSessionFactory\") public SqlSessionFactory testSqlSessionFactory() throws Exception &#123; SqlSessionFactoryBean bean = new SqlSessionFactoryBean(); bean.setDataSource(dataSource); bean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(\"classpath:mybatis/mapper/mapper1/*/*.xml\"));//è®¾ç½®mapper.xmlè·¯å¾„,è·¯å¾„ä¸­ä¹‹æ‰€ä»¥åŠ äº†'*'å·ï¼Œæ˜¯ä¸ºäº†é¡¹ç›®çš„åŠŸèƒ½åˆ’åˆ†,æ–¹ä¾¿åˆ†æ,å¦‚æœä½ çš„æ˜ å°„æ–‡ä»¶ä¸åšåŠŸèƒ½åˆ’åˆ†çš„è¯ï¼Œå¯ä»¥æ”¹ä¸º\"classpath:mybatis/mapper/mapper1/*.xml\" return bean.getObject(); &#125; @Bean(name = \"secondaryTransactionManager\") public DataSourceTransactionManager testTransactionManager(@Qualifier(\"secondaryDataSource\") DataSource dataSource) &#123; return new DataSourceTransactionManager(dataSource); &#125; @Bean(name = \"secondarySqlSessionTemplate\") public SqlSessionTemplate testSqlSessionTemplate(@Qualifier(\"secondarySqlSessionFactory\") SqlSessionFactory sqlSessionFactory) throws Exception &#123; return new SqlSessionTemplate(sqlSessionFactory); &#125;&#125; åˆ°è¿™é‡Œé…ç½®å·²ç»å¥½äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç»“åˆä¸šåŠ¡å»å®ç°äº†ã€‚","categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"}],"tags":[{"name":"springboot","slug":"springboot","permalink":"https://cloudintheking.github.io/tags/springboot/"}]},{"title":"Hello World","slug":"hello-world","date":"2018-07-04T13:53:56.000Z","updated":"2021-04-26T13:07:09.988Z","comments":true,"path":"posts/4a17b156.html","link":"","permalink":"https://cloudintheking.github.io/posts/4a17b156.html","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new \"My New Post\" More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://cloudintheking.github.io/tags/hexo/"}]}],"categories":[{"name":"åç«¯ç¬”è®°","slug":"åç«¯ç¬”è®°","permalink":"https://cloudintheking.github.io/categories/åç«¯ç¬”è®°/"},{"name":"é—®é¢˜æ€»ç»“ç¯‡","slug":"é—®é¢˜æ€»ç»“ç¯‡","permalink":"https://cloudintheking.github.io/categories/é—®é¢˜æ€»ç»“ç¯‡/"},{"name":"ç¯å¢ƒå®‰è£…ç¯‡","slug":"ç¯å¢ƒå®‰è£…ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¯å¢ƒå®‰è£…ç¯‡/"},{"name":"ç®—æ³•ç¯‡","slug":"ç®—æ³•ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç®—æ³•ç¯‡/"},{"name":"ç¿»è¯‘ç¯‡","slug":"ç¿»è¯‘ç¯‡","permalink":"https://cloudintheking.github.io/categories/ç¿»è¯‘ç¯‡/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://cloudintheking.github.io/categories/æ•°æ®åº“/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://cloudintheking.github.io/tags/spring/"},{"name":"rabbitmq","slug":"rabbitmq","permalink":"https://cloudintheking.github.io/tags/rabbitmq/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://cloudintheking.github.io/tags/å¾®æœåŠ¡/"},{"name":"c++","slug":"c","permalink":"https://cloudintheking.github.io/tags/c/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"https://cloudintheking.github.io/tags/æ•°æ®ç»“æ„/"},{"name":"mongodb","slug":"mongodb","permalink":"https://cloudintheking.github.io/tags/mongodb/"},{"name":"sql","slug":"sql","permalink":"https://cloudintheking.github.io/tags/sql/"},{"name":"æ¸…å•","slug":"æ¸…å•","permalink":"https://cloudintheking.github.io/tags/æ¸…å•/"},{"name":"flex-layout","slug":"flex-layout","permalink":"https://cloudintheking.github.io/tags/flex-layout/"},{"name":"nginx","slug":"nginx","permalink":"https://cloudintheking.github.io/tags/nginx/"},{"name":"powershell","slug":"powershell","permalink":"https://cloudintheking.github.io/tags/powershell/"},{"name":"python","slug":"python","permalink":"https://cloudintheking.github.io/tags/python/"},{"name":"nodejs","slug":"nodejs","permalink":"https://cloudintheking.github.io/tags/nodejs/"},{"name":"springboot","slug":"springboot","permalink":"https://cloudintheking.github.io/tags/springboot/"},{"name":"hexo","slug":"hexo","permalink":"https://cloudintheking.github.io/tags/hexo/"}]}